<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP | Central de Estudos - Starter 1</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <style>
        :root { --primary: #8671d1; --secondary: #F1D24B; }
        body { font-family: 'DM Sans', sans-serif; background-color: #f4f7f9; min-height: 100vh; margin: 0; scroll-behavior: smooth; }
        #main-wrapper { width: 100%; margin: 0 auto; padding: 0; position: relative; }
        #dashboard-view, #generator-view, #study-view { padding: 0 1.5rem; max-width: 1200px; margin: 0 auto; }
        .bg-primary\/10 { background-color: rgba(134, 113, 209, 0.1); }
        .text-primary { color: #8671d1; }

        /* UI BUTTONS */
        .action-button { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; white-space: nowrap; }
        .action-button-sm { background-color: #F1D24B; color: #44403c; padding: 0.35rem 0.5rem; border-radius: 0.375rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem; white-space: nowrap; }
        .action-button-sm:hover:not(:disabled) { background-color: #eab308; transform: translateY(-2px); }
        .action-button-sm:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .action-button:hover:not(:disabled) { background-color: #eab308; transform: translateY(-2px); }
        .action-button:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; }

        .secondary-button { background-color: #44403c; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; }
        .secondary-button-sm { background-color: #44403c; color: white; padding: 0.4rem 0.6rem; border-radius: 0.25rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.65rem; }
        .secondary-button-sm:hover { background-color: #292524; transform: translateY(-1px); }
        .back-button { background-color: #44403c; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .back-button:hover { background-color: #292524; transform: translateY(-1px); }
        .secondary-button:hover { background-color: #292524; transform: translateY(-1px); }

        /* CARDS */
        .level-card { background-color: white; padding: 1.75rem; border-radius: 1.25rem; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 100%; position: relative; min-height: 180px; }
        .level-card:not(.locked):hover { transform: scale(1.02); border-color: #8671d1; }
        .level-card.locked { opacity: 0.6; background-color: #f9fafb; pointer-events: none; }
        
        /* STUDY VIEW CONTAINER */
        .study-container { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 2rem; }

        .module-tag { display: inline-block; padding: 0.25rem 0.5rem; background-color: #8671d1; color: white; font-size: 0.75rem; font-weight: 700; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        .lock-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(68,64,60,0.9); padding: 1rem; border-radius: 50%; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* LISTENING */
        .listening-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 0.5rem; margin-top: 0.25rem; }
        .listening-grid-wide { display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 0.5rem; margin-top: 0.25rem; }
        .number-btn { background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 55px; }
        .number-btn:hover { border-color: #8671d1; transform: translateY(-2px); }
        .number-btn span.main-text { font-size: 1.1rem; font-weight: 800; }
        .number-btn span.sub-text { font-size: 0.6rem; font-weight: 600; color: #8671d1; text-transform: uppercase; }
        .number-btn span.phonetic-text { font-size: 0.75rem; font-weight: 500; color: #78716c; font-style: italic; }
        .number-btn.playing { border-color: #F1D24B; background-color: #fffbeb; animation: pulse 1s infinite; }

        /* FLASHCARDS */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 400px; height: 300px; margin: 0.5rem auto; cursor: pointer; }
        .flashcard { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 1.5rem; padding: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .flashcard-front { background-color: #8671d1; color: white; }
        .flashcard-back { background-color: #F1D24B; color: #44403c; transform: rotateY(180deg); }

        /* CHUNKS */
        .chunks-grid { display: grid; grid-template-columns: 1fr 1fr; border: 2px solid #e2e8f0; border-radius: 1rem; overflow: hidden; background: white; text-align: left; }
        .chunks-header { background: #44403c; color: white; padding: 1rem; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .chunks-cell { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; font-weight: 500; font-size: 0.9rem; word-break: break-word; }
        .chunks-cell-en { color: #1e1b4b; background-color: #f8fafc; }
        .chunks-cell-pt { color: #64748b; justify-content: space-between; }
        .chunk-input { flex: 1; padding: 0.4rem 0.6rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.85rem; outline: none; transition: 0.2s; min-width: 0; }
        .chunk-check-btn { flex-shrink: 0; padding: 0.4rem 0.6rem; margin-left: 0.5rem; border-radius: 0.5rem; background: #8671d1; color: white; font-size: 0.75rem; font-weight: 700; border: none; cursor: pointer; transition: 0.2s; }
        .chunk-check-btn:hover { background: #7161b8; }
        .chunk-input:focus { border-color: #8671d1; }
        .chunk-input.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .chunk-input.wrong { border-color: #ef4444; background: #fef2f2; }
        .translation-hidden { filter: blur(5px); opacity: 0.3; transition: 0.3s; user-select: none; } 
        .translation-visible { filter: blur(0); opacity: 1; user-select: text; }
        @media (max-width: 640px) {
            .chunks-grid { grid-template-columns: 1fr; }
            .chunks-header:last-of-type { display: none; }
            .chunks-header:first-of-type::after { content: " / Traduções"; }
            .chunks-cell { padding: 0.875rem; font-size: 0.95rem; }
            .chunks-cell-en { border-bottom: none; border-right: none; padding-bottom: 0.5rem; }
            .chunks-cell-pt { border-bottom: 2px solid #e2e8f0; padding-top: 0.5rem; }
        }

        /* WORD SEARCH */
        .wordsearch-grid { display: inline-grid; gap: 1px; background: #44403c; padding: 2px; border-radius: 0.5rem; user-select: none; }
        .wordsearch-cell { width: 32px; height: 32px; background: white; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.15s; text-transform: uppercase; }
        .wordsearch-cell:hover { background: #f0e6ff; }
        .wordsearch-cell.selected { background: #8671d1; color: white; }
        .wordsearch-cell.found { background: #F1D24B; color: #44403c; }
        .wordsearch-words { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; max-width: 320px; margin-top: 1rem; }
        .wordsearch-word { padding: 0.25rem 0.75rem; background: #f5f5f4; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; color: #44403c; border: 2px solid #e2e8f0; }
        .wordsearch-word.found { background: #F1D24B; border-color: #F1D24B; text-decoration: line-through; }
        @media (max-width: 640px) {
            .wordsearch-cell { width: 28px; height: 28px; font-size: 14px; }
        }

        /* SCRAMBLE */
        .scramble-dropzone {
            min-height: 80px; 
            border: 2px dashed #cbd5e1; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            justify-content: center; 
            gap: 0.75rem; 
            background-color: #f8fafc; 
            margin-bottom: 2rem; 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #8671d1;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .scramble-word {
            background: white; 
            border: 2px solid #e2e8f0; 
            padding: 0.75rem 1.25rem; 
            border-radius: 0.75rem; 
            cursor: pointer; 
            font-weight: 600; 
            color: #44403c; 
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .scramble-word:hover { border-color: #8671d1; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .scramble-word-selected {
            background: #8671d1; 
            color: white;
            border: 2px solid #8671d1; 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s;
            margin: 0.125rem;
        }
        .scramble-word-selected:hover { background: #7161b1; border-color: #7161b1; }

        /* MISTAKE */
        .mistake-word { display: inline-block; padding: 0.2rem 0.4rem; border-radius: 0.4rem; cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .mistake-word:hover { background-color: #fee2e2; border-bottom-color: #ef4444; }
        .mistake-word.correct-choice { background: #dcfce7; border-color: #22c55e; }
        .mistake-word.wrong-choice { background: #fee2e2; border-color: #ef4444; text-decoration: line-through; }

        /* DICTATION */
        .dictation-input { font-size: 1.25rem; text-align: center; border: 3px solid #e2e8f0; border-radius: 1rem; width: 220px; padding: 0.5rem; outline: none; transition: 0.2s; }
        .dictation-input:focus { border-color: #8671d1; }
        .dictation-input.correct { border-color: #22c55e; background: #dcfce7; }
        .dictation-input.wrong { border-color: #ef4444; background: #fee2e2; }

        /* GENERAL UI */

        .streak-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 1rem; }
        .streak-bar-wrapper { width: 100%; max-width: 300px; margin: 0 auto; }
        .streak-bar-bg { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .streak-bar-fill { height: 100%; background: linear-gradient(90deg, #F1D24B, #f59e0b); border-radius: 6px; transition: width 0.4s ease; }
        .streak-label { font-size: 0.75rem; font-weight: 700; color: #78716c; margin-bottom: 0.25rem; }

        /* QUIZ UI */
        .option-button { background-color: white; border: 2px solid #e2e8f0; color: #44403c; text-align: left; padding: 1rem; border-radius: 0.75rem; width: 100%; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 1rem; }
        .option-button:hover:not(:disabled) { border-color: #F1D24B; background-color: #fffbeb; }
        .option-prefix { width: 2.2rem; height: 2.2rem; background: #fef9c3; color: #a16207; font-weight: 800; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid #fde047; }

        .help-btn { position: absolute; top: 1rem; right: 1.5rem; width: 2.5rem; height: 2.5rem; border-radius: 50%; background: white; border: 2px solid #e2e8f0; color: #8671d1; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 1.5rem; padding: 1.8rem; max-width: 400px; width: 90%; transform: scale(0.9); transition: 0.3s; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-overlay.active .modal-content { transform: scale(1); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* LOGIN SCREEN */
        #login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f4f7f9 0%, #e8e0f3 100%); }
        .login-card { background: white; border-radius: 1.5rem; padding: 2.5rem; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(134,113,209,0.15); }
        .login-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 1rem; font-family: 'DM Sans', sans-serif; outline: none; transition: 0.2s; box-sizing: border-box; }
        .login-input:focus { border-color: #8671d1; }
        .login-error { color: #ef4444; font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; display: none; }
        .login-tabs { display: flex; border-radius: 0.75rem; overflow: hidden; border: 2px solid #e2e8f0; margin-bottom: 1.5rem; }
        .login-tab { flex: 1; padding: 0.65rem; text-align: center; font-weight: 700; font-size: 0.875rem; cursor: pointer; transition: 0.2s; background: white; color: #78716c; }
        .login-tab.active { background: #8671d1; color: white; }
        .user-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: white; border: 1px solid #e2e8f0; padding: 0.35rem 0.75rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 600; color: #44403c; }
        .logout-btn { background: none; border: none; color: #ef4444; font-weight: 700; font-size: 0.7rem; cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
        .logout-btn:hover { background: #fef2f2; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <div class="text-center mb-6">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" class="w-28 h-auto mx-auto mb-4">
                <h2 class="text-xl font-bold text-stone-800">Central de Estudos</h2>
                <p class="text-stone-500 text-sm mt-1">Faça login para acessar seus estudos</p>
            </div>

            <div class="login-tabs" data-testid="login-tabs">
                <div class="login-tab active" data-testid="tab-login" onclick="switchLoginTab('login')">ENTRAR</div>
                <div class="login-tab" data-testid="tab-register" onclick="switchLoginTab('register')">CADASTRAR</div>
            </div>

            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Email</label>
                    <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" required data-testid="input-login-email">
                </div>
                <div class="mb-1">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Senha</label>
                    <input type="password" id="login-password" class="login-input" placeholder="Sua senha" required minlength="6" data-testid="input-login-password">
                </div>
                <p id="login-error" class="login-error" data-testid="text-login-error"></p>
                <button type="submit" id="login-submit-btn" class="action-button w-full mt-4" data-testid="button-login-submit">ENTRAR</button>
            </form>

            <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                <div class="mb-3">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Nome completo</label>
                    <input type="text" id="register-name" class="login-input" placeholder="Seu nome" required data-testid="input-register-name">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Email</label>
                    <input type="email" id="register-email" class="login-input" placeholder="seu@email.com" required data-testid="input-register-email">
                </div>
                <div class="mb-1">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Senha</label>
                    <input type="password" id="register-password" class="login-input" placeholder="Mínimo 6 caracteres" required minlength="6" data-testid="input-register-password">
                </div>
                <p id="register-error" class="login-error" data-testid="text-register-error"></p>
                <button type="submit" id="register-submit-btn" class="action-button w-full mt-4" data-testid="button-register-submit">CRIAR CONTA</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="main-wrapper" class="hidden">
        <header class="py-8 mb-10 text-center relative" style="background: #F1D24B;">
            <div class="absolute top-3 left-3 z-50">
                <div id="user-info-badge" class="user-badge" data-testid="text-user-info">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span id="user-display-name" data-testid="text-username"></span>
                    <button class="logout-btn" onclick="handleLogout()" data-testid="button-logout">SAIR</button>
                </div>
            </div>
            <button class="help-btn" style="background: white; color: #44403c;" onclick="document.getElementById('rules-modal').classList.add('active')">?</button>

            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" class="w-32 h-auto mx-auto mb-6">
            <h1 class="text-3xl font-bold text-stone-800 tracking-tight mb-3">Central de Estudos - Starter 1</h1>
            <p class="text-stone-700 font-medium px-4 leading-relaxed max-w-2xl mx-auto mb-4">Material didático exclusivo focado em reforçar a acurácia estrutural e a confiança na comunicação.</p>
            <div class="flex items-center justify-center gap-3">
                <span class="text-xs font-bold text-stone-600 uppercase tracking-wide">Siga o SLAP nas redes</span>
                <div class="flex gap-2">
                    <a href="#" target="_blank" class="w-8 h-8 rounded-full bg-white/80 hover:bg-white flex items-center justify-center transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#44403c"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="#" target="_blank" class="w-8 h-8 rounded-full bg-white/80 hover:bg-white flex items-center justify-center transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#44403c"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                    </a>
                    <a href="#" target="_blank" class="w-8 h-8 rounded-full bg-white/80 hover:bg-white flex items-center justify-center transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#44403c"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    </a>
                    <a href="#" target="_blank" class="w-8 h-8 rounded-full bg-white/80 hover:bg-white flex items-center justify-center transition shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#44403c"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                    </a>
                </div>
            </div>
        </header>

        <div id="dashboard-view" class="w-full">
            <div class="max-w-xl mx-auto mb-6 flex gap-3 items-center overflow-x-auto pb-2" style="-webkit-overflow-scrolling: touch;">
                <div class="relative flex-1 min-w-[150px]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" class="absolute left-3 top-1/2 -translate-y-1/2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <input type="text" id="search-input" placeholder="Pesquisar aula..." class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-stone-200 focus:border-primary focus:outline-none text-stone-700 font-medium" oninput="filterModules(this.value)">
                </div>
                <a href="#" target="_blank" class="flex-shrink-0 inline-flex items-center gap-2 px-4 py-3 bg-white border border-stone-200 rounded-xl text-xs font-black text-stone-500 hover:text-[#8671d1] hover:border-[#8671d1] shadow-sm transition-all whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    BAIXAR CP
                </a>
                <button onclick="document.getElementById('instructions-modal').classList.add('active')" class="flex-shrink-0 inline-flex items-center gap-2 px-4 py-3 bg-white border border-stone-200 rounded-xl text-xs font-black text-stone-500 hover:text-[#8671d1] hover:border-[#8671d1] shadow-sm transition-all whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    INSTRUÇÕES
                </button>
                <button onclick="document.getElementById('journey-modal').classList.add('active')" class="flex-shrink-0 inline-flex items-center gap-2 px-4 py-3 bg-white border border-stone-200 rounded-xl text-xs font-black text-stone-500 hover:text-[#8671d1] hover:border-[#8671d1] shadow-sm transition-all whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    JORNADA
                </button>
            </div>
            <div id="level-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20"></div>
        </div>

        <div id="generator-view" class="hidden w-full pb-32">
            <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl mx-auto mb-20">
                <button class="back-button mb-4 flex items-center gap-2" onclick="showDashboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                    Voltar ao Menu
                </button>
                <div class="flex items-center justify-center gap-2 mb-4">
                    <h2 class="text-xl font-bold text-stone-800" id="current-hw-display"></h2>
                    <button class="w-6 h-6 rounded-full bg-stone-200 hover:bg-stone-300 text-stone-600 font-bold text-sm flex items-center justify-center" onclick="showHelpModal()">?</button>
                </div>
                <div id="quiz-streak-bar" class="streak-container"></div>
                <div id="feedback-alert" class="hidden p-3 mb-6 rounded-lg text-white font-semibold text-center"></div>
                <div class="challenge-box mb-6  p-6 bg-yellow-50">
                    <p id="main-question" class="text-lg font-bold text-slate-800"></p>
                </div>
                <div id="options-container" class="space-y-3"></div>
                <div id="rationale-display" class="hidden mt-6">
                    <div id="rationale-content" class="p-4 bg-green-50 text-green-900 rounded-lg mb-4 text-sm "></div>
                </div>
                <div id="next-btn-container" class="hidden mt-4">
                    <button class="action-button w-full" onclick="loadNextQuestion()">Próximo Exercício</button>
                </div>
            </div>
        </div>

        <div id="study-view" class="hidden w-full">
            <div class="study-container max-w-4xl mx-auto text-center">
                 <button class="back-button mb-4 flex items-center gap-2" onclick="showDashboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                    Voltar ao Menu
                 </button>
                 <div class="flex items-center justify-center gap-2 mb-2">
                    <h2 class="text-2xl font-bold text-stone-800" id="study-title"></h2>
                    <button id="help-btn" class="w-6 h-6 rounded-full bg-stone-200 hover:bg-stone-300 text-stone-600 font-bold text-sm flex items-center justify-center" onclick="showHelpModal()">?</button>
                 </div>
                 <p class="text-stone-500 mb-0 italic text-sm" id="study-instruction"></p>
                 <div id="streak-bar-container" class="hidden mb-0"></div>
                 <div id="preloading-status" class="text-xs text-primary font-bold mb-1 h-4"></div>
                 <div id="study-content-area" class="py-4"></div>
            </div>
        </div>
    </div>

    <!-- RULES POPUP -->
    <div id="rules-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content">
            <h3 class="text-xl font-black text-stone-800 mb-5 text-center">Manual de Regras</h3>
            <div class="space-y-5 text-left text-stone-600 text-sm leading-relaxed">
                <div class="flex gap-3"><div class="w-6 h-6 rounded-full bg-[#8671d1] text-white flex items-center justify-center shrink-0 font-bold">1</div><p><strong>Acesso Individual:</strong> Não compartilhe sua senha. Monitoramos acessos por IP.</p></div>
                <div class="flex gap-3"><div class="w-6 h-6 rounded-full bg-[#8671d1] text-white flex items-center justify-center shrink-0 font-bold">2</div><p><strong>Frequência:</strong> A evolução vem da prática constante. Tente completar um módulo de Homework após cada aula.</p></div>
                <div class="flex gap-3"><div class="w-6 h-6 rounded-full bg-[#8671d1] text-white flex items-center justify-center shrink-0 font-bold">3</div><p><strong>Prints:</strong> Ao completar um Streak de 5, tire um print e envie para seu teacher.</p></div>
                <div class="flex gap-3"><div class="w-6 h-6 rounded-full bg-[#8671d1] text-white flex items-center justify-center shrink-0 font-bold">4</div><p><strong>Listening:</strong> Use fones de ouvido para captar os detalhes.</p></div>
            </div>
            <button class="action-button w-full mt-8" onclick="document.getElementById('rules-modal').classList.remove('active')">Entendi, vamos lá!</button>
        </div>
    </div>

    <!-- INSTRUCTIONS POPUP -->
    <div id="instructions-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-black text-stone-800 mb-5 text-center">Como Funcionam os Modos de Estudo</h3>
            <div class="space-y-2 text-left max-h-[60vh] overflow-y-auto pr-2">
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">FLASHCARDS</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Cartões de memorização! Clique no cartão para virar e ver a tradução/resposta. Use as setas ou clique para avançar. Ideal para memorizar vocabulário e expressões.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">LISTENING</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Pratique sua compreensão auditiva! Ouça o áudio e escolha a opção correta. Use fones de ouvido para captar melhor os detalhes da pronúncia.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">CHUNKS</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Monte a frase correta! Arraste ou clique nas palavras na ordem certa para formar a frase em inglês. Ajuda a internalizar estruturas gramaticais.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">HOMEWORK</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Quiz de múltipla escolha! Responda 10 perguntas sobre o conteúdo da aula. Complete 5 acertos seguidos (streak) para finalizar com sucesso.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">FORCA</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Jogo da forca! Adivinhe a palavra letra por letra. Você tem 6 tentativas antes de perder. Complete 5 palavras seguidas para finalizar.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">CAÇA-PALAVRAS</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Caça-palavras! Encontre as palavras escondidas na grade clicando nas letras. Complete 2 puzzles seguidos para finalizar com sucesso.</div>
                </div>
            </div>
            <button class="action-button w-full mt-6" onclick="document.getElementById('instructions-modal').classList.remove('active')">Entendi!</button>
        </div>
    </div>
    <style>
        .accordion-item.open .accordion-content { display: block; }
        .accordion-item.open .accordion-arrow { transform: rotate(180deg); }
    </style>

    <!-- JOURNEY MODAL -->
    <div id="journey-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content" style="max-width: 420px;">
            <h3 class="text-xl font-black text-stone-800 mb-5 text-center">Sua Jornada no SLAP</h3>
            <div class="journey-grid">
                <div class="journey-step current">
                    <div class="journey-icon">1</div>
                    <div class="journey-info">
                        <span class="journey-name">Starter 1</span>
                        <span class="journey-level">Iniciante</span>
                        <span class="journey-badge">Você está aqui!</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">2</div>
                    <div class="journey-info">
                        <span class="journey-name">Starter 2</span>
                        <span class="journey-level">Básico</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">3</div>
                    <div class="journey-info">
                        <span class="journey-name">Freshman 1</span>
                        <span class="journey-level">Pré-intermediário</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">4</div>
                    <div class="journey-info">
                        <span class="journey-name">Freshman 2</span>
                        <span class="journey-level">Pré-intermediário</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">5</div>
                    <div class="journey-info">
                        <span class="journey-name">Sophomore 1</span>
                        <span class="journey-level">Intermediário</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">6</div>
                    <div class="journey-info">
                        <span class="journey-name">Sophomore 2</span>
                        <span class="journey-level">Intermediário</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">7</div>
                    <div class="journey-info">
                        <span class="journey-name">Senior 1</span>
                        <span class="journey-level">Avançado</span>
                    </div>
                </div>
                <div class="journey-step locked">
                    <div class="journey-icon">8</div>
                    <div class="journey-info">
                        <span class="journey-name">Senior 2</span>
                        <span class="journey-level">Avançado</span>
                    </div>
                </div>
                <div class="journey-step locked final" style="grid-column: span 2; justify-self: center; width: 100%; max-width: 180px;">
                    <div class="journey-icon">9</div>
                    <div class="journey-info">
                        <span class="journey-name">ACC</span>
                        <span class="journey-level">Conversação</span>
                    </div>
                </div>
            </div>
            <button class="action-button w-full mt-5" onclick="document.getElementById('journey-modal').classList.remove('active')">Fechar</button>
        </div>
    </div>
    <style>
        .journey-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .journey-step { display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; border-radius: 0.75rem; transition: 0.2s; background: #f5f5f4; }
        .journey-step.current { background: #fef9c3; border: 2px solid #F1D24B; }
        .journey-step.locked { opacity: 0.5; }
        .journey-icon { width: 36px; height: 36px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.85rem; flex-shrink: 0; }
        .journey-step.locked .journey-icon { background: #a8a29e; }
        .journey-step.current .journey-icon { background: #F1D24B; color: #44403c; }
        .journey-info { display: flex; flex-direction: column; }
        .journey-name { font-weight: 700; color: #44403c; font-size: 0.85rem; }
        .journey-level { font-size: 0.7rem; color: #78716c; font-weight: 500; }
        .journey-badge { font-size: 0.6rem; font-weight: 800; color: #8671d1; background: white; padding: 0.1rem 0.4rem; border-radius: 1rem; margin-top: 0.15rem; display: inline-block; width: fit-content; border: 1px solid #e2e8f0; }
    </style>

    <!-- HELP MODAL -->
    <div id="help-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="text-lg font-black text-stone-800 mb-3 text-center" id="help-modal-title">Como Jogar</h3>
            <p class="text-stone-600 text-sm leading-relaxed" id="help-modal-text"></p>
            <button class="action-button w-full mt-5" onclick="document.getElementById('help-modal').classList.remove('active')">Entendi!</button>
        </div>
    </div>

    <script>
        // ===== FIREBASE AUTH =====
        let firebaseApp = null;
        let firebaseAuth = null;
        let currentUser = null;

        async function initFirebase() {
            try {
                const res = await fetch('/api/firebase-config');
                const config = await res.json();
                if (!config.apiKey) {
                    console.warn('Firebase config not available');
                    return false;
                }
                firebaseApp = firebase.initializeApp(config);
                firebaseAuth = firebase.auth();
                return true;
            } catch (e) {
                console.warn('Could not load Firebase config:', e);
                return false;
            }
        }

        function switchLoginTab(tab) {
            const tabs = document.querySelectorAll('.login-tab');
            tabs[0].classList.toggle('active', tab === 'login');
            tabs[1].classList.toggle('active', tab === 'register');
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';
        }

        function getFirebaseErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Email inválido.',
                'auth/user-disabled': 'Esta conta foi desativada.',
                'auth/user-not-found': 'Email não cadastrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/invalid-credential': 'Email ou senha incorretos.',
                'auth/email-already-in-use': 'Este email já está cadastrado.',
                'auth/weak-password': 'A senha deve ter pelo menos 6 caracteres.',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
            };
            return messages[code] || 'Ocorreu um erro. Tente novamente.';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-submit-btn');
            errorEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'ENTRANDO...';
            try {
                await firebaseAuth.signInWithEmailAndPassword(email, password);
            } catch (err) {
                errorEl.textContent = getFirebaseErrorMessage(err.code);
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'ENTRAR';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            const btn = document.getElementById('register-submit-btn');
            errorEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'CRIANDO...';
            try {
                const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                await cred.user.updateProfile({ displayName: name });
            } catch (err) {
                errorEl.textContent = getFirebaseErrorMessage(err.code);
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'CRIAR CONTA';
            }
        }

        function handleLogout() {
            if (firebaseAuth) {
                firebaseAuth.signOut();
            }
        }

        function onAuthStateChanged(user) {
            currentUser = user;
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-wrapper').classList.remove('hidden');
                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('user-display-name').textContent = displayName;
                renderDashboard();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-wrapper').classList.add('hidden');
                document.getElementById('login-submit-btn').disabled = false;
                document.getElementById('login-submit-btn').textContent = 'ENTRAR';
                document.getElementById('register-submit-btn').disabled = false;
                document.getElementById('register-submit-btn').textContent = 'CRIAR CONTA';
            }
        }

        const audioCache = new Map();

        function playCorrectSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 523;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.15;
                oscillator.start();
                setTimeout(() => { oscillator.frequency.value = 659; }, 100);
                setTimeout(() => { oscillator.frequency.value = 784; }, 200);
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch(e) {}
        }

        function playIncorrectSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 200;
                oscillator.type = 'square';
                gainNode.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.25);
            } catch(e) {}
        }

        let currentStreak = 0;
        let quizStreak = 0;
        const STREAK_GOAL = 5;
        const WORDSEARCH_STREAK_GOAL = 2;
        let currentAulaId = 0;
        let currentStudyMode = '';

        const helpTexts = {
            flashcards: { title: "Como estudar com os Flashcards", text: "Toque no cartão para virar e ver a tradução em inglês. Use as setas para navegar entre os cartões. Clique no ícone de som para ouvir a pronúncia." },
            listening: { title: "Como estudar com o Listening", text: "Toque em cada item para ouvir como se pronuncia em inglês. Pratique repetindo em voz alta!" },
            chunks: { title: "Como estudar com os Chunks", text: "Digite a tradução em português de cada chunk e clique OK. Se acertar, fica verde. Se errar, fica vermelho - tente de novo!" },
            dictation: { title: "Como estudar com o Ditado", text: "Ouça o áudio e escreva exatamente o que ouviu. Pode ser o número ou a palavra por extenso. Acerte 5 seguidas para completar!" },
            scramble: { title: "Como estudar com o Scramble", text: "As palavras estão embaralhadas. Toque nelas na ordem correta para formar a frase. Acerte 5 seguidas para completar!" },
            mistake: { title: "Como estudar com o Mistake", text: "Uma das palavras está errada. Encontre e clique nela! Acerte 5 seguidas para completar!" },
            hangman: { title: "Como estudar com a Forca", text: "Adivinhe a palavra letra por letra. Cada erro desenha uma parte do boneco. Se completar o desenho, você perde!" },
            wordsearch: { title: "Como estudar com o Caça-Palavras", text: "Encontre as palavras escondidas no grid. Elas podem estar na horizontal, vertical ou diagonal. Você tem 2 minutos!" },
            homework: { title: "Como estudar com o Homework", text: "Responda as questões corretamente. Leia a explicação quando acertar. Acerte 5 seguidas para completar a missão!" }
        };

        function showHelpModal() {
            const modal = document.getElementById('help-modal');
            const help = helpTexts[currentStudyMode] || { title: "Como estudar", text: "Siga as instruções na tela para completar a atividade." };
            document.getElementById('help-modal-title').textContent = help.title;
            document.getElementById('help-modal-text').textContent = help.text;
            modal.classList.add('active');
        } 

        // --- APP DATA ---
        const aulaNames = [
            { id: 1, name: "Open House", hasHomework: false, desc: "Aula introdutória do curso." },
            { id: 2, name: "Feelings", hasHomework: true, specialMode: 'flashcards', desc: "Pratique vocabulário de sentimentos e emoções." },
            { id: 3, name: "Names & Greetings", hasHomework: true, specialMode: 'chunks', desc: "Treine apresentações e cumprimentos em inglês." },
            { id: 4, name: "Numbers pt. 1", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Pratique os números de 1 a 99.", items: [
                {n: "1", w: "One"}, {n: "2", w: "Two"}, {n: "3", w: "Three"}, {n: "4", w: "Four"}, {n: "5", w: "Five"},
                {n: "6", w: "Six"}, {n: "7", w: "Seven"}, {n: "8", w: "Eight"}, {n: "9", w: "Nine"}, {n: "10", w: "Ten"},
                {n: "11", w: "Eleven"}, {n: "12", w: "Twelve"}, {n: "13", w: "Thirteen"}, {n: "14", w: "Fourteen"}, {n: "15", w: "Fifteen"},
                {n: "16", w: "Sixteen"}, {n: "17", w: "Seventeen"}, {n: "18", w: "Eighteen"}, {n: "19", w: "Nineteen"}, {n: "20", w: "Twenty"},
                {n: "21", w: "Twenty-one"}, {n: "23", w: "Twenty-three"}, {n: "25", w: "Twenty-five"}, {n: "27", w: "Twenty-seven"}, {n: "29", w: "Twenty-nine"},
                {n: "30", w: "Thirty"}, {n: "32", w: "Thirty-two"}, {n: "34", w: "Thirty-four"}, {n: "36", w: "Thirty-six"}, {n: "38", w: "Thirty-eight"},
                {n: "40", w: "Forty"}, {n: "41", w: "Forty-one"}, {n: "43", w: "Forty-three"}, {n: "45", w: "Forty-five"}, {n: "47", w: "Forty-seven"},
                {n: "50", w: "Fifty"}, {n: "52", w: "Fifty-two"}, {n: "54", w: "Fifty-four"}, {n: "56", w: "Fifty-six"}, {n: "58", w: "Fifty-eight"},
                {n: "60", w: "Sixty"}, {n: "62", w: "Sixty-two"}, {n: "65", w: "Sixty-five"}, {n: "67", w: "Sixty-seven"}, {n: "69", w: "Sixty-nine"},
                {n: "70", w: "Seventy"}, {n: "71", w: "Seventy-one"}, {n: "73", w: "Seventy-three"}, {n: "75", w: "Seventy-five"}, {n: "78", w: "Seventy-eight"},
                {n: "80", w: "Eighty"}, {n: "82", w: "Eighty-two"}, {n: "84", w: "Eighty-four"}, {n: "87", w: "Eighty-seven"}, {n: "89", w: "Eighty-nine"},
                {n: "90", w: "Ninety"}, {n: "91", w: "Ninety-one"}, {n: "93", w: "Ninety-three"}, {n: "96", w: "Ninety-six"}, {n: "99", w: "Ninety-nine"}
            ]},
            { id: 5, name: "Numbers pt. 2", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Pratique números grandes: centenas, milhares e além.", items: [
                {n: "100", w: "One hundred"}, {n: "150", w: "One hundred and fifty"}, {n: "200", w: "Two hundred"}, {n: "300", w: "Three hundred"}, {n: "325", w: "Three hundred and twenty-five"}, {n: "400", w: "Four hundred"}, {n: "500", w: "Five hundred"}, {n: "505", w: "Five hundred and five"}, {n: "600", w: "Six hundred"}, {n: "700", w: "Seven hundred"}, {n: "800", w: "Eight hundred"}, {n: "900", w: "Nine hundred"}, {n: "1,000", w: "One thousand"}, {n: "1,200", w: "One thousand two hundred"}, {n: "2,000", w: "Two thousand"}, {n: "4,000", w: "Four thousand"}, {n: "5,500", w: "Five thousand five hundred"}, {n: "10,000", w: "Ten thousand"}, {n: "10,500", w: "Ten thousand five hundred"}, {n: "20,000", w: "Twenty thousand"}, {n: "30,000", w: "Thirty thousand"}, {n: "40,000", w: "Forty thousand"}, {n: "45,300", w: "Forty-five thousand three hundred"}, {n: "50,000", w: "Fifty thousand"}, {n: "60,000", w: "Sixty thousand"}, {n: "70,000", w: "Seventy thousand"}, {n: "80,000", w: "Eighty thousand"}, {n: "90,000", w: "Ninety thousand"}
            ]},
            { id: 6, name: "Spelling", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Aprenda a soletrar e pronunciar as letras do alfabeto.", items: [
                {n: "A", w: "ay", p: "/eɪ/"}, {n: "B", w: "bee", p: "/biː/"}, {n: "C", w: "cee", p: "/siː/"}, {n: "D", w: "dee", p: "/diː/"},
                {n: "E", w: "ee", p: "/iː/"}, {n: "F", w: "ef", p: "/ɛf/"}, {n: "G", w: "gee", p: "/dʒiː/"}, {n: "H", w: "aitch", p: "/eɪtʃ/"},
                {n: "I", w: "eye", p: "/aɪ/"}, {n: "J", w: "jay", p: "/dʒeɪ/"}, {n: "K", w: "kay", p: "/keɪ/"}, {n: "L", w: "el", p: "/ɛl/"},
                {n: "M", w: "em", p: "/ɛm/"}, {n: "N", w: "en", p: "/ɛn/"}, {n: "O", w: "oh", p: "/oʊ/"}, {n: "P", w: "pee", p: "/piː/"},
                {n: "Q", w: "cue", p: "/kjuː/"}, {n: "R", w: "ar", p: "/ɑːr/"}, {n: "S", w: "ess", p: "/ɛs/"}, {n: "T", w: "tee", p: "/tiː/"},
                {n: "U", w: "you", p: "/juː/"}, {n: "V", w: "vee", p: "/viː/"}, {n: "W", w: "double you", p: "/ˈdʌbəljuː/"}, {n: "X", w: "ex", p: "/ɛks/"},
                {n: "Y", w: "why", p: "/waɪ/"}, {n: "Z", w: "zee", p: "/ziː/"}
            ] },
            { id: 7, name: "Ordinal Numbers", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Treine os números ordinais: first, second, third...", items: [{n:"1st",w:"First"},{n:"2nd",w:"Second"},{n:"3rd",w:"Third"},{n:"4th",w:"Fourth"},{n:"5th",w:"Fifth"},{n:"6th",w:"Sixth"},{n:"7th",w:"Seventh"},{n:"8th",w:"Eighth"},{n:"9th",w:"Ninth"},{n:"10th",w:"Tenth"},{n:"11th",w:"Eleventh"},{n:"12th",w:"Twelfth"},{n:"13th",w:"Thirteenth"},{n:"14th",w:"Fourteenth"},{n:"15th",w:"Fifteenth"},{n:"16th",w:"Sixteenth"},{n:"17th",w:"Seventeenth"},{n:"18th",w:"Eighteenth"},{n:"19th",w:"Nineteenth"},{n:"20th",w:"Twentieth"},{n:"21st",w:"Twenty-first"},{n:"22nd",w:"Twenty-second"},{n:"23rd",w:"Twenty-third"},{n:"24th",w:"Twenty-fourth"},{n:"25th",w:"Twenty-fifth"},{n:"26th",w:"Twenty-sixth"},{n:"27th",w:"Twenty-seventh"},{n:"28th",w:"Twenty-eighth"},{n:"29th",w:"Twenty-ninth"},{n:"30th",w:"Thirtieth"},{n:"31st",w:"Thirty-first"},{n:"32nd",w:"Thirty-second"},{n:"33rd",w:"Thirty-third"},{n:"34th",w:"Thirty-fourth"},{n:"35th",w:"Thirty-fifth"},{n:"40th",w:"Fortieth"},{n:"41st",w:"Forty-first"},{n:"42nd",w:"Forty-second"},{n:"43rd",w:"Forty-third"},{n:"45th",w:"Forty-fifth"},{n:"50th",w:"Fiftieth"},{n:"51st",w:"Fifty-first"},{n:"52nd",w:"Fifty-second"},{n:"53rd",w:"Fifty-third"},{n:"55th",w:"Fifty-fifth"},{n:"58th",w:"Fifty-eighth"},{n:"60th",w:"Sixtieth"},{n:"61st",w:"Sixty-first"},{n:"62nd",w:"Sixty-second"},{n:"63rd",w:"Sixty-third"},{n:"65th",w:"Sixty-fifth"},{n:"70th",w:"Seventieth"},{n:"71st",w:"Seventy-first"},{n:"72nd",w:"Seventy-second"},{n:"73rd",w:"Seventy-third"},{n:"75th",w:"Seventy-fifth"},{n:"77th",w:"Seventy-seventh"},{n:"80th",w:"Eightieth"},{n:"81st",w:"Eighty-first"},{n:"82nd",w:"Eighty-second"},{n:"83rd",w:"Eighty-third"},{n:"85th",w:"Eighty-fifth"},{n:"89th",w:"Eighty-ninth"},{n:"90th",w:"Ninetieth"},{n:"91st",w:"Ninety-first"},{n:"92nd",w:"Ninety-second"},{n:"93rd",w:"Ninety-third"},{n:"95th",w:"Ninety-fifth"},{n:"99th",w:"Ninety-ninth"},{n:"100th",w:"One hundredth"}] },
            { id: 8, name: "Basic Verbs", hasHomework: true, thirdBtn: 'dictation', desc: "Pratique os verbos mais usados no dia a dia." },
            { id: 9, name: "Basic Adjectives", hasHomework: true, thirdBtn: 'dictation', desc: "Aprenda adjetivos para descrever pessoas e coisas." },
            { id: 10, name: "Demonstrative Pronouns", hasHomework: true, specialMode: 'scramble', desc: "Treine this, that, these e those nas frases." },
            { id: 11, name: "Verb to be", hasHomework: true, desc: "Domine o verbo to be: am, is e are." },
            { id: 12, name: "Countries and Nationalities", hasHomework: true, specialMode: 'flashcards', desc: "Aprenda países e nacionalidades em inglês." },
            { id: 13, name: "Neighborhood", hasHomework: true, desc: "Vocabulário de lugares e locais do bairro." },
            { id: 14, name: "Family Members", hasHomework: true, desc: "Pratique os nomes dos membros da família." },
            { id: 15, name: "Midterm Test", hasHomework: false, desc: "Prova intermediária do módulo." },
            { id: 16, name: "Can e Can't", hasHomework: true, specialMode: 'scramble', desc: "Pratique frases com can e can't (habilidades)." },
            { id: 17, name: "Midterm Test Correction", hasHomework: false, desc: "Correção da prova intermediária." },
            { id: 18, name: "Simple Present pt. 1", hasHomework: true, specialMode: 'scramble', desc: "Monte frases no presente simples." },
            { id: 19, name: "Simple Present pt. 2", hasHomework: true, specialMode: 'scramble', desc: "Continue praticando o presente simples." },
            { id: 20, name: "Object Pronouns", hasHomework: true, specialMode: 'scramble', desc: "Treine me, you, him, her, us, them nas frases." },
            { id: 21, name: "Likes and Dislikes", hasHomework: true, desc: "Expresse gostos e preferências em inglês." },
            { id: 22, name: "Free Time Activities", hasHomework: true, desc: "Vocabulário de atividades de lazer e tempo livre." },
            { id: 23, name: "Months and Holidays", hasHomework: true, specialMode: 'listening', thirdBtn: 'flashcards', desc: "Aprenda os meses do ano e feriados.", items: [{n:"Jan",w:"January"},{n:"Feb",w:"February"},{n:"Mar",w:"March"},{n:"Apr",w:"April"},{n:"May",w:"May"},{n:"Jun",w:"June"},{n:"Jul",w:"July"},{n:"Aug",w:"August"},{n:"Sep",w:"September"},{n:"Oct",w:"October"},{n:"Nov",w:"November"},{n:"Dec",w:"December"}] },
            { id: 24, name: "Possessive Adjectives", hasHomework: true, specialMode: 'scramble', desc: "Pratique my, your, his, her, our, their." },
            { id: 25, name: "Possessive Pronouns", hasHomework: true, specialMode: 'scramble', desc: "Treine mine, yours, his, hers, ours, theirs." },
            { id: 26, name: "Foods and Fruits", hasHomework: true, specialMode: 'flashcards', desc: "Vocabulário de comidas e frutas em inglês." },
            { id: 27, name: "Presentation", hasHomework: false, desc: "Aula de apresentação oral." },
            { id: 28, name: "Hours", hasHomework: true, specialMode: 'flashcards', thirdBtn: 'dictation', desc: "Aprenda a dizer as horas em inglês." },
            { id: 29, name: "Kahoot Review", hasHomework: false, desc: "Revisão interativa com Kahoot." },
            { id: 30, name: "Listening Test", hasHomework: false, desc: "Prova de compreensão auditiva." },
            { id: 31, name: "Grammar Test", hasHomework: false, desc: "Prova de gramática do módulo." },
            { id: 32, name: "GT e LT Review", hasHomework: false, desc: "Revisão das provas de gramática e listening." },
            { id: 33, name: "OT Review", hasHomework: false, desc: "Revisão para a prova oral." },
            { id: 34, name: "Oral Test Day 1", hasHomework: false, desc: "Primeiro dia da prova oral." },
            { id: 35, name: "Oral Test Day 2", hasHomework: false, desc: "Segundo dia da prova oral." },
            { id: 36, name: "General Feedback", hasHomework: false, desc: "Feedback geral do módulo." }
        ];

        const flashcardsData = {
            2: [
                { front: "Feliz", back: "Happy" }, { front: "Triste", back: "Sad" }, { front: "Bravo(a)", back: "Angry" },
                { front: "Cansado(a)", back: "Tired" }, { front: "Animado(a)", back: "Excited" }, { front: "Nervoso(a)", back: "Nervous" },
                { front: "Assustado(a)", back: "Scared" }, { front: "Entediado(a)", back: "Bored" }, { front: "Confuso(a)", back: "Confused" },
                { front: "Orgulhoso(a)", back: "Proud" }, { front: "Preocupado(a)", back: "Worried" }, { front: "Surpreso(a)", back: "Surprised" },
                { front: "Envergonhado(a)", back: "Embarrassed" }, { front: "Frustrado(a)", back: "Frustrated" }, { front: "Aliviado(a)", back: "Relieved" },
                { front: "Solitário(a)", back: "Lonely" }, { front: "Grato(a)", back: "Grateful" }, { front: "Ciumento(a)", back: "Jealous" },
                { front: "Calmo(a)", back: "Calm" }, { front: "Ansioso(a)", back: "Anxious" }
            ],
            12: [
                { front: "🇧🇷", back: "Brazil / Brazilian" }, { front: "🇺🇸", back: "USA / American" },
                { front: "🇬🇧", back: "England / British" }, { front: "🇫🇷", back: "France / French" },
                { front: "🇪🇸", back: "Spain / Spanish" }, { front: "🇮🇹", back: "Italy / Italian" },
                { front: "🇯🇵", back: "Japan / Japanese" }, { front: "🇨🇳", back: "China / Chinese" },
                { front: "🇩🇪", back: "Germany / German" }, { front: "🇵🇹", back: "Portugal / Portuguese" }
            ],
            23: [
                { front: "Natal", back: "Christmas" }, { front: "Ano Novo", back: "New Year's Day" }, 
                { front: "Páscoa", back: "Easter" }, { front: "Dia das Mães", back: "Mother's Day" }, 
                { front: "Dia dos Pais", back: "Father's Day" }, { front: "Dia das Crianças", back: "Children's Day" },
                { front: "Carnaval", back: "Carnival" }, { front: "Dia de Ação de Graças", back: "Thanksgiving" },
                { front: "Dia dos Namorados", back: "Valentine's Day" }, { front: "Halloween", back: "Halloween" }
            ],
            26: [
                { front: "🍎", back: "Apple" }, { front: "🍌", back: "Banana" }, { front: "🍊", back: "Orange" },
                { front: "🍇", back: "Grapes" }, { front: "🍓", back: "Strawberry" }, { front: "🍑", back: "Peach" },
                { front: "🍒", back: "Cherry" }, { front: "🍍", back: "Pineapple" }, { front: "🥭", back: "Mango" },
                { front: "🍉", back: "Watermelon" }, { front: "🍋", back: "Lemon" }, { front: "🍈", back: "Melon" },
                { front: "🥝", back: "Kiwi" }, { front: "🫐", back: "Blueberry" }, { front: "🍐", back: "Pear" },
                { front: "🥥", back: "Coconut" }, { front: "🍅", back: "Tomato" }, { front: "🥑", back: "Avocado" },
                { front: "🫒", back: "Olive" }, { front: "🍏", back: "Green Apple" }, { front: "🥒", back: "Cucumber" },
                { front: "🍕", back: "Pizza" }, { front: "🥦", back: "Broccoli" }, { front: "🥕", back: "Carrot" },
                { front: "🥩", back: "Steak" }, { front: "🍚", back: "Rice" }, { front: "🍦", back: "Ice cream" },
                { front: "🍞", back: "Bread" }, { front: "🧀", back: "Cheese" }, { front: "🥬", back: "Lettuce" }
            ],
            28: [
                { front: "08:00", back: "Eight o'clock" },
                { front: "08:30", back: "Eight thirty / Half past eight" },
                { front: "09:15", back: "Nine fifteen / Quarter past nine" },
                { front: "09:45", back: "Nine forty-five / Quarter to ten / Fifteen to ten" },
                { front: "10:20", back: "Ten twenty / Twenty past ten / Forty to eleven" },
                { front: "10:40", back: "Ten forty / Twenty to eleven / Forty past ten" },
                { front: "11:05", back: "Eleven oh five / Five past eleven" },
                { front: "11:55", back: "Eleven fifty-five / Five to twelve" },
                { front: "12:00", back: "Twelve o'clock / Noon / Midday" },
                { front: "00:00", back: "Twelve o'clock / Midnight" },
                { front: "03:30", back: "Three thirty / Half past three" },
                { front: "03:20", back: "Three twenty / Twenty past three / Forty to four" },
                { front: "04:10", back: "Four ten / Ten past four / Fifty to five" },
                { front: "05:25", back: "Five twenty-five / Twenty-five past five / Thirty-five to six" },
                { front: "06:35", back: "Six thirty-five / Thirty-five past six / Twenty-five to seven" },
                { front: "06:45", back: "Six forty-five / Quarter to seven / Fifteen to seven" },
                { front: "07:00", back: "Seven o'clock" },
                { front: "07:50", back: "Seven fifty / Ten to eight / Fifty past seven" },
                { front: "02:15", back: "Two fifteen / Quarter past two / Fifteen past two" },
                { front: "01:30", back: "One thirty / Half past one" }
            ]
        };

        const chunksData = {
            // Asking About Names (module 3)
            3: [
                { en: "What's your name?", pt: "Qual é o seu nome?" }, 
                { en: "What's your first name?", pt: "Qual é o seu primeiro nome?" }, 
                { en: "What's your middle name?", pt: "Qual é o seu nome do meio?" }, 
                { en: "What's your nickname?", pt: "Qual é o seu apelido?" }, 
                { en: "What's your last name?", pt: "Qual é o seu sobrenome?" },
                { en: "My name is...", pt: "Meu nome é..." },
                { en: "Nice to meet you!", pt: "Prazer em conhecê-lo!" },
                { en: "Where are you from?", pt: "De onde você é?" },
                { en: "How old are you?", pt: "Quantos anos você tem?" },
                { en: "I'm from Brazil.", pt: "Eu sou do Brasil." }
            ]
        };

        const gamesData = {
            // Demonstrative Pronouns (module 10)
            10: [
                { full: "this is my car", words: ["this", "is", "my", "car"] },
                { full: "that is your house", words: ["that", "is", "your", "house"] },
                { full: "these are my books", words: ["these", "are", "my", "books"] },
                { full: "those are her shoes", words: ["those", "are", "her", "shoes"] },
                { full: "this is a good idea", words: ["this", "is", "a", "good", "idea"] }
            ],
            // Can e Can't (module 16)
            16: [
                { full: "I can dance", words: ["I", "can", "dance"] },
                { full: "she can speak English", words: ["she", "can", "speak", "English"] },
                { full: "they can't swim", words: ["they", "can't", "swim"] },
                { full: "we can play soccer", words: ["we", "can", "play", "soccer"] },
                { full: "he can't drive a car", words: ["he", "can't", "drive", "a", "car"] }
            ],
            // Simple Present pt. 1 (module 18)
            18: [
                { full: "I drink water every day", words: ["I", "drink", "water", "every", "day"] },
                { full: "she works at a hospital", words: ["she", "works", "at", "a", "hospital"] },
                { full: "they study English", words: ["they", "study", "English"] },
                { full: "he plays soccer on weekends", words: ["he", "plays", "soccer", "on", "weekends"] },
                { full: "we eat breakfast together", words: ["we", "eat", "breakfast", "together"] }
            ],
            // Simple Present pt. 2 - negativas e interrogativas (module 19)
            19: [
                { full: "I don't like coffee", words: ["I", "don't", "like", "coffee"] },
                { full: "she doesn't work here", words: ["she", "doesn't", "work", "here"] },
                { full: "they don't speak French", words: ["they", "don't", "speak", "French"] },
                { full: "he doesn't have a car", words: ["he", "doesn't", "have", "a", "car"] },
                { full: "we don't eat meat", words: ["we", "don't", "eat", "meat"] },
                { full: "do you like pizza", words: ["do", "you", "like", "pizza"] },
                { full: "does she live here", words: ["does", "she", "live", "here"] },
                { full: "do they study English", words: ["do", "they", "study", "English"] },
                { full: "does he play guitar", words: ["does", "he", "play", "guitar"] },
                { full: "do we need help", words: ["do", "we", "need", "help"] }
            ],
            // Object Pronouns (module 20)
            20: [
                { full: "help me please", words: ["help", "me", "please"] },
                { full: "I love you", words: ["I", "love", "you"] },
                { full: "call him now", words: ["call", "him", "now"] },
                { full: "give her the book", words: ["give", "her", "the", "book"] },
                { full: "tell us the story", words: ["tell", "us", "the", "story"] }
            ],
            // Possessive Adjectives (module 24)
            24: [
                { full: "my book is new", words: ["my", "book", "is", "new"] },
                { full: "your car is fast", words: ["your", "car", "is", "fast"] },
                { full: "her dress is beautiful", words: ["her", "dress", "is", "beautiful"] },
                { full: "his name is John", words: ["his", "name", "is", "John"] },
                { full: "our house is big", words: ["our", "house", "is", "big"] }
            ],
            // Possessive Pronouns (module 25)
            25: [
                { full: "this pen is mine", words: ["this", "pen", "is", "mine"] },
                { full: "that book is yours", words: ["that", "book", "is", "yours"] },
                { full: "the car is hers", words: ["the", "car", "is", "hers"] },
                { full: "this phone is his", words: ["this", "phone", "is", "his"] },
                { full: "the house is ours", words: ["the", "house", "is", "ours"] }
            ],
            // Dictation data
            4: { dictation: ["one two three", "four five six", "seven eight nine", "ten one five", "three six nine", "two four eight", "five seven ten", "one four seven", "six eight two", "three five one", "nine two six", "four seven three", "eight ten five", "two nine four", "seven one eight"], isNumberCombo: true },
            5: { dictation: ["eleven twelve thirteen", "fourteen fifteen sixteen", "seventeen eighteen nineteen", "twenty eleven fourteen", "thirteen sixteen nineteen", "twelve fifteen eighteen", "seventeen twenty eleven", "fourteen thirteen twelve", "nineteen sixteen fifteen", "eighteen eleven twenty", "twelve seventeen fourteen", "fifteen nineteen thirteen", "sixteen eighteen twelve", "twenty thirteen seventeen", "eleven fifteen nineteen"], isNumberCombo: true },
            6: { dictation: ["CAR", "DOG", "CAT", "BUS", "SUN", "HAT", "PEN", "RED", "BOX", "CUP", "BOOK", "TREE", "FISH", "BIRD", "HAND", "STAR", "MOON", "BALL", "CAKE", "MILK"], isSpelling: true },
            7: { dictation: ["first", "second", "third", "fourth", "fifth", "sixth", "seventh", "eighth", "ninth", "tenth"] },
            8: { dictation: ["run", "walk", "eat", "drink", "sleep", "work", "play", "read", "write", "speak"] },
            9: { dictation: ["happy", "sad", "big", "small", "hot", "cold", "fast", "slow", "good", "bad"] },
            28: { dictation: ["08:00", "12:30", "03:15", "06:45", "09:00", "10:30", "02:00", "07:15", "11:45", "04:30"] }
        };

        // --- REAL HOMEWORK QUESTIONS (10 PER MODULE) ---
        const quizData = {
            2: [ // AULA 01: FEELINGS + VERB TO BE
                {q: "Complete a frase com a opção correta: After a long day, I am ____.", options: [{text:"happy", isCorrect:false}, {text:"tired", isCorrect:true}, {text:"excited", isCorrect:false}, {text:"relaxed", isCorrect:false}], rationale: "Após um longo dia, você fica cansado (tired)."},
                {q: "Escolha a frase mais natural em inglês:", options: [{text:"I am feel sad", isCorrect:false}, {text:"I feel sad", isCorrect:true}, {text:"I feeling sad", isCorrect:false}, {text:"I am sad feel", isCorrect:false}], rationale: "'I feel sad' é a forma correta."},
                {q: "Escolha o significado correto: 'She is angry.'", options: [{text:"Ela está cansada", isCorrect:false}, {text:"Ela está feliz", isCorrect:false}, {text:"Ela está brava", isCorrect:true}, {text:"Ela está animada", isCorrect:false}], rationale: "Angry = brava/irritada."},
                {q: "Complete a frase de acordo com a situação: When I don't sleep well, I feel ____.", options: [{text:"tired", isCorrect:true}, {text:"excited", isCorrect:false}, {text:"relaxed", isCorrect:false}, {text:"happy", isCorrect:false}], rationale: "Sem dormir bem, ficamos cansados (tired)."},
                {q: "Escolha o oposto de happy:", options: [{text:"angry", isCorrect:false}, {text:"sad", isCorrect:true}, {text:"tired", isCorrect:false}, {text:"scared", isCorrect:false}], rationale: "O oposto de feliz é triste (sad)."},
                {q: "Complete a frase com o verbo correto: 'I ____ scared of dogs.'", options: [{text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"am", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "'I' exige o verbo 'am'."},
                {q: "Qual opção NÃO é um sentimento?", options: [{text:"nervous", isCorrect:false}, {text:"tired", isCorrect:false}, {text:"smile", isCorrect:true}, {text:"angry", isCorrect:false}], rationale: "Smile (sorriso) é uma ação, não um sentimento."},
                {q: "Escolha a ordem mais natural das palavras:", options: [{text:"I am now angry", isCorrect:false}, {text:"I angry am now", isCorrect:false}, {text:"I now am angry", isCorrect:false}, {text:"I am angry now", isCorrect:true}], rationale: "A ordem padrão é Sujeito + Verbo + Adjetivo + Tempo."},
                {q: "Depois de uma boa notícia, você normalmente se sente:", options: [{text:"tired", isCorrect:false}, {text:"happy", isCorrect:true}, {text:"angry", isCorrect:false}, {text:"scared", isCorrect:false}], rationale: "Boas notícias trazem felicidade (happy)."},
                {q: "Depois de uma discussão ruim, você normalmente se sente:", options: [{text:"happy", isCorrect:false}, {text:"relaxed", isCorrect:false}, {text:"angry", isCorrect:true}, {text:"excited", isCorrect:false}], rationale: "Discussões ruins causam raiva (angry)."}
            ],
            3: [ // AULA 02: NAMES & GREETINGS
                {q: "Você está saindo da aula. O que você diz?", options: [{text:"Hi!", isCorrect:false}, {text:"Good morning!", isCorrect:false}, {text:"Have a good night", isCorrect:true}, {text:"What's up?", isCorrect:false}], rationale: "Ao sair, desejamos boa noite."},
                {q: "Complete a frase: '____ name is Daniela.'", options: [{text:"I", isCorrect:false}, {text:"My", isCorrect:true}, {text:"He", isCorrect:false}, {text:"You", isCorrect:false}], rationale: "My (meu/minha) é o possessivo correto."},
                {q: "Escolha a frase correta:", options: [{text:"My name Daniela", isCorrect:false}, {text:"My name is Daniela", isCorrect:true}, {text:"My is name Daniela", isCorrect:false}, {text:"Name is my Daniela", isCorrect:false}], rationale: "A estrutura é My name + is + Nome."},
                {q: "Você conhece seu professor pela primeira vez. O que você diz?", options: [{text:"Bye", isCorrect:false}, {text:"Hello, nice to meet you", isCorrect:true}, {text:"See you later", isCorrect:false}, {text:"Good night", isCorrect:false}], rationale: "Cumprimento padrão para o primeiro encontro."},
                {q: "Escolha a pergunta correta:", options: [{text:"What your name is?", isCorrect:false}, {text:"What is name you?", isCorrect:false}, {text:"What is your name?", isCorrect:true}, {text:"Your name what is?", isCorrect:false}], rationale: "Ordem correta: What is + your name?"},
                {q: "Complete a expressão: 'Nice to ____ you.'", options: [{text:"be", isCorrect:false}, {text:"say", isCorrect:false}, {text:"meet", isCorrect:true}, {text:"talk", isCorrect:false}], rationale: "Nice to meet you = Prazer em conhecê-lo."},
                {q: "'Hi, I'm Paulo' significa:", options: [{text:"Oi, eu sou Paulo", isCorrect:true}, {text:"Oi, qual é seu nome?", isCorrect:false}, {text:"Tchau, Paulo", isCorrect:false}, {text:"Prazer, Paulo", isCorrect:false}], rationale: "Tradução direta de apresentação."},
                {q: "Qual cumprimento é mais informal?", options: [{text:"Good evening", isCorrect:false}, {text:"Hello", isCorrect:false}, {text:"Hi", isCorrect:true}, {text:"Good afternoon", isCorrect:false}], rationale: "Hi é o mais informal."},
                {q: "Pergunta: What's your name?", options: [{text:"Hi!", isCorrect:false}, {text:"My name is Laura", isCorrect:true}, {text:"Nice to meet you", isCorrect:false}, {text:"Goodbye", isCorrect:false}], rationale: "Resposta direta à pergunta."},
                {q: "Quando normalmente dizemos 'Goodbye'?", options: [{text:"Quando chegamos", isCorrect:false}, {text:"Quando nos apresentamos", isCorrect:false}, {text:"Quando vamos embora", isCorrect:true}, {text:"Quando encontramos alguém", isCorrect:false}], rationale: "Goodbye é despedida."}
            ],
            4: [ // AULA 03: NUMBERS
                {q: "Escolha o número correto: 'Eight'", options: [{text:"6", isCorrect:false}, {text:"7", isCorrect:false}, {text:"8", isCorrect:true}, {text:"9", isCorrect:false}], rationale: "Eight = 8."},
                {q: "Complete a frase: 'I have ____ cousins.'", options: [{text:"two", isCorrect:true}, {text:"second", isCorrect:false}, {text:"twice", isCorrect:false}, {text:"double", isCorrect:false}], rationale: "Usa-se número cardinal para quantidade."},
                {q: "O que vem depois de nine?", options: [{text:"eight", isCorrect:false}, {text:"ten", isCorrect:true}, {text:"eleven", isCorrect:false}, {text:"twelve", isCorrect:false}], rationale: "9, 10 (Ten)."},
                {q: "Complete a frase: 'I am ____ years old.'", options: [{text:"twenty", isCorrect:true}, {text:"twentieth", isCorrect:false}, {text:"twenties", isCorrect:false}, {text:"twentys", isCorrect:false}], rationale: "Idade usa números cardinais."},
                {q: "Escolha a frase correta:", options: [{text:"I have three brother", isCorrect:false}, {text:"I have three brothers", isCorrect:true}, {text:"I have brother three", isCorrect:false}, {text:"I have brothers three", isCorrect:false}], rationale: "Plural no substantivo após o número."},
                {q: "Complete a frase: '____ students are in the SLAP class.' (10)", options: [{text:"tenth", isCorrect:false}, {text:"ten", isCorrect:true}, {text:"teen", isCorrect:false}, {text:"tens", isCorrect:false}], rationale: "Quantidade 10 = Ten."},
                {q: "Four plus five is:", options: [{text:"eight", isCorrect:false}, {text:"nine", isCorrect:true}, {text:"ten", isCorrect:false}, {text:"eleven", isCorrect:false}], rationale: "4 + 5 = 9 (Nine)."},
                {q: "Escolha a frase mais natural em inglês:", options: [{text:"I have 30 years", isCorrect:false}, {text:"I am 30 years", isCorrect:false}, {text:"I am 30 years old", isCorrect:true}, {text:"I have 30 old", isCorrect:false}], rationale: "Em inglês, 'somos' a idade (I am), não 'temos'."},
                {q: "Escolha a grafia correta:", options: [{text:"for", isCorrect:false}, {text:"fore", isCorrect:false}, {text:"four", isCorrect:true}, {text:"fower", isCorrect:false}], rationale: "Quatro = Four."},
                {q: "Escolha a frase correta:", options: [{text:"I have two car", isCorrect:false}, {text:"I have two cars", isCorrect:true}, {text:"I have cars two", isCorrect:false}, {text:"I have two car's", isCorrect:false}], rationale: "Número + Substantivo Plural."}
            ],
            5: [ // AULA 04: NUMBERS (CONTEXTO REAL)
                {q: "Como normalmente falamos um número de telefone em inglês?", options: [{text:"In big numbers", isCorrect:false}, {text:"As one long number", isCorrect:false}, {text:"Digit by digit", isCorrect:true}, {text:"Using ordinal numbers", isCorrect:false}], rationale: "Telefones são ditos dígito a dígito."},
                {q: "Escolha a forma mais natural de dizer 358:", options: [{text:"Three five eight", isCorrect:false}, {text:"Three hundred fifty-eight", isCorrect:true}, {text:"Thirty five eight", isCorrect:false}, {text:"Three hundred eight", isCorrect:false}], rationale: "Centenas + dezenas."},
                {q: "Como normalmente dizemos o ano 2015 de forma formal?", options: [{text:"Two thousand and fifteen", isCorrect:true}, {text:"Twenty fifteen", isCorrect:false}, {text:"Two zero one five", isCorrect:false}, {text:"Two thousand five", isCorrect:false}], rationale: "Forma formal usa 'two thousand and...'."},
                {q: "Escolha a forma mais natural de dizer $12.99:", options: [{text:"Twelve ninety-nine", isCorrect:true}, {text:"Twelve dollars ninety-nine", isCorrect:false}, {text:"Twelve dollars and ninety-nine cents", isCorrect:false}, {text:"Ninety-nine dollars twelve", isCorrect:false}], rationale: "Forma curta comum para preços."},
                {q: "Complete a frase: 'My house number is ____.' (230)", options: [{text:"Two three zero", isCorrect:true}, {text:"Two hundred thirty zero", isCorrect:false}, {text:"Twenty three zero", isCorrect:false}, {text:"Two hundred three", isCorrect:false}], rationale: "Endereços costumam ser dígito a dígito."},
                {q: "Complete a frase: 'My phone number starts with ____.' (9)", options: [{text:"nine", isCorrect:true}, {text:"ninth", isCorrect:false}, {text:"nineteen", isCorrect:false}, {text:"ninety", isCorrect:false}], rationale: "Dígito 9 = Nine."},
                {q: "Que número vem depois de thirty-nine?", options: [{text:"thirty-ten", isCorrect:false}, {text:"forty", isCorrect:true}, {text:"fourteen", isCorrect:false}, {text:"forty-one", isCorrect:false}], rationale: "39 -> 40 (Forty)."},
                {q: "Escolha a frase correta:", options: [{text:"The price is 20 dollars and 50", isCorrect:false}, {text:"The price is twenty dollars fifty", isCorrect:false}, {text:"The price is twenty dollars and fifty cents", isCorrect:true}, {text:"The price is twenty fifty", isCorrect:false}], rationale: "Forma completa e correta de preço."},
                {q: "Como normalmente falamos números de apartamento?", options: [{text:"Using ordinal numbers", isCorrect:false}, {text:"Digit by digit", isCorrect:true}, {text:"Using letters", isCorrect:false}, {text:"Using plural numbers", isCorrect:false}], rationale: "Como telefones e endereços."},
                {q: "Escolha a grafia correta:", options: [{text:"Fourty", isCorrect:false}, {text:"Forty", isCorrect:true}, {text:"Fourti", isCorrect:false}, {text:"Fourtee", isCorrect:false}], rationale: "Quarenta se escreve Forty (sem o 'u')."}
            ],
            6: [ // AULA 05: SPELLING & PERSONAL INFORMATION
                {q: "Alguém pergunta: 'How do you spell your last name?' O que você responde?", options: [{text:"I am Silva", isCorrect:false}, {text:"Silva", isCorrect:false}, {text:"S-I-L-V-A", isCorrect:true}, {text:"My name is Silva", isCorrect:false}], rationale: "Soletrar = dizer letra por letra."},
                {q: "Escolha a grafia correta do nome: 'Maria'", options: [{text:"M-E-R-I-A", isCorrect:false}, {text:"M-A-R-I-A", isCorrect:true}, {text:"M-A-R-E-A", isCorrect:false}, {text:"M-E-R-E-A", isCorrect:false}], rationale: "A soletração correta."},
                {q: "Como dizemos o símbolo @ em inglês?", options: [{text:"at", isCorrect:true}, {text:"on", isCorrect:false}, {text:"in", isCorrect:false}, {text:"to", isCorrect:false}], rationale: "@ = at."},
                {q: "Complete a frase corretamente: 'My email is anna ____ hotmail.com'", options: [{text:"on", isCorrect:false}, {text:"at", isCorrect:true}, {text:"in", isCorrect:false}, {text:"to", isCorrect:false}], rationale: "Usa-se 'at' para o @."},
                {q: "Escolha a frase correta:", options: [{text:"Can you spell your name?", isCorrect:true}, {text:"Can you spell me your name?", isCorrect:false}, {text:"You spell your name?", isCorrect:false}, {text:"Spell you your name?", isCorrect:false}], rationale: "Pergunta correta para pedir soletração."},
                {q: "Como abreviamos Television?", options: [{text:"Tee-vee", isCorrect:false}, {text:"T-V", isCorrect:true}, {text:"Ti-vi", isCorrect:false}, {text:"Tee-vi", isCorrect:false}], rationale: "TV são as letras T e V."},
                {q: "Complete a frase: 'My name is Jacob. It has ____ letters.'", options: [{text:"five", isCorrect:true}, {text:"fifth", isCorrect:false}, {text:"fiveth", isCorrect:false}, {text:"fifteenth", isCorrect:false}], rationale: "J-A-C-O-B = 5 letras."},
                {q: "Quando soletramos informações, normalmente:", options: [{text:"falamos rápido", isCorrect:false}, {text:"usamos números ordinais", isCorrect:false}, {text:"dizemos cada letra claramente", isCorrect:true}, {text:"traduzimos a palavra", isCorrect:false}], rationale: "Clareza é essencial ao soletrar."},
                {q: "Escolha a abreviação correta de 'Speaking Like a Pro':", options: [{text:"SPARK", isCorrect:false}, {text:"SELIAPR", isCorrect:false}, {text:"SLP", isCorrect:false}, {text:"SLAP", isCorrect:true}], rationale: "SLAP = Speaking Like A Pro."},
                {q: "Qual pergunta gera a resposta 'M-A-R-I-A'?", options: [{text:"Can you spell your name for me?", isCorrect:true}, {text:"Can you spell your last name for me?", isCorrect:false}, {text:"How are you?", isCorrect:false}, {text:"Can you spell your middle name for me?", isCorrect:false}], rationale: "A resposta é a soletração do primeiro nome."}
            ],
            7: [ // AULA 06: ORDINAL NUMBERS
                {q: "Escolha o número ordinal de 1:", options: [{text:"one", isCorrect:false}, {text:"first", isCorrect:true}, {text:"once", isCorrect:false}, {text:"oneth", isCorrect:false}], rationale: "1º = first."},
                {q: "Qual é o ordinal de 2?", options: [{text:"two", isCorrect:false}, {text:"second", isCorrect:true}, {text:"twoth", isCorrect:false}, {text:"twelve", isCorrect:false}], rationale: "2º = second."},
                {q: "Complete a frase: 'I live on the ____ floor.' (3)", options: [{text:"three", isCorrect:false}, {text:"third", isCorrect:true}, {text:"thirteen", isCorrect:false}, {text:"thirty", isCorrect:false}], rationale: "3º andar = third floor."},
                {q: "Complete a frase: 'My birthday is on the ____ of May.' (5)", options: [{text:"five", isCorrect:false}, {text:"fifth", isCorrect:true}, {text:"fifteen", isCorrect:false}, {text:"fifty", isCorrect:false}], rationale: "5º = fifth."},
                {q: "Qual é o ordinal de 4?", options: [{text:"four", isCorrect:false}, {text:"fourth", isCorrect:true}, {text:"forty", isCorrect:false}, {text:"fortieth", isCorrect:false}], rationale: "4º = fourth."},
                {q: "Escolha a frase correta:", options: [{text:"I am on the two floor", isCorrect:false}, {text:"I am on the second floor", isCorrect:true}, {text:"I am in the two floor", isCorrect:false}, {text:"I am in second floor", isCorrect:false}], rationale: "Usamos ordinal + on the."},
                {q: "Complete a frase: 'This is my ____ day at SLAP.' (1)", options: [{text:"one", isCorrect:false}, {text:"first", isCorrect:true}, {text:"once", isCorrect:false}, {text:"oneth", isCorrect:false}], rationale: "1º = first."},
                {q: "Qual é o ordinal de 6?", options: [{text:"six", isCorrect:false}, {text:"sixth", isCorrect:true}, {text:"sixt", isCorrect:false}, {text:"sixteen", isCorrect:false}], rationale: "6º = sixth."},
                {q: "Complete a frase: 'The meeting is on the ____ of June.' (2)", options: [{text:"two", isCorrect:false}, {text:"second", isCorrect:true}, {text:"twelve", isCorrect:false}, {text:"twenty", isCorrect:false}], rationale: "2º = second."},
                {q: "Quando usamos números ordinais?", options: [{text:"Para falar de quantidade", isCorrect:false}, {text:"Para falar de ordem", isCorrect:true}, {text:"Para falar de cor", isCorrect:false}, {text:"Para falar de preço", isCorrect:false}], rationale: "Ordinais indicam posição/ordem."}
            ],
            8: [ // AULA 07: BASIC VERBS (SIMPLE PRESENT)
                {q: "Complete a frase: 'I ____ breakfast in the morning.'", options: [{text:"eats", isCorrect:false}, {text:"eat", isCorrect:true}, {text:"eating", isCorrect:false}, {text:"ate", isCorrect:false}], rationale: "Com 'I' usamos o verbo na forma base."},
                {q: "Complete a frase: 'She ____ water every day.'", options: [{text:"drink", isCorrect:false}, {text:"drinks", isCorrect:true}, {text:"drinking", isCorrect:false}, {text:"drank", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Complete a frase: 'They ____ soccer on weekends.'", options: [{text:"plays", isCorrect:false}, {text:"play", isCorrect:true}, {text:"playing", isCorrect:false}, {text:"played", isCorrect:false}], rationale: "Com 'they' usamos o verbo na forma base."},
                {q: "Escolha a frase correta:", options: [{text:"He read books", isCorrect:false}, {text:"He reads books", isCorrect:true}, {text:"He reading books", isCorrect:false}, {text:"He read books every day", isCorrect:false}], rationale: "Com 'he' adicionamos -s ao verbo."},
                {q: "Complete a frase: 'We ____ English at SLAP.'", options: [{text:"speaks", isCorrect:false}, {text:"speak", isCorrect:true}, {text:"speaking", isCorrect:false}, {text:"spoke", isCorrect:false}], rationale: "Com 'we' usamos o verbo na forma base."},
                {q: "Complete a frase: 'She ____ every morning.'", options: [{text:"run", isCorrect:false}, {text:"runs", isCorrect:true}, {text:"running", isCorrect:false}, {text:"ran", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Escolha a frase correta:", options: [{text:"I write emails", isCorrect:true}, {text:"I writes emails", isCorrect:false}, {text:"I writing emails", isCorrect:false}, {text:"I wrote emails every day", isCorrect:false}], rationale: "Com 'I' usamos o verbo na forma base."},
                {q: "Complete a frase: 'He ____ his homework at night.'", options: [{text:"do", isCorrect:false}, {text:"does", isCorrect:true}, {text:"doing", isCorrect:false}, {text:"did", isCorrect:false}], rationale: "Com 'he' o verbo 'do' vira 'does'."},
                {q: "Complete a frase: 'She ____ a book before bed.'", options: [{text:"read", isCorrect:false}, {text:"reads", isCorrect:true}, {text:"reading", isCorrect:false}, {text:"readed", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Escolha a frase correta:", options: [{text:"They drink coffee", isCorrect:true}, {text:"They drinks coffee", isCorrect:false}, {text:"They drinking coffee", isCorrect:false}, {text:"They drank coffee every day", isCorrect:false}], rationale: "Com 'they' usamos o verbo na forma base."}
            ],
            9: [ // AULA 08: BASIC ADJECTIVES
                {q: "Escolha o oposto de big:", options: [{text:"tall", isCorrect:false}, {text:"small", isCorrect:true}, {text:"old", isCorrect:false}, {text:"good", isCorrect:false}], rationale: "Big (grande) x Small (pequeno)."},
                {q: "Escolha a frase correta:", options: [{text:"The house is big", isCorrect:true}, {text:"The house big is", isCorrect:false}, {text:"Big the house is", isCorrect:false}, {text:"House is the big", isCorrect:false}], rationale: "Ordem: Sujeito + is + adjetivo."},
                {q: "Escolha o oposto de tall:", options: [{text:"big", isCorrect:false}, {text:"old", isCorrect:false}, {text:"short", isCorrect:true}, {text:"small", isCorrect:false}], rationale: "Tall (alto) x Short (baixo)."},
                {q: "Complete a frase: 'The car is ____.' (not good)", options: [{text:"big", isCorrect:false}, {text:"bad", isCorrect:true}, {text:"old", isCorrect:false}, {text:"tall", isCorrect:false}], rationale: "Good (bom) x Bad (ruim)."},
                {q: "Complete a frase: 'He is ____.' (not old)", options: [{text:"old", isCorrect:false}, {text:"bad", isCorrect:false}, {text:"young", isCorrect:true}, {text:"short", isCorrect:false}], rationale: "Old (velho) x Young (jovem)."},
                {q: "Escolha o oposto de young:", options: [{text:"tall", isCorrect:false}, {text:"small", isCorrect:false}, {text:"old", isCorrect:true}, {text:"big", isCorrect:false}], rationale: "Young (jovem) x Old (velho)."},
                {q: "Escolha a frase correta:", options: [{text:"The dog is small", isCorrect:true}, {text:"The dog small is", isCorrect:false}, {text:"Small is the dog", isCorrect:false}, {text:"Dog is small the", isCorrect:false}], rationale: "Ordem: Sujeito + is + adjetivo."},
                {q: "Complete a frase: 'The building is ____.' (not short)", options: [{text:"tall", isCorrect:true}, {text:"small", isCorrect:false}, {text:"young", isCorrect:false}, {text:"bad", isCorrect:false}], rationale: "Short (baixo) x Tall (alto)."},
                {q: "Escolha o oposto de good:", options: [{text:"big", isCorrect:false}, {text:"old", isCorrect:false}, {text:"bad", isCorrect:true}, {text:"small", isCorrect:false}], rationale: "Good (bom) x Bad (ruim)."},
                {q: "Qual opção é um adjetivo?", options: [{text:"run", isCorrect:false}, {text:"eat", isCorrect:false}, {text:"old", isCorrect:true}, {text:"speak", isCorrect:false}], rationale: "Old é adjetivo, os outros são verbos."}
            ],
            10: [ // AULA 09: DEMONSTRATIVE PRONOUNS
                {q: "Complete a frase: '____ is my phone.' (perto, singular)", options: [{text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"this", isCorrect:true}, {text:"those", isCorrect:false}], rationale: "This = perto + singular."},
                {q: "Complete a frase: '____ are my keys.' (perto, plural)", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"those", isCorrect:false}, {text:"these", isCorrect:true}], rationale: "These = perto + plural."},
                {q: "Complete a frase: '____ is my house over there.' (longe, singular)", options: [{text:"this", isCorrect:false}, {text:"these", isCorrect:false}, {text:"that", isCorrect:true}, {text:"those", isCorrect:false}], rationale: "That = longe + singular."},
                {q: "Complete a frase: '____ are those people.' (longe, plural)", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"those", isCorrect:true}], rationale: "Those = longe + plural."},
                {q: "Escolha a frase correta:", options: [{text:"This are my books", isCorrect:false}, {text:"These is my books", isCorrect:false}, {text:"These are my books", isCorrect:true}, {text:"Those is my books", isCorrect:false}], rationale: "These (plural) + are."},
                {q: "Complete a frase: '____ pen here is blue.' (perto)", options: [{text:"that", isCorrect:false}, {text:"those", isCorrect:false}, {text:"these", isCorrect:false}, {text:"this", isCorrect:true}], rationale: "This = perto + singular."},
                {q: "Complete a frase: '____ cars over there are expensive.'", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"those", isCorrect:true}], rationale: "Those = longe + plural."},
                {q: "Qual opção é plural?", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:true}, {text:"thises", isCorrect:false}], rationale: "These é a forma plural de this."},
                {q: "Escolha a frase correta:", options: [{text:"That are my shoes", isCorrect:false}, {text:"Those are my shoes", isCorrect:true}, {text:"Those is my shoes", isCorrect:false}, {text:"That is my shoes", isCorrect:false}], rationale: "Those (plural) + are."},
                {q: "Quando usamos this?", options: [{text:"Para algo longe e plural", isCorrect:false}, {text:"Para algo perto e singular", isCorrect:true}, {text:"Para algo longe e singular", isCorrect:false}, {text:"Para algo perto e plural", isCorrect:false}], rationale: "This = perto + singular."}
            ],
            11: [ // AULA 10: VERB TO BE
                {q: "Complete a frase: 'I ____ tired.'", options: [{text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"am", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "I + am."},
                {q: "Complete a frase: 'She ____ a teacher.'", options: [{text:"am", isCorrect:false}, {text:"are", isCorrect:false}, {text:"is", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "She + is."},
                {q: "Complete a frase: 'They ____ at home.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"be", isCorrect:false}, {text:"are", isCorrect:true}], rationale: "They + are."},
                {q: "Escolha a frase correta:", options: [{text:"He are happy", isCorrect:false}, {text:"He am happy", isCorrect:false}, {text:"He is happy", isCorrect:true}, {text:"He be happy", isCorrect:false}], rationale: "He + is."},
                {q: "Complete a frase: 'We ____ students.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "We + are."},
                {q: "Escolha a frase correta:", options: [{text:"I is Brazilian", isCorrect:false}, {text:"I are Brazilian", isCorrect:false}, {text:"I am Brazilian", isCorrect:true}, {text:"I be Brazilian", isCorrect:false}], rationale: "I + am."},
                {q: "Complete a pergunta: '____ you married?'", options: [{text:"am", isCorrect:false}, {text:"is", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "You + are."},
                {q: "Escolha a resposta correta: — Are they friends?", options: [{text:"Yes, they is", isCorrect:false}, {text:"Yes, they are", isCorrect:true}, {text:"Yes, they am", isCorrect:false}, {text:"Yes, they be", isCorrect:false}], rationale: "They + are."},
                {q: "Escolha a forma negativa correta: 'She ____ happy.'", options: [{text:"isn't", isCorrect:true}, {text:"aren't", isCorrect:false}, {text:"am not", isCorrect:false}, {text:"don't", isCorrect:false}], rationale: "She + isn't (is not)."},
                {q: "Escolha a frase correta:", options: [{text:"We is ready", isCorrect:false}, {text:"We am ready", isCorrect:false}, {text:"We are ready", isCorrect:true}, {text:"We be ready", isCorrect:false}], rationale: "We + are."}
            ]
        };

        // Fallback generator for other modules to ensure 10 questions exist
        function getQuizDataForModule(id) {
            if (quizData[id]) return quizData[id];

            // Generic fallback questions based on module name
            const modName = aulaNames.find(a => a.id === id).name;
            const generic = [];
            for(let i=0; i<10; i++) {
                generic.push({
                    q: `Qual a opção correta?`,
                    options: [
                        {text: "Opção Correta", isCorrect: true},
                        {text: "Opção Errada 1", isCorrect: false},
                        {text: "Opção Errada 2", isCorrect: false},
                        {text: "Opção Errada 3", isCorrect: false}
                    ],
                    rationale: "Esta é uma pergunta de treino gerada para completar o exercício."
                });
            }
            return generic;
        }

        let currentQuestion = null;
        let questionsPool = [];
        let answerSubmitted = false;
        let currentFlashcardIdx = 0;
        let currentShuffledCards = [];
        let currentShuffledData = []; 
        let currentIdx = 0; 
        let scrambleResult = [];

        // Web Speech API - funciona em qualquer navegador moderno, sem precisar de API key
        function speakText(text) {
            return new Promise((resolve) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    // Evita que "I" seja lido como "capital I"
                    let processedText = text;
                    if (text === "I") {
                        processedText = "i";
                    }
                    const utterance = new SpeechSynthesisUtterance(processedText);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    // Tenta encontrar uma voz em inglês
                    const voices = window.speechSynthesis.getVoices();
                    const englishVoice = voices.find(v => v.lang.startsWith('en')) || voices[0];
                    if (englishVoice) utterance.voice = englishVoice;
                    
                    utterance.onend = () => resolve();
                    utterance.onerror = () => resolve();
                    window.speechSynthesis.speak(utterance);
                } else {
                    resolve();
                }
            });
        }
        
        // Carrega vozes quando disponíveis
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }

        async function fetchTTSAudio(text) {
            // Retorna um objeto compatível com a interface esperada
            return {
                play: () => speakText(text),
                pause: () => window.speechSynthesis.cancel()
            };
        }

        window.showDashboard = function() {
            if (wsTimer) { clearInterval(wsTimer); wsTimer = null; }
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('generator-view').classList.add('hidden');
            document.getElementById('study-view').classList.add('hidden');
        };

        window.scrollToModule = function(id) {
            const el = document.getElementById(`module-${id}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.filterModules = function(query) {
            const cards = document.querySelectorAll('#level-cards-container > div');
            const normalizedQuery = query.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            cards.forEach(card => {
                const title = card.querySelector('.font-bold')?.textContent || '';
                const normalizedTitle = title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (normalizedTitle.includes(normalizedQuery) || normalizedQuery === '') {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function renderDashboard() {
            const container = document.getElementById('level-cards-container');
            container.innerHTML = aulaNames.map(aula => {
                let studyLabel = '';
                if (aula.specialMode === 'flashcards') studyLabel = 'FLASHCARDS';
                else if (aula.specialMode === 'listening') studyLabel = 'LISTENING';
                else if (aula.specialMode === 'chunks') studyLabel = 'CHUNKS';
                else if (aula.specialMode === 'mistake') studyLabel = 'DETETIVE';
                else if (aula.specialMode === 'scramble') studyLabel = 'SCRAMBLE';

                const sBtn = studyLabel ? `<button class="secondary-button-sm" onclick="openStudy(${aula.id})">${studyLabel}</button>` : '';
                const tBtn = (aula.id === 23) ? `<button class="secondary-button-sm" onclick="openFlashcards(23)">FLASHCARDS</button>` : '';
                const dBtn = (aula.thirdBtn === 'dictation') ? `<button class="secondary-button-sm" onclick="openDictation(${aula.id})">DITADO</button>` : '';
                const hBtn = ([6, 23, 26].includes(aula.id)) ? `<button class="secondary-button-sm" onclick="openHangman(${aula.id})">FORCA</button>` : '';
                const cBtn = ([12, 14].includes(aula.id)) ? `<button class="secondary-button-sm" onclick="openWordSearch(${aula.id})">CAÇA-PALAVRAS</button>` : '';

                return `
                <div class="level-card relative ${!aula.hasHomework ? 'locked' : ''}" id="module-${aula.id}">
                    ${!aula.hasHomework ? `
                        <div class="lock-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        </div>
                    ` : `<img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1760657894/SLAP_ICON_PRETO_2_2_tv8bmp.png" alt="Logo" class="absolute top-4 right-4 w-8 h-8 opacity-10">`}
                    <div>
                        <span class="module-tag">STARTER 1 - HW AULA ${String(aula.id).padStart(2, '0')}</span>
                        <h3 class="text-xl font-bold text-stone-800 mb-2 mt-2">${aula.name}</h3>
                        <p class="text-stone-500 text-sm mb-6">${aula.desc}</p>
                    </div>
                    <div class="flex flex-wrap gap-1.5">
                        ${sBtn} ${tBtn} ${dBtn} ${hBtn} ${cBtn}
                        <button class="action-button-sm uppercase" ${(!aula.hasHomework || aula.id > 10) ? 'disabled' : `onclick="openPractice(${aula.id})"`}>HOMEWORK</button>
                    </div>
                </div>`
            }).join('');
        }

        window.openPractice = function(id) {
            currentAulaId = id; 
            currentStudyMode = 'homework';
            const aula = aulaNames.find(a => a.id === id);
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('generator-view').classList.remove('hidden');
            document.getElementById('current-hw-display').textContent = "Homework: " + aulaNames.find(a => a.id===id).name;
            quizStreak = 0; renderQuizStreak(); loadNextQuestion();
        };

        window.loadNextQuestion = function() {
            if (quizStreak >= STREAK_GOAL) {
                document.getElementById('main-question').innerHTML = `<div class="text-center py-4"><div class="text-6xl mb-4">📸</div><h2 class="text-2xl font-bold">Missão Cumprida!</h2><p class="text-stone-500">Tire um print para o seu Teacher!</p></div>`;
                document.getElementById('options-container').innerHTML = `<button class="action-button" onclick="showDashboard()">Voltar</button>`;
                document.getElementById('rationale-display').classList.add('hidden');
                document.getElementById('feedback-alert').classList.add('hidden');
                document.getElementById('next-btn-container').classList.add('hidden');
                return;
            }

            if (questionsPool.length === 0) {
                 questionsPool = shuffle([...getQuizDataForModule(currentAulaId)]); 
            }

            currentQuestion = questionsPool.pop();

            document.getElementById('main-question').textContent = currentQuestion.q;
            document.getElementById('rationale-display').classList.add('hidden');
            document.getElementById('feedback-alert').classList.add('hidden');
            document.getElementById('next-btn-container').classList.add('hidden');
            answerSubmitted = false;

            const container = document.getElementById('options-container');
            container.innerHTML = currentQuestion.options.map((opt, i) => 
                `<button class="option-button w-full border-2 border-slate-200 p-4 rounded-xl font-bold text-left hover:border-yellow-400 transition-all flex items-center" onclick="submitAnswer(${idxToBool(opt.isCorrect)}, ${i}, '${(currentQuestion.rationale || "").replace(/'/g, "\\'")}')">
                    <span class="w-8 h-8 rounded-full bg-yellow-50 text-amber-700 flex items-center justify-center font-bold mr-3 flex-shrink-0 text-sm border border-yellow-300">${String.fromCharCode(65+i)}</span>
                    <span>${opt.text}</span>
                </button>`
            ).join('');
        };

        function idxToBool(val) { return val ? 'true' : 'false'; } 

        window.submitAnswer = function(correct, idx, rationale) {
            if (answerSubmitted) return;
            answerSubmitted = true;
            const alert = document.getElementById('feedback-alert');

            if (correct) {
                playCorrectSound();
                quizStreak++;
                document.getElementById('rationale-content').textContent = rationale;
                document.getElementById('rationale-display').classList.remove('hidden');
            } else {
                playIncorrectSound();
                quizStreak = 0;
                document.getElementById('rationale-display').classList.add('hidden');
            }
            alert.classList.add('hidden');
            document.getElementById('next-btn-container').classList.remove('hidden');
            renderQuizStreak();

            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.disabled = true;
                if (i === idx) {
                   if(correct) btn.classList.add('bg-green-50', 'border-green-400');
                   else btn.classList.add('bg-red-50', 'border-red-400');
                }
            });
        };

        function renderQuizStreak() {
            const progress = Math.min(quizStreak, STREAK_GOAL);
            const percentage = (progress / STREAK_GOAL) * 100;
            const isComplete = quizStreak >= STREAK_GOAL;
            document.getElementById('quiz-streak-bar').innerHTML = `
                <div class="streak-bar-wrapper">
                    <div class="streak-label text-center">
                        ${isComplete ? '<svg class="inline w-5 h-5 mr-1 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Streak completo! Tire um print!' : `Complete ${STREAK_GOAL} acertos seguidos: ${progress}/${STREAK_GOAL}`}
                    </div>
                    <div class="streak-bar-bg">
                        <div class="streak-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        }

        window.openStudy = function(id) {
            const aula = aulaNames.find(a => a.id === id);
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            const titleArea = document.getElementById('study-title');
            const instrArea = document.getElementById('study-instruction');
            const contentArea = document.getElementById('study-content-area');
            const statusArea = document.getElementById('preloading-status');

            titleArea.textContent = aula.name;
            statusArea.textContent = "";
            currentIdx = 0;
            currentStreak = 0; // Reset streak
            renderStreakBar(); // Initial render

            if (aula.specialMode === 'flashcards') {
                currentStudyMode = 'flashcards';
                instrArea.textContent = "";
                currentFlashcardIdx = 0; 
                currentShuffledCards = shuffle([...flashcardsData[id]]); 
                renderFlashcards();
            } else if (aula.specialMode === 'listening') {
                currentStudyMode = 'listening';
                instrArea.textContent = "";
                const useWideGrid = [5, 7].includes(id);
                renderListeningBoard(aula.items, useWideGrid);
            } else if (aula.specialMode === 'chunks') {
                currentStudyMode = 'chunks';
                titleArea.textContent = "CHUNKS OF LANGUAGE";
                instrArea.textContent = "";
                renderChunksGrid(chunksData[id]);
            } else if (aula.specialMode === 'mistake') {
                currentStudyMode = 'mistake';
                instrArea.textContent = "";
                currentShuffledData = shuffle([...gamesData[id]]);
                renderMistake();
            } else if (aula.specialMode === 'scramble') {
                currentStudyMode = 'scramble';
                instrArea.textContent = "";
                currentShuffledData = shuffle([...gamesData[id]]);
                renderScramble();
            }
        };

        window.openFlashcards = function(id) {
            const aula = aulaNames.find(a => a.id === id);
            currentStudyMode = 'flashcards';
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Flashcards: Holidays";
            document.getElementById('study-instruction').textContent = "";
            currentFlashcardIdx = 0; currentShuffledCards = shuffle([...flashcardsData[id]]); renderFlashcards();
        }

        let isSpellingMode = false;
        let isNumberComboMode = false;
        window.openDictation = function(id) {
             const aula = aulaNames.find(a => a.id === id);
             currentStudyMode = 'dictation';
             isSpellingMode = gamesData[id].isSpelling || false;
             isNumberComboMode = gamesData[id].isNumberCombo || false;
             document.getElementById('dashboard-view').classList.add('hidden');
             document.getElementById('study-view').classList.remove('hidden');
             document.getElementById('study-title').textContent = "Ditado";
             document.getElementById('study-instruction').textContent = "";
             currentShuffledData = shuffle([...gamesData[id].dictation]);
             currentIdx = 0;
             currentStreak = 0; // Reset Streak
             renderStreakBar(); // Initial render
             renderDictation();
        }

        // HANGMAN GAME
        const hangmanWordLists = {
            6: [ // Spelling - 10 palavras
                {word: "CAR", hint: "Veículo com 4 rodas"},
                {word: "DOG", hint: "Melhor amigo do homem"},
                {word: "CAT", hint: "Animal que mia"},
                {word: "BUS", hint: "Transporte público"},
                {word: "SUN", hint: "Estrela que ilumina o dia"},
                {word: "HAT", hint: "Acessório para a cabeça"},
                {word: "PEN", hint: "Usamos para escrever"},
                {word: "RED", hint: "Cor do coração"},
                {word: "BOX", hint: "Caixa em inglês"},
                {word: "CUP", hint: "Usamos para beber café"}
            ],
            23: [ // Months and Holidays - 10 palavras
                {word: "JANUARY", hint: "Primeiro mês do ano"},
                {word: "FEBRUARY", hint: "Mês do carnaval"},
                {word: "MARCH", hint: "Terceiro mês do ano"},
                {word: "APRIL", hint: "Mês da Páscoa"},
                {word: "MAY", hint: "Mês das mães"},
                {word: "JUNE", hint: "Mês das festas juninas"},
                {word: "JULY", hint: "Mês das férias de inverno"},
                {word: "AUGUST", hint: "Mês dos pais"},
                {word: "CHRISTMAS", hint: "Feriado em 25 de dezembro"},
                {word: "EASTER", hint: "Feriado do coelhinho"}
            ],
            26: [ // Foods and Fruits - 10 palavras
                {word: "APPLE", hint: "Fruta vermelha ou verde"},
                {word: "BANANA", hint: "Fruta amarela e comprida"},
                {word: "ORANGE", hint: "Fruta cítrica laranja"},
                {word: "GRAPE", hint: "Fruta pequena usada para vinho"},
                {word: "LEMON", hint: "Fruta azeda e amarela"},
                {word: "BREAD", hint: "Alimento feito de farinha"},
                {word: "CHEESE", hint: "Derivado do leite"},
                {word: "RICE", hint: "Grão branco do almoço"},
                {word: "PIZZA", hint: "Comida italiana redonda"},
                {word: "JUICE", hint: "Bebida de frutas"}
            ]
        };
        let currentHangmanList = [];
        let hangmanWord = "";
        let hangmanHint = "";
        let hangmanGuessed = [];
        let hangmanWrong = 0;
        const hangmanMaxWrong = 6;

        window.openHangman = function(moduleId) {
            currentStudyMode = 'hangman';
            currentHangmanList = hangmanWordLists[moduleId] || hangmanWordLists[6];
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Forca";
            document.getElementById('study-instruction').textContent = "";
            currentStreak = 0;
            renderStreakBar();
            startNewHangman();
        }

        function startNewHangman() {
            const item = currentHangmanList[Math.floor(Math.random() * currentHangmanList.length)];
            hangmanWord = item.word;
            hangmanHint = item.hint;
            hangmanGuessed = [];
            hangmanWrong = 0;
            renderHangman();
        }

        function renderHangman() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= STREAK_GOAL) {
                area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                        <p class="text-stone-500 mb-8">Você acertou ${STREAK_GOAL} palavras seguidas na Forca!</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; startNewHangman()">Jogar Novamente</button>
                    </div>`;
                return;
            }

            const wordDisplay = hangmanWord.split('').map(letter => 
                hangmanGuessed.includes(letter) ? letter : '_'
            ).join(' ');
            
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const keyboard = alphabet.map(letter => {
                const used = hangmanGuessed.includes(letter);
                const isWrong = used && !hangmanWord.includes(letter);
                const isCorrect = used && hangmanWord.includes(letter);
                return `<button 
                    class="w-9 h-9 m-0.5 rounded-lg font-bold text-sm transition ${used ? (isCorrect ? 'bg-green-500 text-white' : 'bg-red-400 text-white opacity-50') : 'bg-white border-2 border-stone-200 hover:border-primary hover:bg-primary/5'}"
                    ${used ? 'disabled' : `onclick="guessLetter('${letter}')"`}
                >${letter}</button>`;
            }).join('');

            area.innerHTML = `
                <div class="flex flex-col sm:flex-row items-center sm:items-start justify-center gap-4 sm:gap-8">
                    <div class="flex flex-col items-center gap-3">
                        <svg width="160" height="160" viewBox="0 0 200 200" class="bg-white rounded-xl p-3">
                            <line x1="40" y1="180" x2="160" y2="180" stroke="#44403c" stroke-width="4"/>
                            <line x1="60" y1="180" x2="60" y2="20" stroke="#44403c" stroke-width="4"/>
                            <line x1="60" y1="20" x2="120" y2="20" stroke="#44403c" stroke-width="4"/>
                            <line x1="120" y1="20" x2="120" y2="40" stroke="#44403c" stroke-width="4"/>
                            ${hangmanWrong >= 1 ? '<circle cx="120" cy="55" r="15" stroke="#8671d1" stroke-width="3" fill="none"/>' : ''}
                            ${hangmanWrong >= 2 ? '<line x1="120" y1="70" x2="120" y2="110" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 3 ? '<line x1="120" y1="80" x2="100" y2="100" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 4 ? '<line x1="120" y1="80" x2="140" y2="100" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 5 ? '<line x1="120" y1="110" x2="100" y2="140" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 6 ? '<line x1="120" y1="110" x2="140" y2="140" stroke="#8671d1" stroke-width="3"/>' : ''}
                        </svg>
                        <div class="text-3xl font-bold tracking-widest text-stone-800">${wordDisplay}</div>
                        <div class="bg-amber-100 text-amber-800 px-3 py-1.5 rounded-lg text-sm font-medium">💡 ${hangmanHint}</div>
                        <div class="text-sm text-stone-500">Erros: ${hangmanWrong}/${hangmanMaxWrong}</div>
                    </div>
                    <div class="flex flex-col items-center gap-3">
                        <div class="grid grid-cols-7 gap-1">${keyboard}</div>
                        <div id="hangman-result"></div>
                    </div>
                </div>
            `;
        }

        window.guessLetter = function(letter) {
            if (hangmanGuessed.includes(letter)) return;
            hangmanGuessed.push(letter);
            
            // Ler a letra em voz alta
            speakText(letter.toLowerCase());

            if (!hangmanWord.includes(letter)) {
                hangmanWrong++;
            }

            renderHangman();

            const allRevealed = hangmanWord.split('').every(l => hangmanGuessed.includes(l));
            const resultDiv = document.getElementById('hangman-result');

            if (allRevealed) {
                currentStreak++;
                renderStreakBar();
                resultDiv.innerHTML = `<div class="text-green-600 font-bold text-lg mb-2">Parabéns! Você acertou!</div>
                    <button class="action-button" onclick="startNewHangman()">Próxima Palavra</button>`;
            } else if (hangmanWrong >= hangmanMaxWrong) {
                currentStreak = 0;
                renderStreakBar();
                resultDiv.innerHTML = `<div class="text-red-600 font-bold text-lg mb-2">Game Over! Tente outra palavra.</div>
                    <button class="action-button" onclick="startNewHangman()">Tentar Novamente</button>`;
            }
        }

        // WORD SEARCH GAME
        const wordSearchData = {
            12: [ // Countries
                { words: ["CHINA", "BRAZIL", "JAPAN", "MEXICO", "EGYPT"] },
                { words: ["INDIA", "ITALY", "SPAIN", "RUSSIA", "PERU"] },
                { words: ["ENGLAND", "GERMANY", "FRANCE", "CUBA", "IRAN"] }
            ],
            14: [ // Family Members
                { words: ["SON", "SISTER", "UNCLE", "AUNT", "DAD"] },
                { words: ["MOM", "BROTHER", "COUSIN", "WIFE", "BABY"] },
                { words: ["DAUGHTER", "GRANDMA", "HUSBAND", "NEPHEW", "MOTHER"] }
            ]
        };
        let currentWordSearchList = [];
        let currentWordSearch = null;
        let wordSearchStreak = 0;
        let wsGrid = [];
        let wsWords = [];
        let wsFoundWords = [];
        let wsSelectedCells = [];
        let wsIsSelecting = false;
        let wsTimer = null;
        let wsTimeLeft = 120;
        const WS_TIME_LIMIT = 120;

        function generateWordSearchGrid(words, size = 10) {
            const grid = Array(size).fill(null).map(() => Array(size).fill(''));
            const directions = [
                {dr: 0, dc: 1},   // right
                {dr: 1, dc: 0},   // down
                {dr: 1, dc: 1},   // diagonal down-right
                {dr: 0, dc: -1},  // left
                {dr: -1, dc: 0},  // up
                {dr: -1, dc: -1}, // diagonal up-left
                {dr: 1, dc: -1},  // diagonal down-left
                {dr: -1, dc: 1}   // diagonal up-right
            ];
            
            const shuffledWords = [...words].sort(() => Math.random() - 0.5);
            
            for (const word of shuffledWords) {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 100) {
                    const dir = directions[Math.floor(Math.random() * directions.length)];
                    const startR = Math.floor(Math.random() * size);
                    const startC = Math.floor(Math.random() * size);
                    
                    let canPlace = true;
                    const cells = [];
                    
                    for (let i = 0; i < word.length; i++) {
                        const r = startR + dir.dr * i;
                        const c = startC + dir.dc * i;
                        if (r < 0 || r >= size || c < 0 || c >= size) {
                            canPlace = false;
                            break;
                        }
                        if (grid[r][c] !== '' && grid[r][c] !== word[i]) {
                            canPlace = false;
                            break;
                        }
                        cells.push({r, c, letter: word[i]});
                    }
                    
                    if (canPlace) {
                        cells.forEach(cell => grid[cell.r][cell.c] = cell.letter);
                        placed = true;
                    }
                    attempts++;
                }
            }
            
            // Fill empty cells with random letters
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    if (grid[r][c] === '') {
                        grid[r][c] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
            
            return grid;
        }

        let usedWordSearchIndices = [];

        window.openWordSearch = function(moduleId) {
            currentStudyMode = 'wordsearch';
            currentWordSearchList = wordSearchData[moduleId] || [];
            wordSearchStreak = 0;
            usedWordSearchIndices = [];
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Caça-Palavras";
            document.getElementById('study-instruction').textContent = "";
            startNewWordSearch();
        }

        function startNewWordSearch() {
            if (wsTimer) clearInterval(wsTimer);
            
            // Get available indices (not used yet)
            let availableIndices = [];
            for (let i = 0; i < currentWordSearchList.length; i++) {
                if (!usedWordSearchIndices.includes(i)) availableIndices.push(i);
            }
            // If all used, reset the list
            if (availableIndices.length === 0) {
                usedWordSearchIndices = [];
                availableIndices = currentWordSearchList.map((_, i) => i);
            }
            
            const puzzleIdx = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            usedWordSearchIndices.push(puzzleIdx);
            currentWordSearch = currentWordSearchList[puzzleIdx];
            wsWords = [...currentWordSearch.words];
            wsFoundWords = [];
            wsSelectedCells = [];
            wsGrid = generateWordSearchGrid(wsWords, 10);
            wsTimeLeft = WS_TIME_LIMIT;
            renderWordSearchStreakBar();
            renderWordSearch();
            wsTimer = setInterval(() => {
                wsTimeLeft--;
                updateWsTimer();
                if (wsTimeLeft <= 0) {
                    clearInterval(wsTimer);
                    wsTimer = null;
                    wordSearchStreak = 0;
                    renderWordSearchStreakBar();
                    document.getElementById('wordsearch-result').innerHTML = `
                        <div class="text-red-600 font-bold text-lg mb-4">Tempo esgotado!</div>
                        <button class="action-button" onclick="startNewWordSearch()">Tentar Novamente</button>`;
                }
            }, 1000);
        }

        function playTimerBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
        }

        function updateWsTimer() {
            const timerEl = document.getElementById('ws-timer');
            if (timerEl) {
                const isLow = wsTimeLeft <= 15;
                const bgColor = isLow ? 'bg-red-500' : '';
                const textColor = isLow ? 'text-white' : 'text-stone-800';
                timerEl.className = `${bgColor} ${textColor} px-4 py-2 rounded-lg font-bold text-lg mb-5`;
                timerEl.style.backgroundColor = isLow ? '' : '#F1D24B';
                timerEl.textContent = `TEMPO RESTANTE: ${wsTimeLeft}s`;
                if (isLow && wsTimeLeft > 0) {
                    playTimerBeep();
                }
            }
        }

        function renderWordSearchStreakBar() {
            const container = document.getElementById('streak-bar-container');
            container.classList.remove('hidden');
            const progress = Math.min(wordSearchStreak, WORDSEARCH_STREAK_GOAL);
            const percentage = (progress / WORDSEARCH_STREAK_GOAL) * 100;
            const isComplete = wordSearchStreak >= WORDSEARCH_STREAK_GOAL;
            container.innerHTML = `
                <div class="streak-bar-bg">
                    <div class="streak-bar-fill ${isComplete ? 'complete' : ''}" style="width: ${percentage}%"></div>
                </div>
                <p class="text-sm text-stone-500 mt-2 text-center">
                    ${isComplete ? '<svg class="inline w-5 h-5 mr-1 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Streak completo! Tire um print!' : `Complete ${WORDSEARCH_STREAK_GOAL} puzzles seguidos: ${progress}/${WORDSEARCH_STREAK_GOAL}`}
                </p>`;
        }

        function renderWordSearch() {
            const area = document.getElementById('study-content-area');
            const size = wsGrid.length;
            
            let gridHtml = `<div class="wordsearch-grid" style="grid-template-columns: repeat(${size}, 1fr)">`;
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    gridHtml += `<div class="wordsearch-cell" data-row="${r}" data-col="${c}" 
                        onmousedown="wsStartSelect(${r},${c})" 
                        onmouseenter="wsContinueSelect(${r},${c})"
                        ontouchstart="wsStartSelect(${r},${c}); event.preventDefault();"
                        ontouchmove="wsTouchMove(event)">${wsGrid[r][c]}</div>`;
                }
            }
            gridHtml += '</div>';
            
            let wordsHtml = '<div class="wordsearch-words mt-4">';
            wsWords.forEach(word => {
                const foundClass = wsFoundWords.includes(word) ? 'found' : '';
                wordsHtml += `<span class="wordsearch-word ${foundClass}" data-word="${word}">${word}</span>`;
            });
            wordsHtml += '</div>';
            
            area.innerHTML = `
                <div class="flex flex-col items-center">
                    <div id="ws-timer" style="background-color: #F1D24B;" class="text-stone-800 px-4 py-2 rounded-lg font-bold text-lg mb-5">TEMPO RESTANTE: ${wsTimeLeft}s</div>
                    ${gridHtml}
                    ${wordsHtml}
                </div>
                <div id="wordsearch-result" class="mt-4 text-center"></div>
            `;
            
            document.addEventListener('mouseup', wsEndSelect);
            document.addEventListener('touchend', wsEndSelect);
        }

        window.wsStartSelect = function(r, c) {
            wsIsSelecting = true;
            wsSelectedCells = [{r, c}];
            updateWsSelection();
        }

        window.wsContinueSelect = function(r, c) {
            if (!wsIsSelecting) return;
            const last = wsSelectedCells[wsSelectedCells.length - 1];
            if (last.r === r && last.c === c) return;
            
            if (wsSelectedCells.length === 1) {
                wsSelectedCells.push({r, c});
            } else {
                const first = wsSelectedCells[0];
                const dr = Math.sign(wsSelectedCells[1].r - first.r);
                const dc = Math.sign(wsSelectedCells[1].c - first.c);
                const newDr = Math.sign(r - first.r);
                const newDc = Math.sign(c - first.c);
                
                if ((dr === 0 && dc === 0) || (newDr === dr && newDc === dc) || (newDr === 0 && newDc === 0)) {
                    const dist = Math.max(Math.abs(r - first.r), Math.abs(c - first.c));
                    const actualDr = dist > 0 ? (r - first.r) / dist : 0;
                    const actualDc = dist > 0 ? (c - first.c) / dist : 0;
                    
                    wsSelectedCells = [];
                    for (let i = 0; i <= dist; i++) {
                        wsSelectedCells.push({
                            r: first.r + Math.round(actualDr * i),
                            c: first.c + Math.round(actualDc * i)
                        });
                    }
                }
            }
            updateWsSelection();
        }

        window.wsTouchMove = function(event) {
            const touch = event.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('wordsearch-cell')) {
                const r = parseInt(element.dataset.row);
                const c = parseInt(element.dataset.col);
                wsContinueSelect(r, c);
            }
        }

        window.wsEndSelect = function() {
            if (!wsIsSelecting) return;
            wsIsSelecting = false;
            
            if (wsSelectedCells.length < 2) {
                wsSelectedCells = [];
                updateWsSelection();
                return;
            }
            
            let selectedWord = '';
            wsSelectedCells.forEach(cell => {
                selectedWord += wsGrid[cell.r][cell.c];
            });
            
            const reversedWord = selectedWord.split('').reverse().join('');
            
            let foundWord = null;
            if (wsWords.includes(selectedWord) && !wsFoundWords.includes(selectedWord)) {
                foundWord = selectedWord;
            } else if (wsWords.includes(reversedWord) && !wsFoundWords.includes(reversedWord)) {
                foundWord = reversedWord;
            }
            
            if (foundWord) {
                wsFoundWords.push(foundWord);
                wsSelectedCells.forEach(cell => {
                    const cellEl = document.querySelector(`.wordsearch-cell[data-row="${cell.r}"][data-col="${cell.c}"]`);
                    if (cellEl) cellEl.classList.add('found');
                });
                const wordEl = document.querySelector(`.wordsearch-word[data-word="${foundWord}"]`);
                if (wordEl) wordEl.classList.add('found');
                
                if (wsFoundWords.length === wsWords.length) {
                    clearInterval(wsTimer);
                    wsTimer = null;
                    wordSearchStreak++;
                    renderWordSearchStreakBar();
                    
                    setTimeout(() => {
                        if (wordSearchStreak >= WORDSEARCH_STREAK_GOAL) {
                            document.getElementById('study-content-area').innerHTML = `
                                <div class="flex flex-col items-center justify-center py-10">
                                    <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                                    <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                                    <p class="text-stone-500 mb-8">Você completou ${WORDSEARCH_STREAK_GOAL} caça-palavras seguidos!</p>
                                    <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                                    <button class="secondary-button mt-4" onclick="wordSearchStreak=0; startNewWordSearch()">Jogar Novamente</button>
                                </div>`;
                        } else {
                            document.getElementById('wordsearch-result').innerHTML = `
                                <div class="text-green-600 font-bold text-lg mb-4"><svg class="inline w-5 h-5 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Parabéns! Todas as palavras encontradas!</div>
                                <button class="action-button" onclick="startNewWordSearch()">Próximo Caça-Palavras</button>`;
                        }
                    }, 500);
                }
            }
            
            wsSelectedCells = [];
            updateWsSelection();
        }

        function updateWsSelection() {
            document.querySelectorAll('.wordsearch-cell').forEach(cell => {
                if (!cell.classList.contains('found')) {
                    cell.classList.remove('selected');
                }
            });
            wsSelectedCells.forEach(cell => {
                const cellEl = document.querySelector(`.wordsearch-cell[data-row="${cell.r}"][data-col="${cell.c}"]`);
                if (cellEl && !cellEl.classList.contains('found')) {
                    cellEl.classList.add('selected');
                }
            });
        }

        window.toggleChunk = function(index) {
            const text = document.getElementById(`chunk-pt-${index}`);
            text.classList.toggle('translation-hidden');
            text.classList.toggle('translation-visible');
        }

        function renderStreakBar() {
            const container = document.getElementById('streak-bar-container');
            const title = document.getElementById('study-title').textContent;
            if (title.includes("Ditado") || title.includes("Scramble") || title.includes("Forca") || document.getElementById('study-instruction').textContent.includes("Ordene")) {
                container.classList.remove('hidden');
                const progress = Math.min(currentStreak, STREAK_GOAL);
                const percentage = (progress / STREAK_GOAL) * 100;
                const isComplete = currentStreak >= STREAK_GOAL;
                container.innerHTML = `
                    <div class="streak-bar-wrapper">
                        <div class="streak-label text-center">
                            ${isComplete ? '<svg class="inline w-5 h-5 mr-1 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Streak completo! Tire um print!' : `Complete ${STREAK_GOAL} acertos seguidos: ${progress}/${STREAK_GOAL}`}
                        </div>
                        <div class="streak-bar-bg">
                            <div class="streak-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            } else {
                container.classList.add('hidden');
            }
        }

        function renderChunksGrid(data) {
            const area = document.getElementById('study-content-area');
            area.innerHTML = `<div class="chunks-grid shadow-lg">
                <div class="chunks-header">Chunks</div>
                <div class="chunks-header">Traduções</div>
                ${data.map((item, index) => `
                <div class="chunks-cell chunks-cell-en">
                    <button onclick="speakText('${item.en.replace(/'/g, "\\'")}')" class="p-1 mr-2 rounded-full hover:bg-primary/10 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    </button>
                    <span>${item.en}</span>
                </div>
                <div class="chunks-cell chunks-cell-pt">
                    <input type="text" id="chunk-input-${index}" class="chunk-input" placeholder="Digite a tradução..." data-answer="${item.pt.replace(/"/g, '&quot;')}" onkeypress="if(event.key==='Enter')checkChunk(${index})">
                    <button onclick="checkChunk(${index})" class="chunk-check-btn">OK</button>
                </div>`).join('')}</div>`;
        }

        window.checkChunk = function(index) {
            const input = document.getElementById('chunk-input-' + index);
            const answer = input.dataset.answer;
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = answer.toLowerCase();
            
            if (input.disabled) return;
            
            if (normalizeAnswer(userAnswer, correctAnswer)) {
                input.classList.remove('wrong');
                input.classList.add('correct');
                input.value = answer;
                input.disabled = true;
                playCorrectSound();
            } else {
                input.classList.remove('correct');
                input.classList.add('wrong');
                playIncorrectSound();
            }
        }

        async function renderListeningBoard(items, useWideGrid = false) {
            const area = document.getElementById('study-content-area');
            const gridClass = useWideGrid ? 'listening-grid-wide' : 'listening-grid';
            area.innerHTML = `<div class="${gridClass}"></div>`;
            const grid = area.querySelector('.' + gridClass);
            items.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                const phonetic = item.p ? `<span class="phonetic-text">${item.p}</span>` : '';
                btn.innerHTML = `<span class="main-text">${item.n || item}</span>${phonetic}<span class="sub-text">${item.w || ''}</span>`;
                btn.onclick = async () => {
                    if (btn.classList.contains('playing')) return;
                    btn.classList.add('playing');
                    const audio = await fetchTTSAudio(item.w || item);
                    if (audio) { 
                        await audio.play(); 
                        btn.classList.remove('playing');
                    } else {
                        btn.classList.remove('playing');
                    }
                };
                grid.appendChild(btn);
            });
        }

        function renderFlashcards() {
            const area = document.getElementById('study-content-area');
            const update = () => {
                const card = currentShuffledCards[currentFlashcardIdx];
                const isText = /[a-zA-Z0-9]/.test(card.front); 
                const frontSize = isText ? 'text-4xl' : 'text-9xl';
                area.innerHTML = `
                    <div class="flashcard-container" onclick="flipAndSpeak(this, '${card.back.replace(/'/g, "\\'")}')">
                        <div class="flashcard"><div class="flashcard-front"><span class="text-xs absolute top-8 opacity-50 font-bold tracking-widest">PORTUGUESE</span><span class="${frontSize} font-bold mt-4">${card.front}</span></div>
                        <div class="flashcard-back"><span class="text-xs absolute top-8 opacity-50 font-bold tracking-widest">ENGLISH</span><span class="text-3xl font-bold mt-4">${card.back}</span>
                        <button class="mt-4 p-2 rounded-full bg-primary/20 hover:bg-primary/30 transition" onclick="event.stopPropagation(); speakText('${card.back.replace(/'/g, "\\'")}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                        </button></div></div>
                    </div>
                    <div class="flex items-center justify-between max-w-xs mx-auto mt-4">
                        <button class="secondary-button p-3 rounded-full" onclick="changeFC(-1)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg></button>
                        <span class="font-bold text-stone-400">${currentFlashcardIdx + 1} / ${currentShuffledCards.length}</span>
                        <button class="secondary-button p-3 rounded-full" onclick="changeFC(1)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>`;
            };
            window.changeFC = (dir) => { currentFlashcardIdx = (currentFlashcardIdx + dir + currentShuffledCards.length) % currentShuffledCards.length; update(); };
            window.flipAndSpeak = (el, text) => {
                const flashcard = el.querySelector('.flashcard');
                const wasFlipped = flashcard.classList.contains('flipped');
                flashcard.classList.toggle('flipped');
                if (!wasFlipped) { speakText(text); }
            };
            update();
        }

        function renderMistake() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= STREAK_GOAL) {
                 area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="text-6xl mb-4">📸</div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                        <p class="text-stone-500 mb-8">Tire um print e envie para o seu teacher!</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; currentShuffledData=shuffle([...currentShuffledData]); renderMistake()">Reiniciar</button>
                    </div>`;
                return;
            }

            const item = currentShuffledData[currentIdx];
            const words = item.sentence.split(' ');
            area.innerHTML = `
                <div class="text-2xl font-bold mb-8 leading-loose">
                    ${words.map(w => `<span class="mistake-word" onclick="checkMistakeClick(this, '${w}', '${item.wrong}', '${item.correct}', '${item.rationale}')">${w}</span>`).join(' ')}
                </div>
                <div id="mistake-fb" class="hidden p-4 rounded-xl mb-4 text-left"></div>
                <button class="action-button w-full hidden" id="mistake-next" onclick="window.nextRound(renderMistake)">Próxima Frase</button>
            `;
        }

        window.checkMistakeClick = function(el, w, wrong, correct, rationale) {
            const clean = w.replace(/[.,]/g, "");
            const fb = document.getElementById('mistake-fb');
            if (clean === wrong) {
                el.classList.add('correct-choice');
                fb.innerHTML = `<p class="font-bold text-green-800">Correct! O erro era "${wrong}". O certo é "${correct}".</p><p class="text-sm text-green-700 mt-2">${rationale}</p>`;
                fb.className = "p-4 rounded-xl bg-green-100 block mb-4";
                document.getElementById('mistake-next').classList.remove('hidden');
                document.querySelectorAll('.mistake-word').forEach(m => m.onclick = null);
                currentStreak++;
            } else {
                el.classList.add('wrong-choice');
                currentStreak = 0; // Reset on error
            }
            renderStreakBar();
        };

        function renderScramble() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= STREAK_GOAL) {
                area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                        <p class="text-stone-500 mb-8">Tire um print e envie para o seu teacher para mostrar que você arrasou!</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar ao Menu</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; currentIdx=0; currentShuffledData=shuffle([...currentShuffledData]); renderScramble()">Jogar Novamente</button>
                    </div>
                `;
                return;
            }

            const item = currentShuffledData[currentIdx % currentShuffledData.length];
            const totalSentences = currentShuffledData.length;
            const currentSentence = (currentIdx % totalSentences) + 1;
            scrambleResult = [];
            const shuffled = shuffle([...item.words]);
            area.innerHTML = `
                <div class="text-center mb-4">
                    <span class="inline-block bg-primary/10 text-primary px-4 py-2 rounded-full font-bold text-sm">
                        Frase ${currentSentence} / ${totalSentences}
                    </span>
                </div>
                <div id="scramble-fb" class="hidden p-4 rounded-xl mb-6 text-center font-bold"></div>
                <div class="scramble-dropzone mb-6 flex flex-wrap justify-center gap-2 min-h-[60px]" id="scramble-res"><span class="text-stone-400">Clique nas palavras para formar a frase...</span></div>
                <div class="flex flex-wrap justify-center gap-3 mb-6" id="scramble-words">
                    ${shuffled.map((w, i) => `<button class="scramble-word" data-idx="${i}" onclick="pickWord(this, '${w.replace(/'/g, "&#39;")}', '${item.full.replace(/'/g, "&#39;")}')">${w}</button>`).join('')}
                </div>
                <button class="action-button w-full hidden" id="scramble-next" onclick="window.nextRound(renderScramble)">Próxima Frase</button>
            `;
        }

        window.pickWord = function(btn, w, full) {
            const decodedWord = w.replace(/&#39;/g, "'");
            speakText(decodedWord);
            const idx = btn.getAttribute('data-idx');
            scrambleResult.push({ word: decodedWord, idx: idx });
            btn.style.visibility = 'hidden';
            updateScrambleResult(full);
        };

        window.unpickWord = function(idx, full) {
            scrambleResult = scrambleResult.filter(item => item.idx !== idx);
            const btn = document.querySelector(`#scramble-words button[data-idx="${idx}"]`);
            if (btn) btn.style.visibility = 'visible';
            updateScrambleResult(full);
        };

        function updateScrambleResult(full) {
            const resArea = document.getElementById('scramble-res');
            const decodedFull = full.replace(/&#39;/g, "'");
            if (scrambleResult.length === 0) {
                resArea.innerHTML = '<span class="text-stone-400">Clique nas palavras para formar a frase...</span>';
                return;
            }
            resArea.innerHTML = scrambleResult.map(item => 
                `<button class="scramble-word-selected" onclick="unpickWord('${item.idx}', '${full.replace(/'/g, "&#39;")}')">${item.word}</button>`
            ).join('');
            
            if (scrambleResult.length === decodedFull.split(' ').length) {
                const fb = document.getElementById('scramble-fb');
                const resultText = scrambleResult.map(i => i.word).join(' ');
                if (resultText.toLowerCase() === decodedFull.toLowerCase()) { 
                    currentStreak++; 
                    renderStreakBar(); 
                    fb.innerHTML = `<span class="text-sm">Perfect! Frase correta.</span>`;
                    fb.className = "p-4 rounded-xl bg-green-100 text-green-800 block mb-4";
                    document.getElementById('scramble-next').classList.remove('hidden');
                    resArea.querySelectorAll('button').forEach(b => b.onclick = null);
                } else { 
                    currentStreak = 0; 
                    renderStreakBar(); 
                    fb.innerHTML = `Errou! Tente de novo. <button class="text-xs opacity-70 underline ml-2" onclick="renderScramble()">reset</button>`;
                    fb.className = "p-4 rounded-xl bg-red-100 text-red-800 block mb-4";
                }
            }
        };

        function renderDictation() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= STREAK_GOAL) {
                 area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Excelente!</h2>
                        <p class="text-stone-500 mb-8">Você completou o streak de 5 ditados.</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; currentIdx=0; currentShuffledData=shuffle([...currentShuffledData]); renderDictation()">Reiniciar</button>
                    </div>
                `;
                return;
            }

            const item = currentShuffledData[currentIdx % currentShuffledData.length];
            const totalItems = currentShuffledData.length;
            const currentItem = (currentIdx % totalItems) + 1;
            area.innerHTML = `
                <div class="flex flex-col items-center gap-4">
                    <div class="text-center">
                        <span class="inline-block bg-primary/10 text-primary px-4 py-2 rounded-full font-bold text-sm">
                            ${isNumberComboMode ? 'Sequência' : 'Palavra'} ${currentItem} / ${totalItems}
                        </span>
                    </div>
                    <button id="dict-play" class="w-24 h-24 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center hover:from-indigo-200 hover:to-purple-200 transition-all shadow-lg transform hover:scale-105" onclick="playDictation('${item}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                    </button>
                    ${isNumberComboMode ? '<p class="text-sm text-stone-400">Ex: one two three ou 1 2 3</p>' : ''}
                    <input type="text" id="dict-input" class="dictation-input" ${isNumberComboMode ? 'style="width:320px"' : ''} placeholder="${isNumberComboMode ? 'Ex: one two three' : 'Digite aqui...'}" autocomplete="off" onkeypress="if(event.key==='Enter')checkDictation('${item}')">
                    <button class="action-button max-w-xs" onclick="checkDictation('${item}')">Verificar</button>
                    <div id="dict-fb" class="hidden p-4 rounded-xl font-bold text-lg"></div>
                    <button class="secondary-button hidden" id="dict-next" onclick="window.nextRound(renderDictation)">Próxima Palavra</button>
                </div>
            `;
        }

        function timeToWords(timeStr) {
            const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
            if (!match) return timeStr;
            const h = parseInt(match[1], 10);
            const m = parseInt(match[2], 10);
            const hourWords = ['twelve', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve'];
            const hourWord = hourWords[h % 12];
            if (m === 0) return `${hourWord} o'clock`;
            if (m === 15) return `quarter past ${hourWord}`;
            if (m === 30) return `half past ${hourWord}`;
            if (m === 45) {
                const nextHour = hourWords[(h + 1) % 12];
                return `quarter to ${nextHour}`;
            }
            const minWord = m < 10 ? `oh ${['zero','one','two','three','four','five','six','seven','eight','nine'][m]}` : m.toString();
            return `${hourWord} ${minWord}`;
        }

        window.playDictation = async function(text) {
             const btn = document.getElementById('dict-play');
             btn.classList.add('animate-pulse');
             
             // Convert time format to spoken words
             const spokenText = text.includes(':') ? timeToWords(text) : text;
             
             if (isSpellingMode) {
                 const letters = text.split('');
                 for (let i = 0; i < letters.length; i++) {
                     await speakText(letters[i].toLowerCase());
                     if (i < letters.length - 1) {
                         await new Promise(resolve => setTimeout(resolve, 400));
                     }
                 }
                 btn.classList.remove('animate-pulse');
             } else if (isNumberComboMode) {
                 const numbers = text.split(' ');
                 for (let i = 0; i < numbers.length; i++) {
                     const audio = await fetchTTSAudio(numbers[i]);
                     if (audio) await audio.play();
                     if (i < numbers.length - 1) {
                         await new Promise(resolve => setTimeout(resolve, 600));
                     }
                 }
                 btn.classList.remove('animate-pulse');
             } else {
                 const audio = await fetchTTSAudio(spokenText);
                 if (audio) { 
                     await audio.play(); 
                     btn.classList.remove('animate-pulse'); 
                 } else {
                     btn.classList.remove('animate-pulse'); 
                 }
             }
        }

        // Number mappings for dictation (extenso <-> numeral)
        const numberMap = {
            'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
            'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
            'eleven': '11', 'twelve': '12', 'thirteen': '13', 'fourteen': '14', 'fifteen': '15',
            'sixteen': '16', 'seventeen': '17', 'eighteen': '18', 'nineteen': '19', 'twenty': '20',
            'first': '1st', 'second': '2nd', 'third': '3rd', 'fourth': '4th', 'fifth': '5th',
            'sixth': '6th', 'seventh': '7th', 'eighth': '8th', 'ninth': '9th', 'tenth': '10th'
        };
        const reverseNumberMap = Object.fromEntries(Object.entries(numberMap).map(([k, v]) => [v, k]));

        function normalizeAnswer(val, correct) {
            val = val.toLowerCase().trim().replace(/\s+/g, ' ');
            correct = correct.toLowerCase().trim();
            if (val === correct) return true;
            // Check if user typed number instead of word
            if (numberMap[correct] && val === numberMap[correct]) return true;
            // Check if user typed word instead of number
            if (reverseNumberMap[correct] && val === reverseNumberMap[correct]) return true;
            // Handle multi-number combos (e.g. "one two three" vs "1 2 3" or mixed)
            if (correct.includes(' ')) {
                const correctParts = correct.split(' ');
                const valParts = val.split(' ');
                if (correctParts.length === valParts.length) {
                    const allMatch = correctParts.every((cp, i) => {
                        const vp = valParts[i];
                        if (vp === cp) return true;
                        if (numberMap[cp] && vp === numberMap[cp]) return true;
                        if (reverseNumberMap[cp] && vp === reverseNumberMap[cp]) return true;
                        return false;
                    });
                    if (allMatch) return true;
                }
            }
            // For letters (A, B, C...) accept lowercase
            if (correct.length === 1 && val === correct) return true;
            // For time formats - normalize and compare
            if (correct.includes(':')) {
                const normalizeTime = (t) => {
                    t = t.replace(/[hH]/, ':').replace(/\s+/g, '');
                    const match = t.match(/^(\d{1,2}):?(\d{2})?$/);
                    if (match) {
                        const h = parseInt(match[1], 10);
                        const m = match[2] ? parseInt(match[2], 10) : 0;
                        return `${h}:${m.toString().padStart(2, '0')}`;
                    }
                    return t;
                };
                if (normalizeTime(val) === normalizeTime(correct)) return true;
            }
            return false;
        }

        window.checkDictation = function(correct) {
            const input = document.getElementById('dict-input');
            const verifyBtn = document.querySelector('#study-content-area .action-button');
            
            // Prevent multiple clicks
            if (verifyBtn.disabled) return;
            verifyBtn.disabled = true;
            verifyBtn.classList.add('opacity-50', 'cursor-not-allowed');
            input.disabled = true;
            
            const val = input.value.toLowerCase().trim();
            const fb = document.getElementById('dict-fb');

            if (normalizeAnswer(val, correct)) {
                input.classList.add('correct');
                fb.className = "hidden";
                document.getElementById('dict-next').classList.remove('hidden');
                currentStreak++;
                playCorrectSound();
            } else {
                input.classList.add('wrong');
                fb.innerHTML = `<button class="action-button" onclick="currentStreak=0; currentIdx=0; currentShuffledData=shuffle([...currentShuffledData]); renderDictation()">Começar Novamente</button>`;
                fb.className = "mt-4 block";
                currentStreak = 0;
                playIncorrectSound();
            }
            renderStreakBar();
        }

        window.nextRound = function(cb) {
            currentIdx = (currentIdx + 1) % currentShuffledData.length;
            cb();
        };

        function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
        function scrollToModule(id) { document.getElementById(`module-${id}`).scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        window.scrollToModule = scrollToModule;

        window.onload = async function() { 
            const firebaseReady = await initFirebase();
            if (firebaseReady) {
                firebaseAuth.onAuthStateChanged(onAuthStateChanged);
            } else {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-wrapper').classList.remove('hidden');
                document.getElementById('user-info-badge').style.display = 'none';
                renderDashboard();
            }
        };
    </script>
</body>
</html>
