<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP | HOMEWORK - STARTER 1</title>
    <!-- SLAP Favicon -->
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: DM Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            background-color: #f4f7f9;
            min-height: 100vh;
            margin: 0;
            scroll-behavior: smooth;
        }
        
        #main-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.5rem 1.5rem; /* Minimized top padding */
        }

        /* Login Gate - Fixed Centering */
        #login-gate {
            background-color: #44403c;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }
        .login-card {
            background-color: white;
            color: #44403c;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .login-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
        }
        .login-input:focus { border-color: #8671d1; }

        .action-button {
             background-color: #F1D24B; 
             color: #44403c;
             padding: 0.75rem 1rem; 
             border-radius: 0.75rem; 
             font-weight: 700; 
             cursor: pointer; 
             transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
             display: inline-flex;
             align-items: center;
             justify-content: center; 
             gap: 0.25rem;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover:not(:disabled) {
            background-color: #eab308;
            transform: translateY(-2px);
        }
        .action-button:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .secondary-button {
            background-color: #44403c;
            color: white;
            padding: 0.75rem 1rem; 
            border-radius: 0.75rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        .secondary-button:hover:not(:disabled) { background-color: #292524; transform: translateY(-1px); }

        .level-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .level-card:not(.locked):hover { transform: scale(1.02); border-color: #8671d1; }
        .level-card.locked { opacity: 0.6; background-color: #f9fafb; cursor: not-allowed; }

        .module-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #8671d1;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }

        /* HM Shortcut Boxes - Compact */
        #hm-shortcuts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            justify-content: center;
            margin-bottom: 1.5rem;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
        }
        .hm-box {
            width: 54px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.4rem;
            font-size: 0.65rem;
            font-weight: 800;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background-color: white;
            flex-shrink: 0;
        }
        .hm-box-active { color: #8671d1; border-color: #8671d1; }
        .hm-box-active:hover { background-color: #f3f0ff; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(134, 113, 209, 0.2); }
        .hm-box-locked { background-color: #f1f5f9; color: #cbd5e1; cursor: not-allowed; border-color: #e2e8f0; }

        /* Chunks Grid */
        .chunks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            overflow: hidden;
            background-color: white;
            text-align: left;
        }
        .chunks-header { background-color: #44403c; color: white; padding: 1rem; font-weight: 700; text-transform: uppercase; }
        .chunks-cell { padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; }
        .chunks-cell-en { font-weight: 700; color: #1e1b4b; background-color: #f8fafc; }
        .chunks-cell-pt { font-style: italic; color: #475569; justify-content: space-between; }
        .translation-hidden { filter: blur(5px); opacity: 0.3; user-select: none; transition: all 0.3s; }
        .translation-visible { filter: blur(0); opacity: 1; user-select: text; }

        /* Lock Overlay */
        .lock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background-color: rgba(68, 64, 60, 0.8);
            border-radius: 50%;
            padding: 1rem;
            pointer-events: none;
        }

        /* Flashcards */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 400px; height: 300px; margin: 0.5rem auto; cursor: pointer; }
        .flashcard { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-radius: 1.5rem; 
            padding: 1rem; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
        }
        .flashcard-front { background-color: #8671d1; color: white; }
        .flashcard-back { background-color: #F1D24B; color: #44403c; transform: rotateY(180deg); }

        /* CLEAN Listening Grid */
        .listening-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 0.75rem; 
            margin-top: 1rem; 
        }
        .number-btn { 
            background-color: white; 
            border: 2px solid #e5e7eb; 
            border-radius: 1rem; 
            padding: 1rem 0.5rem; 
            color: #44403c; 
            transition: all 0.2s; 
            cursor: pointer; 
            text-align: center; 
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            min-height: 80px;
        }
        .number-btn span.main-text {
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1;
        }
        .number-btn span.sub-text {
            font-size: 0.7rem;
            font-weight: 600;
            color: #8671d1;
            text-transform: uppercase;
            opacity: 0.9;
        }
        .number-btn:hover { border-color: #8671d1; transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .number-btn.playing { border-color: #F1D24B; background-color: #fffbeb; animation: pulse 1s infinite; }
        .ready-icon { position: absolute; top: 5px; right: 5px; color: #8671d1; opacity: 0.4; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    
    <!-- LOGIN GATE -->
    <div id="login-gate">
        <div class="login-card text-center">
            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" class="w-32 mx-auto mb-6">
            <h1 class="text-2xl font-bold mb-4 text-[#8671d1]">Grammar Access</h1>
            <p class="text-sm font-medium mb-6 text-stone-500">Digite a senha da sua cantora para entrar:</p>
            
            <form onsubmit="checkPassword(event)">
                <input type="password" id="password-input" class="login-input" placeholder="ex: ariana" required>
                <button type="submit" class="action-button w-full py-4 text-lg">Entrar</button>
                <p id="login-feedback" class="mt-4 text-red-600 hidden font-bold">Senha incorreta. Tente novamente.</p>
            </form>
        </div>
    </div>

    <div id="main-wrapper" class="hidden">
        <header class="py-2 border-b border-stone-200 mb-4 text-center">
            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" class="w-32 h-auto mx-auto">
            <h1 class="text-2xl font-bold text-stone-800 uppercase tracking-tight">HOMEWORK - STARTER 1</h1>
            <p class="text-sm text-stone-500 font-medium">Portal de Atividades Pr√°ticas</p>
        </header>

        <!-- HM Navigation Shortcuts -->
        <div id="hm-shortcuts-container"></div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="w-full">
            <div id="level-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- PRACTICE VIEW -->
        <div id="generator-view" class="hidden w-full">
            <button class="secondary-button mb-4" onclick="showDashboard()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Voltar
            </button>
            <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl mx-auto">
                <h2 class="text-xl font-bold text-stone-800 mb-4 text-center" id="current-hw-display"></h2>
                <div class="challenge-box mb-6 border-l-4 border-indigo-400 p-6 bg-slate-50">
                    <p id="main-question" class="text-lg font-bold text-slate-800"></p>
                </div>
                <div id="options-container" class="space-y-3"></div>
                <div id="rationale-display" class="hidden mt-6">
                    <div id="rationale-content" class="p-4 bg-amber-50 rounded-lg text-amber-900 mb-4 text-sm"></div>
                    <button class="action-button w-full" onclick="loadNextQuestion()">Pr√≥ximo Exerc√≠cio</button>
                </div>
            </div>
        </div>

        <!-- STUDY VIEW -->
        <div id="study-view" class="hidden w-full">
             <button class="secondary-button mb-4" onclick="showDashboard()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Voltar
            </button>
            <div class="bg-white p-6 rounded-2xl shadow-xl max-w-4xl mx-auto text-center">
                 <h2 class="text-xl font-bold text-stone-800 mb-1" id="study-title"></h2>
                 <p class="text-stone-500 mb-2 italic text-sm" id="study-instruction"></p>
                 <div id="preloading-status" class="text-xs text-blue-500 font-bold mb-4 h-4"></div>
                 <div id="study-content-area" class="p-0"></div>
            </div>
        </div>
    </div>
    
    <script>
        const apiKey = "AIzaSyAEGbckOywhDZ_unbK5cAxGdDKsnyEcu98"; 
        const audioCache = new Map();

        const aulaNames = [
            { id: 1, name: "Open House", hasHomework: false },
            { id: 2, name: "Feelings", hasHomework: true, specialMode: 'flashcards' },
            { id: 3, name: "Names & Greetings", hasHomework: true, specialMode: 'chunks' },
            { id: 4, name: "Numbers pt. 1", hasHomework: true, specialMode: 'listening', items: [
                {n: "1", w: "One"}, {n: "2", w: "Two"}, {n: "3", w: "Three"}, {n: "4", w: "Four"}, {n: "5", w: "Five"},
                {n: "6", w: "Six"}, {n: "7", w: "Seven"}, {n: "8", w: "Eight"}, {n: "9", w: "Nine"}, {n: "10", w: "Ten"},
                {n: "11", w: "Eleven"}, {n: "12", w: "Twelve"}, {n: "13", w: "Thirteen"}, {n: "14", w: "Fourteen"}, {n: "15", w: "Fifteen"},
                {n: "16", w: "Sixteen"}, {n: "17", w: "Seventeen"}, {n: "18", w: "Eighteen"}, {n: "19", w: "Nineteen"}, {n: "20", w: "Twenty"},
                {n: "22", w: "Twenty-two"}, {n: "30", w: "Thirty"}, {n: "35", w: "Thirty-five"}, {n: "40", w: "Forty"}, {n: "48", w: "Forty-eight"},
                {n: "50", w: "Fifty"}, {n: "51", w: "Fifty-one"}, {n: "60", w: "Sixty"}, {n: "64", w: "Sixty-four"}, {n: "70", w: "Seventy"},
                {n: "77", w: "Seventy-seven"}, {n: "80", w: "Eighty"}, {n: "86", w: "Eighty-six"}, {n: "90", w: "Ninety"}, {n: "99", w: "Ninety-nine"}
            ]},
            { id: 5, name: "Numbers pt. 2", hasHomework: true, specialMode: 'listening', items: [
                {n: "100", w: "One hundred"}, {n: "150", w: "One hundred and fifty"}, {n: "200", w: "Two hundred"}, {n: "300", w: "Three hundred"}, {n: "325", w: "Three hundred and twenty-five"},
                {n: "400", w: "Four hundred"}, {n: "500", w: "Five hundred"}, {n: "505", w: "Five hundred and five"}, {n: "600", w: "Six hundred"}, {n: "700", w: "Seven hundred"},
                {n: "800", w: "Eight hundred"}, {n: "900", w: "Nine hundred"}, {n: "1,000", w: "One thousand"}, {n: "1,200", w: "One thousand two hundred"}, {n: "2,000", w: "Two thousand"},
                {n: "4,000", w: "Four thousand"}, {n: "5,500", w: "Five thousand five hundred"}, {n: "10,000", w: "Ten thousand"}, {n: "10,500", w: "Ten thousand five hundred"}, {n: "20,000", w: "Twenty thousand"},
                {n: "30,000", w: "Thirty thousand"}, {n: "40,000", w: "Forty thousand"}, {n: "45,300", w: "Forty-five thousand three hundred"}, {n: "50,000", w: "Fifty thousand"}, {n: "60,000", w: "Sixty thousand"},
                {n: "70,000", w: "Seventy thousand"}, {n: "80,000", w: "Eighty thousand"}, {n: "90,000", w: "Ninety thousand"}
            ]},
            { id: 6, name: "Spelling", hasHomework: true, specialMode: 'listening', items: [
                {n: "A", w: "A", p: "/e…™/"}, {n: "B", w: "B", p: "/biÀê/"}, {n: "C", w: "C", p: "/siÀê/"}, {n: "D", w: "D", p: "/diÀê/"}, {n: "E", w: "E", p: "/iÀê/"},
                {n: "F", w: "F", p: "/…õf/"}, {n: "G", w: "G", p: "/d íiÀê/"}, {n: "H", w: "H", p: "/e…™t É/"}, {n: "I", w: "I", p: "/a…™/"}, {n: "J", w: "J", p: "/d íe…™/"},
                {n: "K", w: "K", p: "/ke…™/"}, {n: "L", w: "L", p: "/…õl/"}, {n: "M", w: "M", p: "/…õm/"}, {n: "N", w: "N", p: "/…õn/"}, {n: "O", w: "O", p: "/o ä/"},
                {n: "P", w: "P", p: "/piÀê/"}, {n: "Q", w: "Q", p: "/kjuÀê/"}, {n: "R", w: "R", p: "/…ëÀêr/"}, {n: "S", w: "S", p: "/…õs/"}, {n: "T", w: "T", p: "/tiÀê/"},
                {n: "U", w: "U", p: "/juÀê/"}, {n: "V", w: "V", p: "/viÀê/"}, {n: "W", w: "W", p: "/Ààd åb…ôljuÀê/"}, {n: "X", w: "X", p: "/…õks/"}, {n: "Y", w: "Y", p: "/wa…™/"}, {n: "Z", w: "Z", p: "/ziÀê/"}
            ]},
            { id: 7, name: "Ordinal Numbers", hasHomework: true, specialMode: 'listening', items: [
                {n: "1st", w: "First"}, {n: "2nd", w: "Second"}, {n: "3rd", w: "Third"}, {n: "4th", w: "Fourth"}, {n: "5th", w: "Fifth"},
                {n: "6th", w: "Sixth"}, {n: "7th", w: "Seventh"}, {n: "8th", w: "Eighth"}, {n: "9th", w: "Ninth"}, {n: "10th", w: "Tenth"},
                {n: "11th", w: "Eleventh"}, {n: "12th", w: "Twelfth"}, {n: "13th", w: "Thirteenth"}, {n: "14th", w: "Fourteenth"}, {n: "15th", w: "Fifteenth"},
                {n: "20th", w: "Twentieth"}, {n: "21st", w: "Twenty-first"}, {n: "22nd", w: "Twenty-second"}, {n: "30th", w: "Thirtieth"}, {n: "31st", w: "Thirty-first"},
                {n: "40th", w: "Fortieth"}, {n: "45th", w: "Forty-fifth"}, {n: "50th", w: "Fiftieth"}, {n: "58th", w: "Fifty-eighth"}, 
                {n: "60th", w: "Sixtieth"}, {n: "63rd", w: "Sixty-third"}, {n: "70th", w: "Seventieth"}, {n: "77th", w: "Seventy-seventh"},
                {n: "80th", w: "Eightieth"}, {n: "89th", w: "Eighty-ninth"}, {n: "90th", w: "Ninetieth"}
            ]},
            { id: 8, name: "Basic Verbs", hasHomework: true },
            { id: 9, name: "Basic Adjectives", hasHomework: true },
            { id: 10, name: "Demonstrative Pronouns", hasHomework: true },
            { id: 11, name: "Verb to be", hasHomework: true },
            { id: 12, name: "Countries and Nationalities", hasHomework: true, specialMode: 'flashcards' },
            { id: 13, name: "Neighborhood", hasHomework: true },
            { id: 14, name: "Family Members", hasHomework: true },
            { id: 15, name: "Midterm Test", hasHomework: false },
            { id: 16, name: "Can e Can't", hasHomework: true },
            { id: 17, name: "Midterm Test Correction", hasHomework: false },
            { id: 18, name: "Simple Present pt. 1", hasHomework: true },
            { id: 19, name: "Simple Present pt. 2", hasHomework: true },
            { id: 20, name: "Object Pronouns", hasHomework: true },
            { id: 21, name: "Likes and Dislikes", hasHomework: true },
            { id: 22, name: "Free Time Activities", hasHomework: true },
            { id: 23, name: "Months and Holidays", hasHomework: true, specialMode: 'listening', thirdBtn: 'flashcards', items: [
                {n: "Jan", w: "January"}, {n: "Feb", w: "February"}, {n: "Mar", w: "March"}, {n: "Apr", w: "April"},
                {n: "May", w: "May"}, {n: "Jun", w: "June"}, {n: "Jul", w: "July"}, {n: "Aug", w: "August"},
                {n: "Sep", w: "September"}, {n: "Oct", w: "October"}, {n: "Nov", w: "November"}, {n: "Dec", w: "December"}
            ]},
            { id: 24, name: "Possessive Adjectives", hasHomework: true },
            { id: 25, name: "Possessive Pronouns", hasHomework: true },
            { id: 26, name: "Foods and Fruits", hasHomework: true, specialMode: 'flashcards' },
            { id: 27, name: "Presentation", hasHomework: false },
            { id: 28, name: "Hours", hasHomework: true, specialMode: 'flashcards' },
            { id: 29, name: "Kahoot Review", hasHomework: false },
            { id: 30, name: "Listening Test", hasHomework: false },
            { id: 31, name: "Grammar Test", hasHomework: false },
            { id: 32, name: "GT e LT Review", hasHomework: false },
            { id: 33, name: "OT Review", hasHomework: false },
            { id: 34, name: "Oral Test Day 1", hasHomework: false },
            { id: 35, name: "Oral Test Day 2", hasHomework: false },
            { id: 36, name: "General Feedback", hasHomework: false }
        ];

        const flashcardsData = {
            2: [{ front: "Feliz", back: "Happy" }, { front: "Triste", back: "Sad" }, { front: "Bravo(a)", back: "Angry" }],
            12: [{ front: "üáßüá∑", back: "Brazil / Brazilian" }, { front: "üá∫üá∏", back: "USA / American" }],
            23: [{ front: "Natal", back: "Christmas" }, { front: "Ano Novo", back: "New Year's Day" }, { front: "P√°scoa", back: "Easter" }, { front: "Dia das M√£es", back: "Mother's Day" }, { front: "Dia dos Pais", back: "Father's Day" }],
            26: [{ front: "üçé", back: "Apple" }, { front: "üçå", back: "Banana" }, { front: "üçï", back: "Pizza" }, { front: "ü•¶", back: "Broccoli" }, { front: "ü•ï", back: "Carrot" }, { front: "ü•©", back: "Steak" }, { front: "üçö", back: "Rice" }, { front: "üç¶", back: "Ice cream" }],
            28: [{ front: "08:00", back: "Eight o'clock" }, { front: "08:30", back: "Half past eight" }]
        };

        const chunksData = {
            3: [
                { en: "What's your name?", pt: "Qual √© o seu nome?" },
                { en: "What's your first name?", pt: "Qual √© o seu primeiro nome?" },
                { en: "What's your middle name?", pt: "Qual √© o seu nome do meio?" },
                { en: "What's your nickname?", pt: "Qual √© o seu apelido?" },
                { en: "What's your last name?", pt: "Qual √© o seu sobrenome?" }
            ]
        };

        const mockQuestions = {
            11: [{ q: "She ___ a student.", options: [{text: "is", isCorrect: true}, {text: "am", isCorrect: false}], rationale: "She usa 'is'." }]
        };

        let currentQuestion = null;
        let questionsPool = [];
        let answerSubmitted = false;
        let currentFlashcardIdx = 0;
        let currentShuffledCards = [];

        async function fetchTTSAudio(text) {
            if (audioCache.has(text)) return audioCache.get(text);
            const payload = {
                contents: [{ parts: [{ text: `Say clearly: ${text}` }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } },
                model: "gemini-2.5-flash-preview-tts"
            };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("API error");
                const result = await response.json();
                const pcmData = result.candidates[0].content.parts[0].inlineData.data;
                const wavBlob = pcmToWav(pcmData, 24000);
                const audio = new Audio(URL.createObjectURL(wavBlob));
                audioCache.set(text, audio);
                return audio;
            } catch (error) { return null; }
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const binaryString = atob(base64Pcm);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            const buffer = new ArrayBuffer(44 + bytes.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data'); view.setUint32(40, bytes.length, true);
            for (let i = 0; i < bytes.length; i++) view.setUint8(44 + i, bytes[i]);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        window.checkPassword = function(e) {
            e.preventDefault();
            if (document.getElementById('password-input').value.toLowerCase().trim() === 'ariana') {
                document.getElementById('login-gate').style.display = 'none';
                document.getElementById('main-wrapper').classList.remove('hidden');
                renderDashboard();
            } else { 
                document.getElementById('login-feedback').classList.remove('hidden'); 
            }
        };

        window.showDashboard = function() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('hm-shortcuts-container').classList.remove('hidden'); // SHOW SHORTCUTS
            document.getElementById('generator-view').classList.add('hidden');
            document.getElementById('study-view').classList.add('hidden');
        };

        window.scrollToModule = function(id) {
            const el = document.getElementById(`module-${id}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function renderDashboard() {
            // Render Shortcuts
            const shortcuts = document.getElementById('hm-shortcuts-container');
            shortcuts.innerHTML = aulaNames.map(aula => {
                const label = `HM ${String(aula.id).padStart(2, '0')}`;
                return aula.hasHomework 
                    ? `<div class="hm-box hm-box-active" onclick="scrollToModule(${aula.id})">${label}</div>`
                    : `<div class="hm-box hm-box-locked"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div>`;
            }).join('');

            const container = document.getElementById('level-cards-container');
            container.innerHTML = aulaNames.map(aula => {
                let studyLabel = '';
                if (aula.specialMode === 'flashcards') studyLabel = 'FLASHCARDS';
                else if (aula.specialMode === 'listening') studyLabel = 'LISTENING';
                else if (aula.specialMode === 'chunks') studyLabel = 'CHUNKS';

                const sBtn = studyLabel ? `<button class="secondary-button flex-1 text-xs" onclick="openStudy(${aula.id})">${studyLabel}</button>` : '';
                const tBtn = (aula.id === 23) ? `<button class="secondary-button flex-1 text-xs" onclick="openFlashcards(23)">FLASHCARDS</button>` : '';

                return `
                <div class="level-card relative ${!aula.hasHomework ? 'locked' : ''}" id="module-${aula.id}">
                    ${!aula.hasHomework ? `
                        <div class="lock-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        </div>
                    ` : `<img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1760657894/SLAP_ICON_PRETO_2_2_tv8bmp.png" alt="Logo" class="absolute top-4 right-4 w-8 h-8 opacity-10">`}
                    <div>
                        <span class="module-tag">STARTER 1 - HW AULA ${String(aula.id).padStart(2, '0')}</span>
                        <h3 class="text-xl font-bold text-stone-800 mb-2 mt-2">${aula.name}</h3>
                        <p class="text-stone-500 text-sm mb-6">${aula.hasHomework ? 'Pratique as estruturas aprendidas em aula.' : 'Sem homework dispon√≠vel.'}</p>
                    </div>
                    <div class="flex flex-nowrap gap-2">
                        ${sBtn} ${tBtn}
                        <button class="action-button flex-1 text-xs uppercase" ${!aula.hasHomework ? 'disabled' : `onclick="openPractice(${aula.id})"`}>Praticar</button>
                    </div>
                </div>`
            }).join('');
        }

        window.openPractice = function(id) {
            const aula = aulaNames.find(a => a.id === id);
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('hm-shortcuts-container').classList.add('hidden'); // HIDE SHORTCUTS
            document.getElementById('generator-view').classList.remove('hidden');
            document.getElementById('current-hw-display').textContent = `Homework Aula ${id}: ${aula.name}`;
            questionsPool = mockQuestions[id] || [{ q: `Exerc√≠cio para ${aula.name}: Qual a forma correta?`, options: [{text: "Op√ß√£o A", isCorrect: true}, {text: "Op√ß√£o B", isCorrect: false}], rationale: "Acur√°cia estrutural √© fundamental!" }];
            loadNextQuestion();
        };

        window.loadNextQuestion = function() {
            const q = questionsPool[Math.floor(Math.random() * questionsPool.length)];
            currentQuestion = q;
            document.getElementById('main-question').textContent = q.q;
            document.getElementById('rationale-display').classList.add('hidden');
            document.getElementById('feedback-alert').classList.add('hidden');
            answerSubmitted = false;
            const container = document.getElementById('options-container');
            container.innerHTML = q.options.map((opt, i) => `<button class="option-button w-full border-2 border-slate-200 p-4 rounded-xl font-bold text-left hover:border-indigo-400" onclick="submitAnswer(${i})">${opt.text}</button>`).join('');
        };

        window.submitAnswer = function(idx) {
            if (answerSubmitted) return;
            answerSubmitted = true;
            const isCorrect = currentQuestion.options[idx].isCorrect;
            const alert = document.getElementById('feedback-alert');
            alert.textContent = isCorrect ? "Muito bem!" : "Tente entender o porqu√™:";
            alert.className = `p-3 mb-6 rounded-lg text-white font-semibold text-center ${isCorrect ? 'bg-green-500' : 'bg-red-500'}`;
            alert.classList.remove('hidden');
            document.getElementById('rationale-content').textContent = currentQuestion.rationale;
            document.getElementById('rationale-display').classList.remove('hidden');
            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.disabled = true;
                if (currentQuestion.options[i].isCorrect) btn.classList.add('border-green-500', 'bg-green-500');
                else if (i === idx) btn.classList.add('border-red-500', 'bg-red-500');
            });
        };

        window.openStudy = function(id) {
            const aula = aulaNames.find(a => a.id === id);
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('hm-shortcuts-container').classList.add('hidden'); // HIDE SHORTCUTS
            document.getElementById('study-view').classList.remove('hidden');
            const titleArea = document.getElementById('study-title');
            const instrArea = document.getElementById('study-instruction');
            const contentArea = document.getElementById('study-content-area');
            
            if (aula.specialMode === 'flashcards') {
                titleArea.textContent = `Flashcards: ${aula.name}`;
                instrArea.textContent = "Toque na carta para ver a tradu√ß√£o.";
                currentFlashcardIdx = 0; currentShuffledCards = shuffle([...flashcardsData[id]]); renderFlashcards();
            } else if (aula.specialMode === 'listening') {
                titleArea.textContent = `Listening: ${aula.name}`;
                instrArea.textContent = "Toque no item para ouvir.";
                renderListeningBoard(aula.items);
            } else if (aula.specialMode === 'chunks') {
                titleArea.textContent = "CHUNKS OF LANGUAGE";
                instrArea.textContent = "Clique no olho para revelar.";
                renderChunksGrid(chunksData[id]);
            }
        };

        window.openFlashcards = function(id) {
            const aula = aulaNames.find(a => a.id === id);
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('hm-shortcuts-container').classList.add('hidden'); // HIDE SHORTCUTS
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Flashcards: Holidays";
            currentFlashcardIdx = 0; currentShuffledCards = shuffle([...flashcardsData[id]]); renderFlashcards();
        }

        window.toggleChunk = function(index) {
            const text = document.getElementById(`chunk-pt-${index}`);
            text.classList.toggle('translation-hidden');
            text.classList.toggle('translation-visible');
        }

        function renderChunksGrid(data) {
            const area = document.getElementById('study-content-area');
            area.innerHTML = `<div class="chunks-grid shadow-lg">${data.map((item, index) => `
                <div class="chunks-cell chunks-cell-en">${item.en}</div>
                <div class="chunks-cell chunks-cell-pt"><span id="chunk-pt-${index}" class="translation-hidden">${item.pt}</span>
                    <button onclick="toggleChunk(${index})" class="p-1 ml-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>`).join('')}</div>`;
        }

        async function renderListeningBoard(items) {
            const area = document.getElementById('study-content-area');
            area.innerHTML = `<div class="listening-grid"></div>`;
            const grid = area.querySelector('.listening-grid');
            items.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                // HTML for Listening buttons RESTORED
                btn.innerHTML = `<span class="main-text">${item.n}</span><span class="sub-text">${item.p || item.w}</span>`;
                btn.onclick = async () => {
                    if (btn.classList.contains('playing')) return;
                    btn.classList.add('playing');
                    const audio = await fetchTTSAudio(item.w); // Uses the word for TTS
                    if (audio) { audio.currentTime = 0; audio.play(); audio.onended = () => btn.classList.remove('playing'); }
                    else btn.classList.remove('playing');
                };
                grid.appendChild(btn);
            });
        }

        function renderFlashcards() {
            const area = document.getElementById('study-content-area');
            const update = () => {
                const card = currentShuffledCards[currentFlashcardIdx];
                const isText = /[a-zA-Z0-9]/.test(card.front); 
                const frontSize = isText ? 'text-4xl' : 'text-9xl';
                area.innerHTML = `
                    <div class="flashcard-container" onclick="this.querySelector('.flashcard').classList.toggle('flipped')">
                        <div class="flashcard"><div class="flashcard-front"><span class="text-xs absolute top-8 opacity-50 font-bold tracking-widest">PORTUGUESE</span><span class="${frontSize} font-bold mt-4">${card.front}</span></div>
                        <div class="flashcard-back"><span class="text-xs absolute top-8 opacity-50 font-bold tracking-widest">ENGLISH</span><span class="text-3xl font-bold mt-4">${card.back}</span></div></div>
                    </div>
                    <div class="flex items-center justify-between max-w-xs mx-auto mt-4">
                        <button class="secondary-button p-3 rounded-full" onclick="changeFC(-1)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg></button>
                        <span class="font-bold text-stone-400">${currentFlashcardIdx + 1} / ${currentShuffledCards.length}</span>
                        <button class="secondary-button p-3 rounded-full" onclick="changeFC(1)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>`;
            };
            window.changeFC = (dir) => { currentFlashcardIdx = (currentFlashcardIdx + dir + currentShuffledCards.length) % currentShuffledCards.length; update(); };
            update();
        }

        function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

        window.onload = function() { document.getElementById('login-gate').style.display = 'flex'; };
    </script>
</body>
</html>
