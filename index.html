<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP | Grammar Training Track</title>
    <!-- SLAP Favicon -->
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: DM Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Applying default font and colors */
        body {
            font-family: 'DM Sans', sans-serif;
            background-color: #f4f7f9; /* Soft gray background */
            min-height: 100vh;
        }
        
        /* Main container for centering and width limit */
        #main-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Primary Action Button Styles (SLAP Yellow) */
        .action-button {
             background-color: #F1D24B; 
             color: #44403c; /* stone-800 */
             padding: 0.75rem 1.5rem; 
             border-radius: 0.75rem; 
             font-weight: 700; 
             cursor: pointer; 
             transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
             display: inline-flex;
             align-items: center;
             justify-content: center; 
             gap: 0.5rem;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover:not(:disabled) {
            background-color: #eab308; /* Darker Yellow */
            transform: translateY(-2px);
        }
        
        /* Secondary Button Styles (Dark) - Study/Back Button (kept for back button) */
        .secondary-button {
            background-color: #44403c; /* stone-800 */
            color: white;
            padding: 0.75rem 1.5rem; 
            border-radius: 0.75rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .secondary-button:hover:not(:disabled) {
            background-color: #292524; /* stone-900 */
            transform: translateY(-1px);
        }
        
        /* Option Button Styles */
        .option-button {
            background-color: white;
            border: 2px solid #e5e7eb;
            color: #44403c;
            text-align: left;
            padding: 1rem;
            border-radius: 0.75rem;
            width: 100%;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .option-button:hover:not(:disabled) {
            border-color: #8671d1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        .option-button:disabled {
            cursor: not-allowed;
        }

        /* Option Letter Prefix Style (A, B, C, D) */
        .option-prefix {
            font-weight: 700;
            color: #8671d1; /* SLAP Purple */
            min-width: 1.5rem;
            text-align: center;
        }
        
        /* Module Tag Style - SLAP PURPLE */
        .module-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #8671d1; /* SLAP Purple */
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }

        /* Filter Button Style */
        .filter-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        .filter-button.active {
            background-color: #8671d1; /* SLAP Purple */
            color: white;
            border-color: #6d5b9b;
        }
        .filter-button:not(.active) {
            background-color: white;
            color: #44403c;
            border-color: #ddd;
        }
        .filter-button:not(.active):hover {
            background-color: #efefef;
        }
        

        /* Generator Screen Style (Modal-like view) */
        .generator-view-container {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }
        
        /* Question Box Style - SLAP BLUE (Content) */
        .challenge-box {
            background-color: #eef2ff; /* Soft background maintained */
            padding: 1.5rem;
            border-radius: 0.75rem;
            border-left: 5px solid #84c7df; /* SLAP Blue for border */
        }
        
        /* Rationale Display Style */
        #rationale-content {
            background-color: #fef3c7; /* Yellow background */
            color: #78350f; /* Dark brown text */
            padding: 1rem;
            border-radius: 0.75rem;
            border-left: 5px solid #eab308; /* Darker yellow border */
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* --- MODULE CARD STYLES (Grid Layout) --- */

        .level-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%; /* Ensures all cards in the grid are the same height */
        }
        .level-card:hover {
            transform: scale(1.02); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            border-color: #8671d1; /* Purple border on hover */
        }
        
        /* Locked State Styles */
        .level-card.locked {
            filter: grayscale(100%);
            opacity: 0.7;
            position: relative;
            /* pointer-events: none; REMOVIDO para permitir o clique e o alerta */
            cursor: not-allowed;
        }
        
        .level-card.locked::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            z-index: 10;
        }
        
        /* Lock Icon Overlay */
        .lock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background-color: rgba(68, 64, 60, 0.8);
            border-radius: 50%;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            pointer-events: none; /* O overlay não deve bloquear o clique no card */
        }

        /* Login Gate Specific Styles */
        #login-gate {
            background-color: #44403c; /* stone-800 */
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
        }
        .login-card {
            background-color: white;
            color: #44403c;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
        }
        .login-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        .login-button {
            background-color: #F1D24B;
            color: #44403c;
            width: 100%;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .login-button:hover {
            background-color: #eab308;
        }
        
        /* Specific style for TBA input field */
        #tba-answer-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #8671d1;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #tba-answer-input:focus {
            outline: none;
            border-color: #5d4a8e;
            box-shadow: 0 0 0 3px rgba(134, 113, 209, 0.2);
        }

        /* Study View */
        #video-player {
            width: 100%;
            height: 450px;
            border-radius: 0.75rem;
            background-color: #292524;
            margin-bottom: 1.5rem;
            /* Ensure inner content fills the space */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #video-player iframe, #video-player video {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.75rem;
        }
        
    </style>
</head>
<body>
    
    <!-- LOGIN GATE -->
    <div id="login-gate">
        <div class="login-card text-center">
            <h1 class="text-3xl font-bold mb-4 text-[#8671d1]">SLAP Grammar Track Access</h1>
            <p class="text-lg font-medium mb-6">Para entrar, digite a senha da sua cantora:</p>
            
            <form id="login-form" onsubmit="checkPassword(event)">
                <label for="password-input" class="block text-left font-semibold text-sm mb-1">
                    Senha (Cantora):
                </label>
                <input 
                    type="password" 
                    id="password-input" 
                    class="login-input" 
                    placeholder="ex: shakira" 
                    required
                >
                <button type="submit" class="login-button">
                    Entrar na Trilha Gramatical
                </button>
                <p id="login-feedback" class="mt-4 text-red-600 hidden font-bold">Senha incorreta. Tente novamente!</p>
            </form>
        </div>
    </div>


    <div id="main-wrapper" class="hidden">
        
        <!-- HEADER (Logo and Title) -->
        <header class="py-6 border-b border-stone-200 mb-8">
            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo Preto" class="w-32 h-auto mx-auto mb-2">
            <!-- TITLE UPDATED TO SLAP GRAMMAR TRAINING TRACK -->
            <h1 class="text-3xl font-bold text-center text-stone-800">SLAP Grammar Training Track</h1>
            <p class="text-center text-stone-500">Módulos de Certificação Estrutural (Foco em Acurácia)</p>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="w-full">
            <!-- UPDATED: Centered title -->
            <h2 class="text-xl font-semibold text-stone-700 mb-6 text-center" id="dashboard-title">Selecione o Módulo Gramatical:</h2>
            
            <!-- NEW: Search Input -->
            <div class="flex justify-center mb-8">
                <div class="relative w-full max-w-md">
                    <input 
                        type="text" 
                        id="search-input" 
                        class="w-full px-4 py-2 border-2 border-stone-200 rounded-lg focus:outline-none focus:border-[#8671d1] transition-colors"
                        placeholder="Pesquisar por assunto..."
                        oninput="handleSearch(this.value)"
                    >
                    <svg class="absolute right-3 top-2.5 text-stone-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <!-- UPDATED: Filter Buttons Centered -->
            <div id="filter-container" class="mb-8 flex flex-wrap gap-3 justify-center">
                <!-- Buttons will be injected here by JS -->
            </div>

            <!-- NEW: Grid Container for Modules -->
            <div id="level-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 pb-16">
                <!-- Cards will be injected here by JS -->
            </div>
        </div>

        <!-- GENERATOR VIEW (PRACTICE - QUIZ) -->
        <div id="generator-view" class="hidden w-full">
            <!-- Back to Dashboard Button -->
            <button class="secondary-button mb-6" onclick="showDashboard()">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                <span id="back-button-text">Voltar para Módulos</span>
            </button>

            <div class="generator-view-container">
                <h2 class="text-3xl font-bold text-stone-800 mb-4">Módulo: <span id="current-level-display" class="text-[#84c7df]"></span></h2>
                
                <!-- ALERT FEEDBACK MESSAGE -->
                <div id="feedback-alert" class="hidden p-3 mb-6 rounded-lg text-white font-semibold transition-all duration-300"></div>

                <!-- QUESTION/CHALLENGE BOX -->
                <div class="challenge-box mb-8">
                    <div class="flex justify-between items-start">
                        <p class="text-sm font-semibold text-indigo-700 mb-2" id="question-label">PERGUNTA ATUAL:</p>
                    </div>

                    <p id="main-question" class="text-xl font-bold text-indigo-900">Clique em "Gerar Próxima Pergunta" para Iniciar!</p>
                </div>

                <!-- OPTIONS / INPUT CONTAINER -->
                <div id="options-container" class="mt-8 space-y-3">
                    <!-- Options or TBA input injected here -->
                </div>

                <!-- Next Question Button & Rationale -->
                <div id="rationale-display" class="hidden mt-6">
                    <div id="rationale-content" class="mb-4">
                        <!-- Rationale Text injected here -->
                    </div>
                    <button id="next-question-btn" class="action-button mt-0 w-full" onclick="loadNextQuestion()" disabled><span id="next-button-text">Gerar Próxima Pergunta</span></button>
                </div>

            </div>
        </div>
        
        <!-- STUDY VIEW (NEW) -->
        <div id="study-view" class="hidden w-full">
             <button class="secondary-button mb-6" onclick="showDashboard()">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Voltar para Módulos
            </button>
            
            <div class="generator-view-container">
                 <h2 class="text-3xl font-bold text-stone-800 mb-4">Estudo: <span id="study-module-display" class="text-[#8671d1]"></span></h2>
                 
                 <div id="video-player">
                      <!-- Content will be loaded here dynamically (iframe or video tag) -->
                 </div>
            </div>
        </div>


    </div>
    
    <script>
        // --- CONSTANTS AND GLOBAL GAME STATE ---
        let currentModule = null; // Current module name (string)
        let questionsPool = []; // Pool of remaining questions in the current session (prevents repetition)
        let currentQuestion = null; // CURRENTLY DISPLAYED QUESTION
        let answerSubmitted = false;
        let currentFilter = 'ALL'; // Tracks the current filter tag (e.g., 'STARTER 1', 'ALL')
        let currentSearchTerm = ''; // Tracks the current search query
        let currentUserMaxLevelIndex = -1; // Stores the max allowed level index for the user
        
        // Fixed order of levels for proper numbering
        const LEVEL_ORDER = [
            'STARTER 1', 'STARTER 2', 
            'FRESHMAN 1', 'FRESHMAN 2', 
            'SOPHOMORE 1', 'SOPHOMORE 2', 
            'JUNIOR 1', 'JUNIOR 2', 
            'SENIOR 1', 'SENIOR 2'
        ];

        // Access Passwords (Singers)
        const LEVEL_PASSWORDS = {
            'ariana': 0,  // STARTER 1
            'beyonce': 1, // STARTER 2
            'madonna': 2, // FRESHMAN 1
            'shakira': 3, // FRESHMAN 2
            'adele': 4,   // SOPHOMORE 1
            'rihanna': 5, // SOPHOMORE 2
            'taylor': 6,  // JUNIOR 1
            'gaga': 7,    // JUNIOR 2
            'katy': 8,    // SENIOR 1
            'britney': 9  // SENIOR 2
        };

        // Letters for options
        const optionPrefixes = ['A', 'B', 'C', 'D'];
        
        // --- GRAMMAR CONTENT DATA (SLAP GRAMMAR TRACK) ---
        // Each module now has 1 MC and 1 TBA question.
        // Language switch: PT (M1-M24), EN (M25-M45). Rationale always PT.
        // ADDED: Specific descriptions and mock video URLs (replace with your Cloudinary/YouTube links).
        
        const grammarData = {
            // --- STARTER 1 (Módulos 1-3) ---
            'Verb to be': {
                module_tag: 'STARTER 1',
                description: "Domine as formas 'am', 'is' e 'are' para expressar estado, identidade e localização no presente e passado.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765234712/M%C3%B3dulo_1_-_Verb_to_Be_S1_d83boa.mp4",
                questions: [
                    // MC 1
                    { q: "Qual é a forma correta do 'Verb to be' para completar a frase: 'She ___ a great instructor.'?", options: [
                        { text: "am", isCorrect: false },
                        { text: "are", isCorrect: false },
                        { text: "is", isCorrect: true, rationale: "O pronome 'She' (terceira pessoa do singular) exige a conjugação 'is' do Verb to be no Simple Present." },
                        { text: "be", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase usando a negação: 'I ___ an engineer; I am a designer.'", answer: "am not", rationale: "O pronome 'I' usa 'am', e a negação é formada com 'not' ('am not')." }
                ],
            },
            'Simple Present': {
                module_tag: 'STARTER 1',
                description: "Foque no uso correto dos verbos de rotina e hábitos, incluindo a regra do -S na terceira pessoa do singular (He/She/It).",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765234705/M%C3%B3dulo_2_-_Simple_Present_S1_vpwmuj.mp4",
                questions: [
                    // MC 1
                    { q: "Qual das frases está correta no Simple Present (Terceira Pessoa do Singular)?", options: [
                        { text: "He go to the office every day.", isCorrect: false },
                        { text: "He goes to the office every day.", isCorrect: true, rationale: "Na terceira pessoa do singular (He/She/It), o verbo principal no Simple Present recebe a terminação -s ou -es." },
                        { text: "He is go to the office every day.", isCorrect: false },
                        { text: "He going to the office every day.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação: 'My sister ___ like spiders.'", answer: "doesn't", rationale: "'My sister' é 3ª pessoa do singular (She), exigindo o auxiliar 'doesn't' para a negação." }
                ],
            },
            'Can / Can’t': {
                module_tag: 'STARTER 1',
                description: "Pratique o modal 'Can' para expressar habilidade e permissão, e a forma negativa 'Can't'.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765234704/M%C3%B3dulo_3_-_Can_Can_t_S1_hcj7k5.mp4",
                questions: [
                    // MC 1
                    { q: "Qual modal é usado para expressar habilidade no presente na frase 'I ___ speak three languages'?", options: [
                        { text: "must", isCorrect: false },
                        { text: "will", isCorrect: false },
                        { text: "can", isCorrect: true, rationale: "'Can' é o modal primário usado para expressar habilidade ou capacidade no presente." },
                        { text: "should", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação (forma completa): 'I ___ hear you, the music is too loud.'", answer: "can not", rationale: "A negação de 'can' é formada adicionando 'not' diretamente, ou a contração 'can't'." }
                ],
            },
            
            // --- STARTER 2 (Módulos 4-6) ---
            'Present Continuous': {
                module_tag: 'STARTER 2',
                description: "Aprenda a estrutura 'to be + -ing' para descrever ações em progresso no momento da fala.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual frase descreve uma ação que está acontecendo **neste momento**?", options: [
                        { text: "I study every night.", isCorrect: false },
                        { text: "I am studying right now.", isCorrect: true, rationale: "O Present Continuous (Verb to be + -ing) descreve ações em progresso no momento da fala, frequentemente acompanhadas de 'right now'." },
                        { text: "I studied yesterday.", isCorrect: false },
                        { text: "I will study tomorrow.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase afirmativa: 'The baby ___ sleeping in the crib.'", answer: "is", rationale: "'The baby' (It) exige a forma 'is' do Verb to be no Present Continuous." }
                ],
            },
            'Present Continuous (for future situations)': {
                module_tag: 'STARTER 2',
                description: "Use o Present Continuous para falar sobre planos fixos e compromissos agendados no futuro próximo.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765234706/M%C3%B3dulo_5_-_Prsent_Continues_for_Future_Situations_S2_ezi2r5.mp4",
                questions: [
                    // MC 1
                    { q: "O Present Continuous é usado para o futuro quando expressamos:", options: [
                        { text: "Decisões espontâneas.", isCorrect: false },
                        { text: "Fatos científicos.", isCorrect: false },
                        { text: "Planos fixos ou compromissos agendados.", isCorrect: true, rationale: "O Present Continuous é ideal para expressar arranjos (arrangements), planos que já foram organizados e confirmados." },
                        { text: "Previsões sem evidência.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase afirmativa: 'I ___ meeting the manager on Friday.'", answer: "am", rationale: "O sujeito 'I' usa o auxiliar 'am' para formar o Present Continuous." }
                ],
            },
            'Future Simple (will)': {
                module_tag: 'STARTER 2',
                description: "Aprenda a usar 'will' para previsões, decisões espontâneas e promessas, e a forma negativa 'won't'.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765234706/M%C3%B3dulo_6_-_Future_Simple_S2_rgezxi.mp4",
                questions: [
                    // MC 1
                    { q: "O 'Future Simple (will)' é usado principalmente para expressar:", options: [
                        { text: "Planos fixos e agendados.", isCorrect: false },
                        { text: "Ações habituais.", isCorrect: false },
                        { text: "Previsões gerais, decisões espontâneas e promessas.", isCorrect: true, rationale: "'Will' é usado para previsões que não dependem de evidência imediata, e para decisões tomadas no momento da fala (instant decisions)." },
                        { text: "Obrigações.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação (forma contraída): 'I ___ be able to finish this today.'", answer: "won't", rationale: "A negação contraída de 'will not' é 'won't'." }
                ],
            },

            // --- FRESHMAN 1 (Módulos 7-10) ---
            'Should': {
                module_tag: 'FRESHMAN 1',
                description: "Pratique o modal 'Should' para oferecer conselhos, sugestões ou expressar um dever moral fraco.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765235126/M%C3%B3dulo_7_-_Should_F1_xegrqi.mp4",
                questions: [
                    // MC 1
                    { q: "Qual o principal uso do modal 'should'?", options: [
                        { text: "Obrigação forte.", isCorrect: false },
                        { text: "Habilidade no passado.", isCorrect: false },
                        { text: "Aconselhamento, sugestão ou dever moral fraco.", isCorrect: true, rationale: "'Should' é usado para dar conselhos ou sugestões sobre o que é certo ou bom fazer." },
                        { text: "Probabilidade futura.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação: 'We ___ waste water.'", answer: "shouldn't", rationale: "Para negar o conselho, usamos a forma contraída 'shouldn't' ('should not')." }
                ],
            },
            'Was / Were': {
                module_tag: 'FRESHMAN 1',
                description: "Conjugue o 'Verb to be' no Simple Past, utilizando 'was' (singular) e 'were' (plural).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "A conjugação correta de 'Verb to be' no Simple Past para 'I' e 'He' é:", options: [
                        { text: "were", isCorrect: false },
                        { text: "am", isCorrect: false },
                        { text: "was", isCorrect: true, rationale: "'Was' é usado com os pronomes singulares 'I', 'He', 'She' e 'It'." },
                        { text: "are", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase no passado afirmativo: 'They ___ at the beach last weekend.'", answer: "were", rationale: "O sujeito 'They' (plural) usa 'were' no Simple Past." }
                ],
            },
            'Simple Past (Verbs in the past)': {
                module_tag: 'FRESHMAN 1',
                description: "Foque na conjugação dos verbos regulares (-ed) e irregulares (tabela) para ações concluídas no passado.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual o Past Tense (passado) do verbo irregular 'to go'?", options: [
                        { text: "goed", isCorrect: false },
                        { text: "gones", isCorrect: false },
                        { text: "went", isCorrect: true, rationale: "'Went' é a forma do Simple Past do verbo irregular 'to go'." },
                        { text: "go", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação: 'I ___ see the problem yesterday.'", answer: "didn't", rationale: "A negação no Simple Past é feita com 'didn't' seguido pelo verbo na forma base ('see')." }
                ],
            },
            'Future Forms (will / going to / present continuous for future)': {
                module_tag: 'FRESHMAN 1',
                description: "Distinção entre 'will' (previsão/espontaneidade), 'going to' (intenção/evidência) e Present Continuous (agendamento).",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765235522/M%C3%B3dulo_10_-_Future_Forms_will___going_to___present_continuous_for_future_F1_xbjjmt.mp4",
                questions: [
                    // MC 1
                    { q: "Qual forma de futuro é mais adequada para expressar uma **intenção ou plano** prévio ('I've decided to')?", options: [
                        { text: "Future Simple (will).", isCorrect: false },
                        { text: "Present Simple.", isCorrect: false },
                        { text: "Be going to.", isCorrect: true, rationale: "'Be going to' é usado para expressar planos, intenções ou previsões baseadas em evidências atuais." },
                        { text: "Present Continuous (apenas para agendamentos).", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação: 'I'm afraid she ___ pass the test.' (Use a forma contraída de 'will not').", answer: "won't", rationale: "A negação contraída de 'will not' é 'won't'." }
                ],
            },

            // --- FRESHMAN 2 (Módulos 11-14) ---
            'Could / Should / Would': {
                module_tag: 'FRESHMAN 2',
                description: "Diferencie 'Could' (habilidade passada/pedido), 'Should' (conselho) e 'Would' (condicional/pedido polido).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual modal expressa **habilidade no passado** (e.g., 'When I was young, I ___ run fast')?", options: [
                        { text: "should", isCorrect: false },
                        { text: "would", isCorrect: false },
                        { text: "could", isCorrect: true, rationale: "'Could' é o passado de 'can' e é usado para expressar uma habilidade que se tinha no passado." },
                        { text: "must", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a pergunta educada: '___ you help me with this box, please?'", answer: "Would", rationale: "'Would' (ou 'Could') é usado para fazer pedidos educados." }
                ],
            },
            'Used to': {
                module_tag: 'FRESHMAN 2',
                description: "Pratique 'Used to' para hábitos e estados que eram verdadeiros no passado, mas não são mais.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765235171/M%C3%B3dulo_12_-_Used_To_F2_wnrly6.mp4",
                questions: [
                    // MC 1
                    { q: "Qual o principal uso de 'used to'?", options: [
                        { text: "Ações contínuas no presente.", isCorrect: false },
                        { text: "Hábitos ou estados que existiam **regularmente no passado**, mas não mais.", isCorrect: true, rationale: "'Used to' descreve uma rotina ou estado que era verdade no passado, mas não é mais no presente." },
                        { text: "Obrigação futura.", isCorrect: false },
                        { text: "Habilidade no presente.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a pergunta (verbo na forma base): 'Did you ___ to wear glasses?'", answer: "use", rationale: "Após 'Did', o verbo deve estar na forma base ('use')." }
                ],
            },
            'Have to / Need to': {
                module_tag: 'FRESHMAN 2',
                description: "Domine 'Have to' (obrigação externa) e 'Need to' (necessidade), e suas formas negativas ('don't have to').",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual modal é usado para expressar **obrigação externa** (regras, leis, circunstâncias)?", options: [
                        { text: "Must (para obrigação interna).", isCorrect: false },
                        { text: "Have to.", isCorrect: true, rationale: "'Have to' é frequentemente usado para obrigações impostas por terceiros ou regras (ex: 'I have to wear a uniform')." },
                        { text: "Should.", isCorrect: false },
                        { text: "Would.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase no presente: 'We ___ to finish the report today.'", answer: "have", rationale: "O sujeito 'We' usa 'have' para expressar obrigação." }
                ],
            },
            'Past Continuous': {
                module_tag: 'FRESHMAN 2',
                description: "Aprenda a descrever ações em progresso no passado, geralmente interrompidas por uma ação mais curta no Simple Past.",
                videoUrl: "https://res.cloudinary.com/dqfi22uz0/video/upload/v1765235166/M%C3%B3dulo_14_-_Past_Continuos_F2_ozvvzn.mp4",
                questions: [
                    // MC 1
                    { q: "O Past Continuous é usado para descrever uma ação **em progresso no passado** que foi frequentemente:", options: [
                        { text: "Concluída no passado.", isCorrect: false },
                        { text: "Interrompida por outra ação no Simple Past.", isCorrect: true, rationale: "O Past Continuous descreve a ação de fundo (longer action) que é interrompida por uma ação mais curta no Simple Past (ex: 'I was sleeping when the phone rang')." },
                        { text: "Uma rotina diária.", isCorrect: false },
                        { text: "Uma obrigação futura.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase afirmativa: 'I ___ cooking when the electricity went out.'", answer: "was", rationale: "O sujeito 'I' usa 'was' no Past Continuous." }
                ],
            },

            // --- SOPHOMORE 1 (Módulos 15-18) ---
            'Must / May / Might': {
                module_tag: 'SOPHOMORE 1',
                description: "Compare 'Must' (obrigação forte/dedução) com 'May' e 'Might' (probabilidade/permissão).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual modal é usado para expressar uma **obrigação forte, interna ou regra crucial**?", options: [
                        { text: "Should.", isCorrect: false },
                        { text: "Might.", isCorrect: false },
                        { text: "Must.", isCorrect: true, rationale: "'Must' é usado para expressar obrigação forte, necessidade pessoal ou interna (ex: 'I must work harder') ou regras importantes." },
                        { text: "Would.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação que expressa proibição: 'You ___ smoke indoors.'", answer: "must not", rationale: "'Must not' ou 'Mustn't' expressam proibição (não é permitido)." }
                ],
            },
            'Ought to / Had better': {
                module_tag: 'SOPHOMORE 1',
                description: "Diferencie 'Ought to' (conselho formal, similar a 'should') de 'Had better' (aviso urgente/consequência).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual modal é mais enfático e usado para expressar um **conselho urgente ou aviso** sobre consequências negativas se não for seguido?", options: [
                        { text: "Ought to.", isCorrect: false },
                        { text: "Should.", isCorrect: false },
                        { text: "Had better.", isCorrect: true, rationale: "'Had better' implica uma urgência e um aviso de que algo ruim pode acontecer se o conselho não for seguido (ex: 'You had better leave now')." },
                        { text: "Might.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase: 'We ___ to respect our elders.'", answer: "ought", rationale: "O modal 'ought' é usado para expressar dever e sempre vem acompanhado de 'to'." }
                ],
            },
            '-ing Verbs (Gerunds and verbs of preference)': {
                module_tag: 'SOPHOMORE 1',
                description: "Pratique o uso do Gerúndio (verbo + -ing como substantivo) e o uso de verbos de preferência seguidos por -ing ou infinitivo.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Na frase 'Learning new rules is essential', 'Learning' está sendo usado como:", options: [
                        { text: "Verbo no Present Continuous.", isCorrect: false },
                        { text: "Adjetivo.", isCorrect: false },
                        { text: "Substantivo (Gerúndio como sujeito).", isCorrect: true, rationale: "Quando um verbo com -ing funciona como sujeito da frase, ele é chamado de Gerúndio, atuando como um substantivo." },
                        { text: "Past Participle.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase usando Gerúndio: 'She dislikes ___ (work) on weekends.'", answer: "working", rationale: "O verbo 'dislike' é seguido por Gerúndio (-ing)." }
                ],
            },
            'Comparatives / Superlatives': {
                module_tag: 'SOPHOMORE 1',
                description: "Domine as regras de -er/-est e more/most, incluindo as formas irregulares (better, best).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual estrutura é usada para comparar duas coisas (e.g., 'This car is ___ than that one')?", options: [
                        { text: "Superlativo.", isCorrect: false },
                        { text: "Comparativo.", isCorrect: true, rationale: "O Comparativo é usado para contrastar dois itens, usando a estrutura -er ou 'more... than'." },
                        { text: "Zero Conditional.", isCorrect: false },
                        { text: "Causative Form.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase no comparativo: 'This coffee is ___ (hot) than the tea.'", answer: "hotter", rationale: "O adjetivo 'hot' segue a regra CVC: dobra-se a consoante e adiciona-se -er." }
                ],
            },

            // --- SOPHOMORE 2 (Módulos 19-24) ---
            'Be allowed to': {
                module_tag: 'SOPHOMORE 2',
                description: "Use 'Be allowed to' para expressar permissão e suas formas negativas para expressar proibição em diferentes tempos verbais.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "O modal 'be allowed to' é usado para expressar:", options: [
                        { text: "Necessidade.", isCorrect: false },
                        { text: "Permissão ou Proibição (em sua forma negativa).", isCorrect: true, rationale: "'Be allowed to' expressa permissão. Na forma negativa ('not allowed to'), ele expressa proibição ou falta de permissão." },
                        { text: "Conselho.", isCorrect: false },
                        { text: "Habilidade futura.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a permissão no passado: 'He ___ allowed to go to the party.'", answer: "was", rationale: "O sujeito 'He' (singular) usa 'was' no passado." }
                ],
            },
            'Past Participle': {
                module_tag: 'SOPHOMORE 2',
                description: "Pratique a 3ª coluna dos verbos (V3), essencial para Tempos Perfect e Voz Passiva.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "O Past Participle é a forma verbal essencial para a formação de quais estruturas?", options: [
                        { text: "Simple Past e Future Simple.", isCorrect: false },
                        { text: "Tempos Perfect e Voz Passiva.", isCorrect: true, rationale: "Todos os tempos Perfect (Present, Past, Future) usam 'have/had + Past Participle'. A Voz Passiva usa 'to be + Past Participle'." },
                        { text: "Simple Present e Past Continuous.", isCorrect: false },
                        { text: "Gerúndio e Infinitivo.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a voz passiva: 'The window was ___ (break) last night.'", answer: "broken", rationale: "O Past Participle de 'break' é 'broken'." }
                ],
            },
            'Present Perfect': {
                module_tag: 'SOPHOMORE 2',
                description: "Distinga o Present Perfect (experiência, tempo indefinido) do Simple Past, usando 'for', 'since', 'yet' e 'already'.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "O Present Perfect é frequentemente usado para falar de experiências de vida em um tempo:", options: [
                        { text: "Especificado no passado (e.g., yesterday).", isCorrect: false },
                        { text: "Indefinido ou não especificado (e.g., ever/never).", isCorrect: true, rationale: "O Present Perfect conecta o passado com o presente. O momento da ação passada é irrelevante ou desconhecido, focando no resultado ou na experiência em si." },
                        { text: "Que está acontecendo agora.", isCorrect: false },
                        { text: "Que ocorrerá no futuro.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a frase focando na duração: 'I haven't traveled abroad ___ five years.'", answer: "for", rationale: "'For' é usado para indicar o período de tempo ('five years')." }
                ],
            },
            'Present Perfect Continuous': {
                module_tag: 'SOPHOMORE 2',
                description: "Enfatize a **duração** e o processo de uma ação que começou no passado e ainda é relevante no presente.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "O Present Perfect Continuous enfatiza qual aspecto da ação?", options: [
                        { text: "O resultado final da ação.", isCorrect: false },
                        { text: "A **duração** de uma ação que começou no passado e continua até o presente.", isCorrect: true, rationale: "A forma Continuous (com 'been + -ing') foca na duração e no processo da ação." },
                        { text: "O momento exato da conclusão.", isCorrect: false },
                        { text: "Uma ação habitual.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a negação: 'It ___ been raining since morning.'", answer: "hasn't", rationale: "'It' usa 'has', e a negação contraída é 'hasn't'." }
                ],
            },
            'Question Tags': {
                module_tag: 'SOPHOMORE 2',
                description: "Use o auxiliar correto e a inversão Afirmativa/Negativa para formar as Question Tags.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Se a frase principal é afirmativa ('You are an instructor'), a Question Tag deve ser:", options: [
                        { text: "Afirmativa ('are you?').", isCorrect: false },
                        { text: "Negativa ('aren't you?').", isCorrect: true, rationale: "A regra geral é: frase afirmativa exige tag negativa, e vice-versa (frase negativa exige tag afirmativa)." },
                        { text: "Afirmativa com 'do' ('do you?').", isCorrect: false },
                        { text: "Negativa com 'did' ('didn't you?').", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete a tag: 'He drives very fast, ___ he?'", answer: "doesn't", rationale: "A frase é Simple Present afirmativa (drives), então a tag é negativa ('doesn't')." }
                ],
            },
            'Relative Clauses': {
                module_tag: 'SOPHOMORE 2',
                description: "Use pronomes relativos (who, which, that, whose, where, when) para conectar informações e formar orações relativas.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Qual pronome relativo é usado para substituir **pessoas**?", options: [
                        { text: "Which.", isCorrect: false },
                        { text: "Where.", isCorrect: false },
                        { text: "Who / That.", isCorrect: true, rationale: "Who é usado para pessoas. 'That' pode ser usado para pessoas e coisas, mas 'Who' é o mais comum para pessoas." },
                        { text: "Whose.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Qual pronome relativo é usado para substituir coisas?", answer: "which", rationale: "'Which' é o pronome relativo padrão para coisas e animais (ou 'that')." }
                ],
            },

            // --- JUNIOR 1 (Módulos 25-29) ---
            'Phrasal Verbs (Pt. 1 & 2)': {
                module_tag: 'JUNIOR 1',
                description: "Practice the meaning and separability rules of common Phrasal Verbs (Pt. 1 & 2).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which Phrasal Verb means 'to search/look for information'?", options: [
                        { text: "Look over", isCorrect: false },
                        { text: "Look up", isCorrect: true, rationale: "'Look up' é o phrasal verb correto para procurar uma informação, geralmente em um dicionário ou na internet." },
                        { text: "Look after", isCorrect: false },
                        { text: "Look at", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence with the correct Phrasal Verb meaning 'to invent': 'She ___ a new story.' (verb: make)", answer: "made up", rationale: "'Make up' significa inventar, criar ou reconciliar." }
                ],
            },
            'Zero Conditional': {
                module_tag: 'JUNIOR 1',
                description: "Master the Zero Conditional (If + Simple Present, Simple Present) for general truths and facts.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The Zero Conditional is used to express:", options: [
                        { text: "Unreal situations in the past.", isCorrect: false },
                        { text: "General truths, scientific facts, or situations that are always true.", isCorrect: true, rationale: "O Zero Conditional expressa fatos imutáveis ou resultados que sempre acontecem sob certas condições." },
                        { text: "Fixed future plans.", isCorrect: false },
                        { text: "Advice.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence in the Simple Present: 'When you cut yourself, it usually ___ (bleed).'", answer: "bleeds", rationale: "O resultado ('it') exige o Simple Present com -s." }
                ],
            },
            'First Conditional': {
                module_tag: 'JUNIOR 1',
                description: "Practice the First Conditional (If + Simple Present, Will + Base Verb) for real and probable future outcomes.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The First Conditional is used to express:", options: [
                        { text: "Hypothetical or unlikely situations.", isCorrect: false },
                        { text: "Real or possible situations in the future.", isCorrect: true, rationale: "O First Conditional lida com a causa e efeito provável no futuro." },
                        { text: "Scientific facts.", isCorrect: false },
                        { text: "Past regrets.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the main clause: 'If it rains, we ___ (stay) home.'", answer: "will stay", rationale: "O resultado provável no futuro exige 'will' + verbo base ('stay')." }
                ],
            },
            'Second Conditional': {
                module_tag: 'JUNIOR 1',
                description: "Focus on the Second Conditional (If + Simple Past, Would + Base Verb) for unreal/hypothetical present situations.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The Second Conditional is used to express:", options: [
                        { text: "Universal truths.", isCorrect: false },
                        { text: "Unreal or hypothetical situations in the present/future.", isCorrect: true, rationale: "Este condicional fala de coisas improváveis ou imaginárias no presente (ex: 'If I won the lottery...')." },
                        { text: "Fixed future plans.", isCorrect: false },
                        { text: "Completed actions in the past.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the main clause: 'If she knew the answer, she ___ (tell) us.'", answer: "would tell", rationale: "A cláusula principal usa 'would' + verbo base ('tell')." }
                ],
            },
            'Present Perfect (review)': {
                module_tag: 'JUNIOR 1',
                description: "Review key adverbs ('yet', 'already', 'just') and time markers ('for', 'since') in the Present Perfect.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which word is used in negative or interrogative Present Perfect sentences, usually at the end of the phrase?", options: [
                        { text: "Just.", isCorrect: false },
                        { text: "Already.", isCorrect: false },
                        { text: "Yet.", isCorrect: true, rationale: "'Yet' (ainda) é usado em frases negativas e interrogativas, sempre no final." },
                        { text: "For.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the phrase: 'She ___ never eaten sushi.'", answer: "has", rationale: "O sujeito 'She' exige o auxiliar 'has' no Present Perfect." }
                ],
            },

            // --- JUNIOR 2 (Módulos 30-32) ---
            'Conditionals Review (Zero, First, Second)': {
                module_tag: 'JUNIOR 2',
                description: "Review the usage and structure differentiation among the Zero, First, and Second Conditionals.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which Conditional is used to give hypothetical advice ('If I were you...')?", options: [
                        { text: "Zero Conditional.", isCorrect: false },
                        { text: "First Conditional.", isCorrect: false },
                        { text: "Second Conditional.", isCorrect: true, rationale: "A construção 'If I were you' é um uso comum do Second Conditional para dar conselhos." },
                        { text: "Third Conditional.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence (First Conditional): 'If I leave now, I ___ (catch) the bus.'", answer: "will catch", rationale: "O First Conditional exige 'will' + verbo base no resultado provável." }
                ],
            },
            'Phrasal Verbs (Keep / Put / Give)': {
                module_tag: 'JUNIOR 2',
                description: "Practice specific Phrasal Verbs built around the base verbs 'Keep', 'Put', and 'Give' (e.g., keep on, put off, give away).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "What is the meaning of 'Keep up with' (e.g., 'It's hard to keep up with the news')?", options: [
                        { text: "To give up something.", isCorrect: false },
                        { text: "To follow, to maintain pace.", isCorrect: true, rationale: "'Keep up with' significa manter-se atualizado ou na mesma velocidade/nível de algo." },
                        { text: "To postpone.", isCorrect: false },
                        { text: "To store.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence: 'Don't ___ (give) my secret.'", answer: "give away", rationale: "'Give away' significa revelar um segredo." }
                ],
            },
            'Compound Adjectives / Complex Sentences': {
                module_tag: 'JUNIOR 2',
                description: "Focus on the correct formation and usage of hyphenated compound adjectives and the structure of complex sentences (independent/dependent clauses).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which compound adjective is correctly written (e.g., 'a ___ teacher')?", options: [
                        { text: "well know", isCorrect: false },
                        { text: "well-knowing", isCorrect: false },
                        { text: "well-known", isCorrect: true, rationale: "Adjetivos compostos que modificam um substantivo são geralmente ligados por hífen, e a forma mais comum é 'adjetivo + Past Participle' ('well-known', 'long-term')." },
                        { text: "well-knowed", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the compound adjective for 'a story that lasts ten minutes': 'a ten-___ story.'", answer: "minute", rationale: "Em adjetivos compostos com números, a unidade de tempo é singular ('minute')." }
                ],
            },

            // --- SENIOR 1 (Módulos 33-39) ---
            'Causative Form (have/get something done)': {
                module_tag: 'SENIOR 1',
                description: "Practice the structure 'have/get something done' to arrange for a service, and the use of the agent (person performing the service).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The sentence 'I had my car fixed' means that:", options: [
                        { text: "I fixed my car myself.", isCorrect: false },
                        { text: "I asked or paid someone to fix my car (professional service).", isCorrect: true, rationale: "O Causative Form ('have/get something done') indica que a pessoa arranjou para que outra pessoa realizasse o serviço para ela." },
                        { text: "My car is being fixed now.", isCorrect: false },
                        { text: "I was fixed by my car.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence using the Past Participle: 'I need to get my license ___ (renew).'", answer: "renewed", rationale: "O Causative Form ('get something done') exige o Past Participle ('renewed')." }
                ],
            },
            'Reflexive Pronouns': {
                module_tag: 'SENIOR 1',
                description: "Use reflexive pronouns (myself, yourself, etc.) when the subject and object are the same, or for emphasis (by myself).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which pronoun completes the sentence 'She taught ___ how to play the guitar'?", options: [
                        { text: "hers", isCorrect: false },
                        { text: "she", isCorrect: false },
                        { text: "herself", isCorrect: true, rationale: "O Pronome Reflexivo ('herself') é usado quando o objeto da ação é o mesmo que o sujeito ('She')." },
                        { text: "her", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence: 'The machine can fix ___.'", answer: "itself", rationale: "'The machine' (It) usa 'itself' como pronome reflexivo." }
                ],
            },
            'Past Perfect': {
                module_tag: 'SENIOR 1',
                description: "Apply the Past Perfect ('had' + Past Participle) to describe an action that occurred before another action or point in the past.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The Past Perfect is used to describe an action that happened:", options: [
                        { text: "Before an action in the Present Perfect.", isCorrect: false },
                        { text: "Before another action in the Simple Past.", isCorrect: true, rationale: "O Past Perfect ('had + PP') é o 'passado do passado', usado para descrever uma ação anterior a um ponto específico no tempo passado." },
                        { text: "Simultaneously to an action in the Past Continuous.", isCorrect: false },
                        { text: "In the future.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the phrase: 'I felt sick because I ___ (eat) too much.'", answer: "had eaten", rationale: "Ação 'had eaten' ocorreu antes de 'felt sick', exigindo Past Perfect." }
                ],
            },
            'Past Modals (could have / should have / would have)': {
                module_tag: 'SENIOR 1',
                description: "Differentiate between 'Should have' (regret/criticism), 'Could have' (unrealized ability/possibility), and 'Would have' (hypothetical result in the past).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which modal is used to express **regret or criticism** about an action that **was not done** in the past (e.g., 'You ___ studied more')?", options: [
                        { text: "would have", isCorrect: false },
                        { text: "could have", isCorrect: false },
                        { text: "should have", isCorrect: true, rationale: "'Should have + PP' é usado para dizer que a pessoa fez algo errado e que a ação correta não foi feita (arrependimento ou crítica)." },
                        { text: "must have", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence (regret): 'I ___ (should/have/listen) to your advice.'", answer: "should have listened", rationale: "'Should have listened' expressa o arrependimento por não ter ouvido o conselho." }
                ],
            },
            'Third Conditional': {
                module_tag: 'SENIOR 1',
                description: "Master the Third Conditional (If + Past Perfect, Would have + PP) for unreal past conditions and results (regrets).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The Third Conditional is used to express:", options: [
                        { text: "Real situations in the future.", isCorrect: false },
                        { text: "Unreal situations in the past (regrets, speculations).", isCorrect: true, rationale: "Ele descreve uma condição que não foi cumprida no passado e seu resultado imaginário no passado." },
                        { text: "Scientific facts.", isCorrect: false },
                        { text: "Advice in the present.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the main clause (negative): 'If she had come, we ___ (would/not/have/argue).'", answer: "wouldn't have argued", rationale: "A negação do resultado hipotético é 'wouldn't have' + Past Participle ('argued')." }
                ],
            },
            'Past Perfect Continuous': {
                module_tag: 'SENIOR 1',
                description: "Use the Past Perfect Continuous ('had been' + -ing) to emphasize the duration of an action leading up to a specific moment in the past.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "The Past Perfect Continuous is used to emphasize the **duration** of an action that:", options: [
                        { text: "Finished in the present.", isCorrect: false },
                        { text: "Continued up to a specific point in the past.", isCorrect: true, rationale: "O foco é na continuidade e duração da ação até o momento de referência no passado." },
                        { text: "Is a routine in the past.", isCorrect: false },
                        { text: "Is a future plan.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete o verbo no Gerúndio: 'They were exhausted because they had been ___ (travel) all night.'", answer: "traveling", rationale: "O verbo principal deve estar na forma -ing ('traveling')." }
                ],
            },
            'Reported Speech': {
                module_tag: 'SENIOR 1',
                description: "Practice the rules of 'backshift' for tenses and changes in time/place expressions when reporting what someone said.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "When reporting a Simple Present statement ('I am busy'), which tense should be used in Reported Speech?", options: [
                        { text: "Simple Present.", isCorrect: false },
                        { text: "Simple Past.", isCorrect: true, rationale: "A regra de 'backshift' de tempos verbais exige que o Simple Present seja mudado para o Simple Past." },
                        { text: "Present Perfect.", isCorrect: false },
                        { text: "Future Simple.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete o Reported Speech: 'He said he ___ (had/live) in London before.'", answer: "had lived", rationale: "O Past Perfect ('had lived') é usado para reportar o Simple Past ou o Past Perfect." }
                ],
            },

            // --- SENIOR 2 (Módulos 40-45) ---
            'Wish / If only': {
                module_tag: 'SENIOR 2',
                description: "Use 'Wish' / 'If only' with Simple Past (present wish) or Past Perfect (past regret) to express desires and unreal situations.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which structure is used to express **regret about a past situation** (e.g., 'I wish I ___ studied for the test')?", options: [
                        { text: "Simple Past.", isCorrect: false },
                        { text: "Past Perfect.", isCorrect: true, rationale: "Para arrependimentos sobre o passado, usamos o tempo verbal um passo mais atrás: Past Perfect ('had studied')." },
                        { text: "Future Simple.", isCorrect: false },
                        { text: "Simple Present.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence (present wish): 'I wish I ___ (speak) French.'", answer: "spoke", rationale: "Desejo sobre o presente exige Simple Past ('spoke')." }
                ],
            },
            'All Conditionals (Review)': {
                module_tag: 'SENIOR 2',
                description: "Review the key differences and uses for Zero, First, Second, and Third Conditionals.",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which Conditional is used to talk about a past cause that would have had a different result in the past (regret)?", options: [
                        { text: "First Conditional.", isCorrect: false },
                        { text: "Second Conditional.", isCorrect: false },
                        { text: "Third Conditional.", isCorrect: true, rationale: "O Third Conditional (If + Past Perfect, Would have + PP) é o único usado para o passado irreal." },
                        { text: "Zero Conditional.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence (First Conditional): 'If he ___ (arrive) late, we will start without him.'", answer: "arrives", rationale: "O Simple Present na 3ª pessoa exige '-s' na condição." }
                ],
            },
            'Mixed Conditionals': {
                module_tag: 'SENIOR 2',
                description: "Practice combining past conditions (Past Perfect) with present results (Would + verb) and vice-versa (Type 3-2 and 2-3).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which structure of Mixed Conditional expresses a **past cause** with a **present result**?", options: [
                        { text: "If + Simple Past, Would have + PP.", isCorrect: false },
                        { text: "If + Past Perfect, Would + base verb (Type 3-2).", isCorrect: true, rationale: "A condição (Past Perfect) é do Tipo 3 (passado), e o resultado (Would + base verb) é do Tipo 2 (presente)." },
                        { text: "If + Simple Present, Would + base verb.", isCorrect: false },
                        { text: "If + Past Continuous, Will + verb.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence (Type 3-2): 'If I had checked the map, I ___ (would/not/be) lost now.'", answer: "wouldn't be", rationale: "O resultado presente (Tipo 2) exige 'would' + base verb ('be') + negação." }
                ],
            },
            'Future in the Past (would + verb / was going to)': {
                module_tag: 'SENIOR 2',
                description: "Formule frases descrevendo o que era futuro a partir de um ponto de vista no passado ('would' para previsão, 'was going to' para intenção não realizada).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which form is used to express a **decision or prediction** made from a **past point of view** (e.g., 'He said he ___ call me')?", options: [
                        { text: "will", isCorrect: false },
                        { text: "was going to", isCorrect: false },
                        { text: "would", isCorrect: true, rationale: "'Would' é usado como o Reported Speech (passado) de 'will'. Ele expressa algo que era futuro do ponto de vista do passado." },
                        { text: "had to", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence: 'She said she ___ (call) me later.'", answer: "would call", rationale: "O 'will' torna-se 'would call' no Reported Speech (Future in the Past)." }
                ],
            },
            'Be allowed to / Be supposed to': {
                module_tag: 'SENIOR 2',
                description: "Diferencie 'Be allowed to' (permissão/proibição) de 'Be supposed to' (expectativa/dever/rumor).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "Which modal is used to express an **expectation, duty, or general rumor/belief** (e.g., 'We ___ be quiet in the library')?", options: [
                        { text: "be allowed to", isCorrect: false },
                        { text: "be supposed to", isCorrect: true, rationale: "'Be supposed to' refere-se a deveres, expectativas ou arranjos que são esperados ou exigidos (de forma mais suave que 'must')." },
                        { text: "must", isCorrect: false },
                        { text: "can", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the sentence: 'She ___ allowed to enter the restricted area.'", answer: "is", rationale: "O sujeito 'She' exige 'is' no presente." }
                ],
            },
            'Cleft Sentences': {
                module_tag: 'SENIOR 2',
                description: "Use 'It-cleft' e 'Wh-cleft' ('What I need is...') para dar ênfase a uma parte específica da frase (sujeito, objeto, tempo, etc.).",
                videoUrl: "https://www.youtube.com/watch?v=kYv9qQj8F3o",
                questions: [
                    // MC 1
                    { q: "What is the main purpose of a Cleft Sentence (e.g., 'It was John that called me')?", options: [
                        { text: "To reduce the size of the sentence.", isCorrect: false },
                        { text: "To focus or give **emphasis** to a specific piece of information in the sentence (the 'Focus').", isCorrect: true, rationale: "Cleft Sentences (frases clivadas) são usadas para reorganizar a informação e destacar uma parte específica (sujeito, objeto, tempo, lugar)." },
                        { text: "To express regret in the past.", isCorrect: false },
                        { text: "To connect complex sentences.", isCorrect: false }
                    ] },
                    // TBA 1
                    { q: "Complete the Cleft Sentence to emphasize the object: 'It was the email ___ I sent yesterday.'", answer: "that", rationale: "O pronome relativo 'that' é usado para coisas neste tipo de Cleft Sentence." }
                ],
            },
        };

        // --- DOM ELEMENTS ---
        const dashboardView = document.getElementById('dashboard-view');
        const generatorView = document.getElementById('generator-view');
        const studyView = document.getElementById('study-view'); 
        const cardsContainer = document.getElementById('level-cards-container');
        const filterContainer = document.getElementById('filter-container');
        const currentLevelDisplay = document.getElementById('current-level-display');
        const mainQuestion = document.getElementById('main-question');
        const optionsContainer = document.getElementById('options-container');
        const rationaleDisplay = document.getElementById('rationale-display');
        const rationaleContent = document.getElementById('rationale-content');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const feedbackAlert = document.getElementById('feedback-alert');
        const questionLabel = document.getElementById('question-label');
        const backButtonText = document.getElementById('back-button-text');
        const nextButtonText = document.getElementById('next-button-text');
        const studyModuleDisplay = document.getElementById('study-module-display');
        
        // Login Elements
        const loginGate = document.getElementById('login-gate');
        const passwordInput = document.getElementById('password-input');
        const loginFeedback = document.getElementById('login-feedback');
        
        // --- DATA PREPROCESSING ---
        
        // 1. Group modules by tag
        const modulesByTag = {};
        Object.keys(grammarData).forEach(key => {
            const module = { name: key, ...grammarData[key] };
            const tag = module.module_tag;
            if (!modulesByTag[tag]) {
                modulesByTag[tag] = [];
            }
            modulesByTag[tag].push(module);
        });

        // 2. Sort tags by LEVEL_ORDER and assign continuous module numbers
        let continuousModuleNumber = 1;
        const sortedModules = [];
        const uniqueTags = ['ALL'];
        
        LEVEL_ORDER.forEach(tag => {
            if (modulesByTag[tag]) {
                if (!uniqueTags.includes(tag)) {
                    uniqueTags.push(tag);
                }
                // Important: Modules must be added in the order they appear in the data array
                modulesByTag[tag].forEach((module) => {
                    module.moduleNumber = continuousModuleNumber++;
                    sortedModules.push(module);
                });
            }
        });
        
        // --- LOGIN FUNCTION ---

        window.checkPassword = function(event) {
            event.preventDefault();
            const password = passwordInput.value.toLowerCase().trim();

            if (LEVEL_PASSWORDS.hasOwnProperty(password)) {
                currentUserMaxLevelIndex = LEVEL_PASSWORDS[password];
                
                // IMPORTANT FIX: Use display: none on the gate to remove it from document flow
                loginGate.style.display = 'none'; 
                document.getElementById('main-wrapper').classList.remove('hidden');
                loginFeedback.classList.add('hidden');
                renderFilterButtons(); // NEW: Render filters first
                renderLevelCards(); // Render cards based on default filter
            } else {
                loginFeedback.textContent = "Senha incorreta. Tente novamente!";
                loginFeedback.classList.remove('hidden');
                passwordInput.value = '';
            }
        }

        // --- NAVIGATION AND GAME STATE FUNCTIONS ---

        /**
         * Displays a temporary feedback message.
         */
        function alertMessage(message, type) {
            feedbackAlert.textContent = message;
            feedbackAlert.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            
            if (type === 'success') {
                feedbackAlert.classList.add('bg-green-500');
            } else if (type === 'error') {
                feedbackAlert.classList.add('bg-red-500');
            } else {
                 feedbackAlert.classList.add('bg-blue-500');
            }
            
            setTimeout(() => {
                feedbackAlert.classList.add('hidden');
            }, 3000);
        }

        function showDashboard() {
            dashboardView.classList.remove('hidden');
            generatorView.classList.add('hidden');
            studyView.classList.add('hidden'); // NEW: Hide study view
            currentModule = null;
            questionsPool = []; 
            // Reset language back to Portuguese default texts
            questionLabel.textContent = "PERGUNTA ATUAL:";
            backButtonText.textContent = "Voltar para Módulos";
            nextButtonText.textContent = "Gerar Próxima Pergunta";
            renderLevelCards(); // Re-render cards in case of a filter change before exit
        }

        // --- SEARCH FUNCTIONALITY ---
        window.handleSearch = function(value) {
            currentSearchTerm = value.toLowerCase().trim();
            renderLevelCards();
        }

        window.openQuestionGenerator = function(moduleName) {
            currentModule = moduleName;
            const moduleData = grammarData[moduleName];
            const moduleObj = sortedModules.find(m => m.name === moduleName);
            
            // Check for English mode (JUNIOR 1 and above)
            const moduleTag = moduleObj.module_tag;
            const isEnglishMode = LEVEL_ORDER.indexOf(moduleTag) >= LEVEL_ORDER.indexOf('JUNIOR 1');
            
            if (isEnglishMode) {
                 questionLabel.textContent = "CURRENT QUESTION:";
                 backButtonText.textContent = "Back to Modules";
                 nextButtonText.textContent = "Generate Next Question";
            } else {
                 questionLabel.textContent = "PERGUNTA ATUAL:";
                 backButtonText.textContent = "Voltar para Módulos";
                 nextButtonText.textContent = "Gerar Próxima Pergunta";
            }
            
            // Display module name with continuous number
            const moduleInfo = moduleObj ? `${moduleName} (${moduleObj.module_tag} - Módulo ${moduleObj.moduleNumber})` : moduleName;
            currentLevelDisplay.textContent = moduleInfo;

            dashboardView.classList.add('hidden');
            studyView.classList.add('hidden'); // Hide study view
            generatorView.classList.remove('hidden');
            
            // Reset game state upon entry
            // Initialize question pool with ALL module questions
            questionsPool = [...moduleData.questions];
            
            // Hide feedback and reset state
            rationaleDisplay.classList.add('hidden');
            answerSubmitted = false;
            
            loadNextQuestion();
        }

        window.openStudyView = function(moduleName) {
            currentModule = moduleName;
            const moduleObj = sortedModules.find(m => m.name === moduleName);
            const moduleInfo = moduleObj ? `${moduleName} (${moduleObj.module_tag} - Módulo ${moduleObj.moduleNumber})` : moduleName;
            const moduleData = grammarData[moduleName]; // Get data to access video URL
            const videoPlayerContainer = document.getElementById('video-player');

            studyModuleDisplay.textContent = moduleInfo;

            dashboardView.classList.add('hidden');
            generatorView.classList.add('hidden');
            studyView.classList.remove('hidden');
            
            const url = moduleData.videoUrl || ""; 
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|\?v=|v\/)|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/|music\.youtube\.com\/watch\?v=)([^&?#]+)/;
            const mp4Regex = /\.(mp4|webm|ogg)$/i;
            
            let contentHTML = '';

            const youtubeMatch = url.match(youtubeRegex);
            const mp4Match = url.match(mp4Regex);

            if (youtubeMatch && youtubeMatch[1]) {
                const videoId = youtubeMatch[1];
                // Use modestbranding=1 to hide YouTube logo and allow autoplay/full screen
                const embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`; 
                contentHTML = `<iframe src="${embedUrl}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
            } else if (mp4Match) {
                // Handle direct video files (like Cloudinary MP4)
                contentHTML = `
                    <video controls preload="auto" style="width: 100%; height: 100%; border-radius: 0.75rem;">
                        <source src="${url}" type="video/${mp4Match[1].toLowerCase()}">
                        Seu navegador não suporta o elemento de vídeo HTML5.
                    </video>
                `;
            } else {
                // Invalid or unsupported URL
                contentHTML = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #292524; color: white; border-radius: 0.75rem; text-align: center; padding: 2rem;">
                        Erro: Link de vídeo inválido ou formato não suportado (apenas YouTube ou MP4/WebM direto).
                    </div>
                `;
            }
            
            videoPlayerContainer.innerHTML = contentHTML;
        }


        // --- QUIZ GAME FUNCTIONS (PRACTICE) ---

        /**
         * Loads the next question (or the first one).
         */
        window.loadNextQuestion = function() {
            if (!currentModule) {
                return;
            }

            // If the pool runs out, reset
            if (questionsPool.length === 0) {
                 questionsPool = [...grammarData[currentModule].questions];
                 alertMessage(`O pool de perguntas foi resetado.`, 'info');
            }
            
            const randomIndex = Math.floor(Math.random() * questionsPool.length);
            currentQuestion = questionsPool[randomIndex];
            // Remove question from pool to prevent repetition in this round
            questionsPool.splice(randomIndex, 1); 

            // Update interface
            let formattedQuestion = currentQuestion.q;
            formattedQuestion = formattedQuestion.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            mainQuestion.innerHTML = formattedQuestion;
            
            renderOptions();
            
            // Hide feedback and reset state
            rationaleDisplay.classList.add('hidden');
            nextQuestionBtn.disabled = true;
            answerSubmitted = false;
        }
        
        /**
         * Renders the options based on question type (MC or TBA).
         */
        function renderOptions() {
            optionsContainer.innerHTML = '';
            
            if (currentQuestion.options) {
                // RENDER MC OPTIONS
                currentQuestion.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.setAttribute('data-index', index);
                    button.onclick = () => submitMCAnswer(index);
                    
                    let formattedText = option.text;
                    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 

                    button.innerHTML = `
                        <span class="option-prefix">${optionPrefixes[index]}</span>
                        <span class="text-base">${formattedText}</span>
                    `;
                    optionsContainer.appendChild(button);
                });
            } else if (currentQuestion.answer) {
                 // RENDER TBA INPUT
                optionsContainer.innerHTML = `
                    <div id="tba-input-container">
                        <input type="text" id="tba-answer-input" class="login-input" placeholder="Digite sua resposta aqui...">
                        <button id="tba-submit-btn" class="action-button w-full mt-3" onclick="submitTBAAnswer()">Verificar Resposta</button>
                    </div>
                `;
            }
        }
        
        /**
         * Displays the rationale text in the dedicated area.
         */
        function displayRationale(text, isCorrect) {
            if (isCorrect) {
                 rationaleDisplay.classList.add('hidden');
            } else {
                 rationaleContent.innerHTML = `<span class="font-bold">Explicação:</span> ${text}`;
                 rationaleDisplay.classList.remove('hidden');
            }
        }
        
        /**
         * Submits the user's MC answer and provides feedback.
         */
        window.submitMCAnswer = function(selectedIndex) {
            if (answerSubmitted) return; 
            answerSubmitted = true;
            
            const selectedOption = currentQuestion.options[selectedIndex];
            let isCorrect = selectedOption.isCorrect;
            let correctOption = currentQuestion.options.find(opt => opt.isCorrect);
            let correctIndex = currentQuestion.options.findIndex(opt => opt.isCorrect);

            // Disable all buttons after submission
            document.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);

            // Highlight the correct and incorrect option
            document.querySelectorAll('.option-button').forEach((btn, index) => {
                btn.classList.remove('border-gray-200');
                if (index === correctIndex) {
                    btn.classList.add('bg-green-100', 'border-green-500'); // Correct (Green)
                } else if (index === selectedIndex) {
                    btn.classList.add('bg-red-100', 'border-red-500'); // Incorrect chosen (Red)
                } else {
                    btn.classList.add('bg-white', 'border-gray-300');
                }
            });

            // Feedback and Rationale Logic
            if (isCorrect) {
                alertMessage(`Correto! 🎉`, 'success');
                displayRationale(null, true);
            } else {
                alertMessage(`Incorreto. Veja a explicação abaixo.`, 'error');
                const rationaleText = correctOption.rationale || 'Nenhuma explicação disponível.';
                displayRationale(rationaleText, false);
            }
            
            // Enable Next Question Button
            nextQuestionBtn.disabled = false;
        }

        /**
         * Submits the user's TBA answer and provides feedback.
         */
        window.submitTBAAnswer = function() {
            if (answerSubmitted) return; 
            answerSubmitted = true;

            const inputElement = document.getElementById('tba-answer-input');
            const submitButton = document.getElementById('tba-submit-btn');

            const userAnswer = inputElement.value.toLowerCase().trim();
            const correctAnswer = currentQuestion.answer.toLowerCase().trim();
            
            // Simple check: user answer must match the correct answer exactly (case-insensitive, trim)
            const isCorrect = (userAnswer === correctAnswer);

            // Disable input
            inputElement.disabled = true;
            
            // CORRECTION: Hide the submit button completely after submission
            submitButton.style.display = 'none';

            // Highlight input based on result
            inputElement.classList.remove('border-indigo-500');
            if (isCorrect) {
                inputElement.classList.add('bg-green-100', 'border-green-500');
                alertMessage(`Correto! 🎉`, 'success');
                displayRationale(null, true);
            } else {
                inputElement.classList.add('bg-red-100', 'border-red-500');
                inputElement.value = `Resposta Correta: ${currentQuestion.answer}`; // Show correct answer
                alertMessage(`Incorreto. Veja a explicação abaixo.`, 'error');
                const rationaleText = currentQuestion.rationale || 'Nenhuma explicação disponível.';
                displayRationale(rationaleText, false);
            }

            // Enable Next Question Button (BUG FIX: Ensure button is enabled after checking answer)
            nextQuestionBtn.disabled = false;
        }


        // --- DASHBOARD FUNCTIONS (FILTERING AND RENDERING) ---
        
        /**
         * Filters the module cards based on the selected tag.
         */
        window.filterModules = function(tag) {
            currentFilter = tag;
            
            // Update button styles
            document.querySelectorAll('.filter-button').forEach(btn => {
                // Remove active class from all
                btn.classList.remove('active');
                
                // Add active class if it matches
                if (btn.getAttribute('data-tag') === tag) {
                    btn.classList.add('active');
                }
            });
            
            renderLevelCards();
        }

        function renderFilterButtons() {
             filterContainer.innerHTML = '';

             // Use the fixed LEVEL_ORDER for tags, plus 'ALL'
             const tags = ['ALL', ...LEVEL_ORDER.filter(tag => modulesByTag[tag] && modulesByTag[tag].length > 0)];

             tags.forEach(tag => {
                 const button = document.createElement('button');
                 
                 // Determine if this specific level button is locked
                 let isLocked = false;
                 if (tag !== 'ALL') {
                     const levelIndex = LEVEL_ORDER.indexOf(tag);
                     if (levelIndex > currentUserMaxLevelIndex) {
                         isLocked = true;
                     }
                 }

                 button.className = `filter-button ${tag === currentFilter ? 'active' : ''} ${isLocked ? 'opacity-60 grayscale' : ''}`;
                 button.setAttribute('data-tag', tag);
                 
                 // Add Lock Icon if locked
                 const lockIcon = isLocked 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1.5 mb-0.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` 
                    : '';

                 // Set innerHTML to include icon
                 button.innerHTML = `${lockIcon}${tag === 'ALL' ? 'Todos os Níveis' : tag}`;
                 
                 button.onclick = () => filterModules(tag);
                 filterContainer.appendChild(button);
             });
        }
        
        /**
         * Renders the Module cards on the Dashboard in a grid layout.
         */
        window.renderLevelCards = function() {
            cardsContainer.innerHTML = '';
            
            const filteredModules = sortedModules.filter(data => {
                const matchesFilter = currentFilter === 'ALL' || data.module_tag === currentFilter;
                const matchesSearch = data.name.toLowerCase().includes(currentSearchTerm);
                return matchesFilter && matchesSearch;
            });

            filteredModules.forEach((data) => {
                const moduleName = data.name;
                const moduleTag = data.module_tag;
                const moduleNumber = data.moduleNumber;
                const description = data.description || "Módulo de acurácia estrutural. Pratique até dominar o conteúdo.";

                // Calculate if module is locked
                const moduleLevelIndex = LEVEL_ORDER.indexOf(moduleTag);
                const isLocked = moduleLevelIndex > currentUserMaxLevelIndex;

                const card = document.createElement('div');
                card.className = `level-card relative ${isLocked ? 'locked' : ''}`; 
                
                // Add click handler for locked cards
                if (isLocked) {
                    card.onclick = (e) => {
                        // Prevent alert if clicking on button (since buttons have their own alert)
                        if (!e.target.closest('button')) {
                            alert("Nível bloqueado! Complete os níveis anteriores ou use uma senha de acesso superior.");
                        }
                    };
                }

                // Lock icon overlay for card center (Visual Only)
                const lockOverlay = isLocked ? `
                    <div class="lock-overlay">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                ` : '';

                // Lock icon SVG for buttons
                const lockIconForButton = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 mb-0.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;

                // Define button content and action based on lock state
                const studyButtonContent = isLocked ? `${lockIconForButton} STUDY` : `STUDY`;
                const practiceButtonContent = isLocked ? `${lockIconForButton} PRACTICE` : `PRACTICE`;
                const clickAction = "alert('Nível bloqueado! Complete os níveis anteriores ou use uma senha de acesso superior.'); event.stopPropagation();";

                card.innerHTML = `
                    ${lockOverlay}
                    <div class="h-full flex flex-col justify-between pt-0">
                        <div class="pb-4">
                            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1760657894/SLAP_ICON_PRETO_2_2_tv8bmp.png" 
                                 alt="SLAP Icon" 
                                 class="absolute top-4 right-4 w-8 h-8 pointer-events-none"
                                 onerror="this.style.display='none';" />
                            
                            <span class="module-tag">${moduleTag} - MÓDULO ${moduleNumber}</span>
                            <h3 class="text-xl font-bold text-stone-800 mb-1 mt-2">${moduleName}</h3>
                            <p class="text-stone-600 text-sm italic mb-4">
                                ${description}
                            </p>
                        </div>
                        
                        <div class="mt-4 flex flex-wrap gap-3">
                            <button class="secondary-button flex-1 text-sm flex items-center justify-center" onclick="${isLocked ? clickAction : `openStudyView('${moduleName}')`}">
                                ${studyButtonContent}
                            </button>
                            <button class="action-button flex-1 text-sm flex items-center justify-center" onclick="${isLocked ? clickAction : `openQuestionGenerator('${moduleName}')`}">
                                ${practiceButtonContent}
                            </button>
                        </div>
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
            
            if (filteredModules.length === 0) {
                 cardsContainer.innerHTML = `<p class="text-center text-lg text-stone-500 col-span-full py-10">Nenhum módulo encontrado para o nível ${currentFilter} com o termo "${currentSearchTerm}".</p>`;
            }
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // Hides main content initially
            document.getElementById('main-wrapper').classList.add('hidden');
            // Shows login gate initially
            loginGate.style.display = 'flex';
        };
    </script>
</body>
</html>
